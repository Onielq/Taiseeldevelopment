<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Taiseel Development</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a3c22;
      --accent: #c5a059;
      --bg: #fcfcfc;
      --white: #ffffff;
      --text: #333;
      --muted: #999;
      --border: #eeeeee;
      --sidebar-w: 240px;
      --danger: #c0392b;
      --success: #2e7d32;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      display: flex;
      min-height: 100vh;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: var(--primary);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0;
      z-index: 200;
      transition: transform 0.3s ease;
      overflow-y: auto;
    }
    .sidebar-brand {
      padding: 32px 28px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-brand h1 {
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--white);
    }
    .sidebar-brand span {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.4);
      letter-spacing: 2px;
    }
    .sidebar-nav { flex: 1; padding: 20px 0; }
    .nav-section-label {
      padding: 16px 28px 6px;
      font-size: 0.6rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.3);
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 28px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      text-decoration: none;
    }
    .nav-item:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .nav-item.active { color: var(--white); border-left-color: var(--accent); background: rgba(255,255,255,0.07); }
    .nav-item svg { opacity: 0.7; flex-shrink: 0; }
    .nav-item.active svg { opacity: 1; }
    .sidebar-footer {
      padding: 20px 28px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-footer a {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.72rem; font-weight: 600; letter-spacing: 1px;
      color: rgba(255,255,255,0.5); text-decoration: none;
      transition: color 0.2s;
    }
    .sidebar-footer a:hover { color: var(--white); }

    /* ── MOBILE SIDEBAR TOGGLE ── */
    .sidebar-toggle {
      display: none;
      position: fixed; top: 16px; left: 16px; z-index: 300;
      background: var(--primary); color: white;
      border: none; border-radius: 8px;
      width: 40px; height: 40px;
      cursor: pointer; align-items: center; justify-content: center;
    }
    .sidebar-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 199;
    }

    /* ── MAIN ── */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    .topbar-title { font-size: 0.85rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .page-content { padding: 40px; flex: 1; }

    /* ── BUTTONS ── */
    .btn {
      padding: 10px 20px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text);
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.25s;
      border-radius: 8px;
      text-decoration: none;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { border-color: var(--primary); color: var(--primary); }
    .btn-primary { background: var(--primary); color: var(--white); border-color: var(--primary); }
    .btn-primary:hover { background: #15311b; color: var(--white); }
    .btn-accent { background: var(--accent); color: var(--white); border-color: var(--accent); }
    .btn-accent:hover { background: #b08f4a; color: var(--white); }
    .btn-danger { background: transparent; color: var(--danger); border-color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.65rem; letter-spacing: 1px; }
    .btn-icon { padding: 8px; border-radius: 8px; }

    /* ── VIEWS (pages) ── */
    .view { display: none; }
    .view.active { display: block; }

    /* ── STATS GRID ── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 36px;
    }
    .stat-card {
      background: var(--white);
      padding: 28px 32px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      transition: transform 0.25s, box-shadow 0.25s;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.07); }
    .stat-card::before {
      content: ''; position: absolute; top: 0; left: 0;
      width: 3px; height: 100%; background: var(--accent);
    }
    .stat-card.danger::before { background: var(--danger); }
    .stat-card.success::before { background: var(--success); }
    .stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 2.2rem; font-weight: 300; color: var(--primary); }
    .stat-delta { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
    .stat-delta.neg { color: var(--danger); }

    /* ── SECTION CARD ── */
    .section-card {
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      margin-bottom: 28px;
      overflow: hidden;
    }
    .section-header {
      padding: 22px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .section-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--primary);
    }
    .section-header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* ── TABLE ── */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; text-align: left; }
    th {
      background: #f9f9f9;
      padding: 14px 24px;
      font-size: 0.67rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    td {
      padding: 16px 24px;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
      color: #555;
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .timestamp { font-size: 0.72rem; color: var(--muted); }

    /* ── BADGES ── */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .badge-green { background: #e9f5ed; color: var(--success); }
    .badge-gold { background: #fef9ec; color: #b08f4a; }
    .badge-blue { background: #e8f4fd; color: #1565c0; }
    .badge-gray { background: #f3f3f3; color: #777; }
    .badge-red { background: #fdecea; color: var(--danger); }
    .badge-purple { background: #f3e8fd; color: #6a1b9a; }
    .priority-high { color: var(--danger); font-weight: 700; font-size: 0.7rem; }
    .priority-med { color: var(--warn); font-weight: 700; font-size: 0.7rem; }
    .priority-low { color: var(--success); font-weight: 700; font-size: 0.7rem; }

    /* ── FORMS ── */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      padding: 24px 32px;
      background: #fafafa;
      border-bottom: 1px solid var(--border);
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label {
      font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; color: var(--muted);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.82rem;
      background: var(--white);
      color: var(--text);
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-actions { padding: 16px 32px 24px; display: flex; gap: 10px; flex-wrap: wrap; }

    /* ── MODAL ── */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 500;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: var(--white);
      border-radius: 20px;
      width: 90%; max-width: 760px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: 0 24px 80px rgba(0,0,0,0.25);
      animation: modalIn 0.25s ease;
    }
    @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-head {
      padding: 28px 36px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--white); z-index: 1;
    }
    .modal-head h2 { font-size: 1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
    .modal-close { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 22px; line-height: 1; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
    .modal-close:hover { background: var(--border); color: var(--text); }
    .modal-body { padding: 32px 36px; }
    .modal-body .form-grid { padding: 0; background: none; border: none; }
    .modal-footer { padding: 20px 36px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

    /* ── LOADER ── */
    .loader-row {
      padding: 48px;
      text-align: center;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 0.72rem;
    }
    .spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── SEARCH BAR ── */
    .search-bar {
      position: relative; display: flex; align-items: center;
    }
    .search-bar input {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px 8px 34px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.78rem;
      width: 200px;
      transition: border-color 0.2s, width 0.3s;
    }
    .search-bar input:focus { outline: none; border-color: var(--primary); width: 260px; }
    .search-bar svg { position: absolute; left: 10px; pointer-events: none; }

    /* ── PORTAL CARDS ── */
    .portal-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 24px 32px;
    }
    .portal-info-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      background: var(--white);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .portal-info-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.06); transform: translateY(-2px); }
    .portal-info-card h3 { font-size: 0.78rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; color: var(--primary); }
    .portal-info-card p { color: #777; font-size: 0.78rem; margin-bottom: 10px; line-height: 1.5; }
    .portal-info-card ul { margin-left: 14px; color: #666; font-size: 0.75rem; }
    .portal-info-card li { margin-bottom: 4px; }

    /* ── INLINE EDIT FORM ── */
    .inline-edit { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .inline-edit input, .inline-edit select {
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 8px; font: inherit; font-size: 0.75rem;
      width: auto;
    }

    /* ── TOAST ── */
    #toast {
      position: fixed; bottom: 32px; right: 32px;
      background: var(--primary); color: white;
      padding: 14px 22px; border-radius: 10px;
      font-size: 0.78rem; font-weight: 600; letter-spacing: 1px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      transform: translateY(80px); opacity: 0;
      transition: all 0.3s ease; z-index: 999;
      max-width: 320px;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.error { background: var(--danger); }

    /* ── EMPTY STATE ── */
    .empty-state { padding: 48px; text-align: center; color: var(--muted); font-size: 0.82rem; }
    .empty-state svg { margin-bottom: 12px; opacity: 0.3; }

    /* ── TABS ── */
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); padding: 0 32px; }
    .tab-btn {
      padding: 14px 20px;
      font-size: 0.72rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
      background: none; border: none; cursor: pointer; color: var(--muted);
      border-bottom: 2px solid transparent; margin-bottom: -1px;
      transition: all 0.2s;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-btn:hover:not(.active) { color: var(--text); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ── CONFIRM POPUP ── */
    .confirm-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.4); z-index: 600;
      align-items: center; justify-content: center;
    }
    .confirm-overlay.active { display: flex; }
    .confirm-box {
      background: var(--white); border-radius: 16px;
      padding: 36px; max-width: 380px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      text-align: center; animation: modalIn 0.2s ease;
    }
    .confirm-box h3 { font-size: 1rem; font-weight: 700; margin-bottom: 10px; color: var(--text); }
    .confirm-box p { color: var(--muted); font-size: 0.82rem; margin-bottom: 24px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }

    /* ── DETAIL POPUP ── */
    .detail-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 500;
      align-items: center; justify-content: center;
    }
    .detail-overlay.active { display: flex; }
    .detail-box {
      background: var(--white);
      border-radius: 20px;
      width: 90%; max-width: 600px;
      max-height: 85vh; overflow-y: auto;
      box-shadow: 0 24px 80px rgba(0,0,0,0.25);
      animation: modalIn 0.25s ease;
    }

    /* ── PROGRESS BAR ── */
    .progress-wrap { background: #f0f0f0; border-radius: 4px; height: 6px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 4px; background: var(--accent); transition: width 0.4s ease; }
    .progress-bar.success { background: var(--success); }
    .progress-bar.danger { background: var(--danger); }

    /* ── KPI ROW ── */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1px;
      background: var(--border);
      border-top: 1px solid var(--border);
    }
    .kpi-cell {
      background: var(--white);
      padding: 20px 24px;
    }
    .kpi-cell .kpi-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 4px; display: block; }
    .kpi-cell .kpi-val { font-size: 1.3rem; font-weight: 300; color: var(--primary); }
    .kpi-cell .kpi-sub { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }

    /* ── AI COPILOT ── */
    .ai-chat-wrap {
      padding: 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 300px;
    }
    .ai-messages { display: flex; flex-direction: column; gap: 12px; min-height: 200px; }
    .ai-msg {
      max-width: 75%;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 0.82rem;
      line-height: 1.6;
    }
    .ai-msg.user {
      align-self: flex-end;
      background: var(--primary);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }
    .ai-msg.ai {
      align-self: flex-start;
      background: #f4f4f4;
      color: var(--text);
      border-bottom-left-radius: 4px;
    }
    .ai-input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .ai-input-row input {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.82rem;
    }
    .ai-input-row input:focus { outline: none; border-color: var(--primary); }
    .ai-quick-prompts {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .quick-prompt {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      background: var(--white);
      color: var(--text);
      transition: all 0.2s;
    }
    .quick-prompt:hover { border-color: var(--accent); color: var(--accent); }

    /* ── FORECAST BARS ── */
    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1px;
      background: var(--border);
      padding: 24px 32px;
      gap: 16px;
    }
    .forecast-col { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .forecast-bar-wrap {
      width: 40px;
      height: 120px;
      background: #f0f0f0;
      border-radius: 6px;
      display: flex;
      align-items: flex-end;
      overflow: hidden;
    }
    .forecast-bar-fill { width: 100%; border-radius: 6px 6px 0 0; transition: height 0.6s ease; }
    .forecast-col .f-label { font-size: 0.62rem; color: var(--muted); text-align: center; letter-spacing: 1px; }
    .forecast-col .f-val { font-size: 0.72rem; font-weight: 700; color: var(--primary); }

    /* ── APPROVAL CARD ── */
    .approval-card {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      transition: background 0.2s;
    }
    .approval-card:hover { background: #fafafa; }
    .approval-card:last-child { border-bottom: none; }
    .approval-meta { flex: 1; min-width: 200px; }
    .approval-meta h4 { font-size: 0.82rem; font-weight: 700; color: var(--text); margin-bottom: 2px; }
    .approval-meta p { font-size: 0.72rem; color: var(--muted); }
    .approval-amount { font-size: 1.1rem; font-weight: 300; color: var(--primary); white-space: nowrap; }
    .approval-actions { display: flex; gap: 8px; }

    /* ── AUDIT LOG ── */
    .audit-row {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 32px;
      border-bottom: 1px solid var(--border);
    }
    .audit-row:last-child { border-bottom: none; }
    .audit-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent); flex-shrink: 0; margin-top: 6px;
    }
    .audit-dot.create { background: var(--success); }
    .audit-dot.delete { background: var(--danger); }
    .audit-dot.edit { background: #1565c0; }
    .audit-dot.approve { background: #6a1b9a; }
    .audit-content { flex: 1; }
    .audit-content .audit-action { font-size: 0.82rem; color: var(--text); font-weight: 600; }
    .audit-content .audit-detail { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .audit-time { font-size: 0.68rem; color: var(--muted); white-space: nowrap; }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.open { display: block; }
      .sidebar-toggle { display: flex; }
      .main { margin-left: 0; }
      .topbar { padding: 0 20px 0 60px; }
      .page-content { padding: 24px 20px; }
      .section-header { padding: 18px 20px; }
      th, td { padding: 12px 16px; }
      .form-grid { padding: 18px 20px; }
      .form-actions { padding: 12px 20px 18px; }
      .portal-overview { padding: 18px 20px; }
      .tabs { padding: 0 20px; }
      .modal-body { padding: 24px; }
      .modal-head, .modal-footer { padding: 20px 24px; }
    }
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .topbar-title { display: none; }
    }
    /* ── PIPELINE BOARD ── */
    .pipeline-board { display:flex; gap:14px; padding:20px 28px; overflow-x:auto; }
    .pipeline-col { flex:0 0 200px; background:#f8f9f8; border-radius:12px; padding:14px; }
    [data-theme="dark"] .pipeline-col { background:rgba(255,255,255,0.03); }
    .pipeline-col-head { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .pipeline-col-head span { background:var(--border); border-radius:10px; padding:1px 8px; font-size:0.6rem; color:var(--muted); }
    .pipeline-card { background:var(--white); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:8px; cursor:pointer; transition:box-shadow 0.2s,transform 0.15s; }
    .pipeline-card:hover { box-shadow:0 4px 16px rgba(0,0,0,0.08); transform:translateY(-1px); }
    .pipeline-card-name { font-size:0.78rem; font-weight:600; color:var(--text); margin-bottom:3px; }
    .pipeline-card-sub { font-size:0.66rem; color:var(--muted); }
    /* ── ROI CALCULATOR ── */
    .roi-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    .roi-result { background:#f8faf8; border:1px solid var(--border); border-radius:12px; padding:20px; }
    .roi-result-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:0.8rem; }
    .roi-result-row:last-child { border-bottom:none; font-weight:700; color:var(--primary); font-size:0.9rem; }
    .roi-result-label { color:var(--muted); font-size:0.72rem; text-transform:uppercase; letter-spacing:1px; }
    /* ── NOTES LOG ── */
    .notes-log { padding:20px 28px; display:flex; flex-direction:column; gap:10px; }
    .note-entry { background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:14px 16px; }
    [data-theme="dark"] .note-entry { background:rgba(255,255,255,0.03); }
    .note-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .note-author { font-size:0.65rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--primary); }
    .note-time { font-size:0.62rem; color:var(--muted); }
    .note-text { font-size:0.8rem; color:var(--text); line-height:1.5; }
    .note-input-row { display:flex; gap:10px; }
    .note-input-row textarea { flex:1; border:1px solid var(--border); border-radius:8px; padding:10px; font-family:'Montserrat',sans-serif; font-size:0.8rem; min-height:64px; background:var(--white); color:var(--text); resize:none; }
    .note-input-row textarea:focus { outline:none; border-color:var(--primary); }
    /* ── FUNNEL ── */
    .funnel-wrap { padding:20px 28px; }
    .funnel-stage { display:flex; align-items:center; margin-bottom:10px; gap:14px; }
    .funnel-bar-wrap { flex:1; background:#f3f3f3; border-radius:4px; height:28px; overflow:hidden; }
    .funnel-bar { height:100%; background:var(--primary); border-radius:4px; transition:width 0.6s ease; display:flex; align-items:center; padding:0 10px; }
    .funnel-bar span { font-size:0.65rem; font-weight:700; color:#fff; white-space:nowrap; }
    .funnel-label { font-size:0.68rem; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--text); width:100px; flex-shrink:0; }
    .funnel-count { font-size:0.72rem; color:var(--muted); width:36px; text-align:right; }
    @media (max-width:900px) { .roi-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>

<!-- Sidebar Toggle (mobile) -->
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Menu">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h1>Taiseel</h1>
    <span>Management Portal</span>
  </div>
  <nav class="sidebar-nav">

    <div class="nav-section-label">Overview</div>
    <a class="nav-item active" onclick="showView('overview')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>

    <div class="nav-section-label">Portals</div>
    <a class="nav-item" onclick="showView('admin-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg>
      Admin Portal
    </a>
    <a class="nav-item" onclick="showView('homes-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>
      Individual Homes
    </a>
    <a class="nav-item" onclick="showView('apartments-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h2v2H9zm4 0h2v2h-2zm-4 4h2v2H9zm4 0h2v2h-2z"/></svg>
      Apartments
    </a>
    <a class="nav-item" onclick="showView('leads-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Leads
    </a>
    <a class="nav-item" onclick="showView('operations-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
      Operations
    </a>

    <div class="nav-section-label">Finance</div>
    <a class="nav-item" onclick="showView('finance-hub')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Finance Hub
    </a>
    <a class="nav-item" onclick="showView('ar-collections')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
      AR & Collections
    </a>
    <a class="nav-item" onclick="showView('approval-matrix')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Approval Matrix
    </a>
    <a class="nav-item" onclick="showView('audit-log')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Audit Log
    </a>

    <div class="nav-section-label">Intelligence</div>
    <a class="nav-item" onclick="showView('lease-intelligence')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Lease Intelligence
    </a>
    <a class="nav-item" onclick="showView('vendor-control')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
      Vendor Control
    </a>
    <a class="nav-item" onclick="showView('tenant-360')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 012-2h6a2 2 0 012 2v1.662"/></svg>
      Tenant 360
    </a>
    <a class="nav-item" onclick="showView('ai-copilot')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 110 20A10 10 0 0112 2z"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      AI Copilot
    </a>

    <div class="nav-section-label">Data</div>
    <a class="nav-item" onclick="showView('tenants-view')" href="#" data-view="tenants-view">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Tenants
    </a>
    <a class="nav-item" onclick="showView('properties-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Properties
    </a>
    <a class="nav-item" onclick="showView('units-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
      Building Units
    </a>
    <a class="nav-item" onclick="showView('registrations-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Registrations
    </a>

    <div class="nav-section-label">Tools</div>
    <a class="nav-item" onclick="showView('roi-view')" href="#" data-view="roi-view">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      ROI Calculator
    </a>
    <a class="nav-item" onclick="showView('notes-view')" href="#" data-view="notes-view">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Notes Log
    </a>
    <a class="nav-item" onclick="showView('vacancy-view')" href="#" data-view="vacancy-view">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Vacancy Pipeline
    </a>

  </nav>
  <div class="sidebar-footer">
    <a href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      View Public Site
    </a>
  </div>
</aside>

<!-- Main Content -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <span class="topbar-title" id="topbarTitle">Dashboard</span>
    </div>
    <div class="topbar-right">
      <button onclick="refreshAll()" class="btn btn-sm">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
        Refresh All
      </button>
    </div>
  </header>

  <div class="page-content">

    <!-- ════ DASHBOARD ════ -->
    <div class="view active" id="view-overview">
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Total Leads</span>
          <div class="stat-value" id="totalLeads">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Total Properties</span>
          <div class="stat-value" id="totalProperties">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Total Units</span>
          <div class="stat-value" id="totalUnits">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Portfolio Value</span>
          <div class="stat-value" id="portfolioValue">—</div>
        </div>
        <div class="stat-card success">
          <span class="stat-label">Monthly Collections</span>
          <div class="stat-value">$124K</div>
          <div class="stat-delta">↑ 8% vs last month</div>
        </div>
        <div class="stat-card danger">
          <span class="stat-label">Overdue Invoices</span>
          <div class="stat-value">7</div>
          <div class="stat-delta neg">3 high-risk tenants</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Pending Approvals</span>
          <div class="stat-value" id="pendingApprovalsCount">4</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Net Operating Income</span>
          <div class="stat-value">$89K</div>
          <div class="stat-delta">↑ 4.2% this quarter</div>
        </div>
      </div>

      <!-- Portal Overview Cards -->
      <div class="section-card">
        <div class="section-header"><h2>Property Management Portals</h2></div>
        <div class="portal-overview">
          <div class="portal-info-card">
            <h3>1. Admin Portal</h3>
            <p>Portfolio command center.</p>
            <ul><li>Portfolio-level reports</li><li>Workflow management</li><li>Cross-portal monitoring</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>2. Individual Homes</h3>
            <p>Single-home operations and resident lifecycle.</p>
            <ul><li>Lease/rent or sold status</li><li>Create property listing</li><li>Maintenance and notices</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>3. Apartment Portal</h3>
            <p>Multi-unit inventory and occupancy operations.</p>
            <ul><li>Create unit with address/type/price/rent</li><li>Vacant/listed/occupied status</li><li>Announcements and turnover</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>4. Leads Portal</h3>
            <p>Track source, qualification, and timelines.</p>
            <ul><li>Lead source + qualification details</li><li>Preferences and priorities</li><li>Follow-up pipeline</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>5. Operations Portal</h3>
            <p>Service execution and preventive management.</p>
            <ul><li>Work order assignment</li><li>Service-level tracking</li><li>Preventive maintenance logs</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>6. Finance Hub</h3>
            <p>CFO-level financial control layer.</p>
            <ul><li>P&L by property</li><li>Cash-flow forecast</li><li>Budget vs actual</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>7. AR & Collections</h3>
            <p>Rent invoicing and payment tracking.</p>
            <ul><li>Auto-invoicing</li><li>Dunning reminders</li><li>Bank reconciliation</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>8. Lease Intelligence</h3>
            <p>Proactive lease and vacancy management.</p>
            <ul><li>Escalation automation</li><li>Renewal risk scoring</li><li>Vacancy early warning</li></ul>
          </div>
        </div>
      </div>

      <!-- Quick Activity Summary -->
      <div class="section-card">
        <div class="section-header"><h2>Recent Activity</h2></div>
        <div id="recentActivityList" class="loader-row"><span class="spinner"></span> Loading…</div>
      </div>
    </div>

    <!-- ════ ADMIN PORTAL ════ -->
    <div class="view" id="view-admin-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Admin Portal — Portfolio Reports</h2>
          <button class="btn btn-accent btn-sm" onclick="openAdminModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Report
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Portfolio-Level Report</th><th>Workflow</th><th>Cross-Portal Monitoring</th><th>Actions</th></tr></thead>
            <tbody id="adminPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ HOMES PORTAL ════ -->
    <div class="view" id="view-homes-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Individual Homes Portal</h2>
          <button class="btn btn-accent btn-sm" onclick="openHomeModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Create Listing
          </button>
        </div>
        <p style="padding:0 32px 16px;font-size:0.78rem;color:var(--muted);">Includes lease details and rent/sold status, listing creation, maintenance requests, and notices.</p>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Address</th><th>Status</th><th>Lease / Rent</th><th>Maintenance</th><th>Notice</th><th>Actions</th></tr></thead>
            <tbody id="homePortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ APARTMENTS PORTAL ════ -->
    <div class="view" id="view-apartments-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Apartment Portal</h2>
          <button class="btn btn-accent btn-sm" onclick="openUnitModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Unit
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Unit / Address / Type</th><th>Price</th><th>Rent</th><th>Status</th><th>Announcement</th><th>Turnover</th><th>Actions</th></tr></thead>
            <tbody id="apartmentPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ LEADS PORTAL ════ -->
    <div class="view" id="view-leads-portal">
      <!-- Pipeline Board -->
      <div class="section-card">
        <div class="section-header">
          <h2>Lead Pipeline</h2>
          <div class="section-header-actions">
            <button class="btn btn-sm" onclick="toggleLeadsView()">Toggle View</button>
            <button class="btn btn-accent btn-sm" onclick="openLeadModal()">+ Add Lead</button>
          </div>
        </div>
        <div id="leadsPipelineBoard" class="pipeline-board"></div>
      </div>
      <!-- Leads Table -->
      <div class="section-card" id="leadsTableCard">
        <div class="section-header">
          <h2>All Leads</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="leadsSearch" placeholder="Search leads…" oninput="renderLeadsPortal()">
            </div>
            <select class="filter-select" id="leadsTimelineFilter" onchange="renderLeadsPortal()">
              <option value="all">All Timelines</option>
              <option value="immediately">Immediately</option>
              <option value="in 3 months">3 Months</option>
              <option value="in 6 months">6 Months</option>
              <option value="later">Later</option>
            </select>
            <button class="btn btn-sm" onclick="exportLeadsCSV()">Export CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th onclick="sortTable('leadPortalTableBody',0,this)">Lead</th><th>Contact</th><th>Source</th><th>Timeline</th><th>Preferences</th><th>Follow-up</th><th>Actions</th></tr></thead>
            <tbody id="leadPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ OPERATIONS PORTAL ════ -->
    <div class="view" id="view-operations-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Maintenance &amp; Work Orders</h2>
          <div class="section-header-actions">
            <select class="filter-select" id="maintStatusFilter" onchange="renderOperationsPortal()">
              <option value="all">All Statuses</option>
              <option value="open">Open</option>
              <option value="in-progress">In Progress</option>
              <option value="closed">Closed</option>
            </select>
            <select class="filter-select" id="maintPriorityFilter" onchange="renderOperationsPortal()">
              <option value="all">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <button class="btn btn-accent btn-sm" onclick="openOpsModal()">+ Add Work Order</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th onclick="sortTable('operationsPortalTableBody',0,this)">Work Order</th><th>Priority</th><th>Status</th><th>Service Tracking</th><th>Maintenance Log</th><th>Cost ($)</th><th>Assigned To</th><th>Due Date</th><th>Actions</th></tr></thead>
            <tbody id="operationsPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ FINANCE HUB ════ -->
    <div class="view" id="view-finance-hub">
      <!-- CFO Stats -->
      <div class="stats-grid">
        <div class="stat-card success">
          <span class="stat-label">30-Day Cash Forecast</span>
          <div class="stat-value">$138K</div>
          <div class="stat-delta">↑ On track</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">90-Day Forecast</span>
          <div class="stat-value">$412K</div>
        </div>
        <div class="stat-card danger">
          <span class="stat-label">Outstanding Receivables</span>
          <div class="stat-value">$31K</div>
          <div class="stat-delta neg">7 overdue invoices</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Budget vs Actual</span>
          <div class="stat-value">−4.2%</div>
          <div class="stat-delta neg">Capex over by $8K</div>
        </div>
      </div>

      <!-- Cash Flow Forecast Visual -->
      <div class="section-card">
        <div class="section-header">
          <h2>Cash Flow Forecast</h2>
          <span style="font-size:0.7rem;color:var(--muted);letter-spacing:1px;">6-MONTH PROJECTION</span>
        </div>
        <div class="forecast-grid" id="cashFlowForecastGrid"></div>
      </div>

      <!-- P&L by Property -->
      <div class="section-card">
        <div class="section-header">
          <h2>Property P&L</h2>
          <button class="btn btn-accent btn-sm" onclick="openPLModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Entry
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Property</th><th>Revenue</th><th>Expenses</th><th>NOI</th><th>Occupancy</th><th>Margin</th></tr></thead>
            <tbody id="plTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Capex Tracker -->
      <div class="section-card">
        <div class="section-header">
          <h2>Capex Tracker & Reserve Planning</h2>
          <button class="btn btn-sm" onclick="openCapexModal()">Add Capex</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Item</th><th>Property</th><th>Budget</th><th>Spent</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="capexTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ AR & COLLECTIONS ════ -->
    <div class="view" id="view-ar-collections">
      <div class="stats-grid">
        <div class="stat-card success">
          <span class="stat-label">Collected This Month</span>
          <div class="stat-value">$124K</div>
          <div class="stat-delta">87% collection rate</div>
        </div>
        <div class="stat-card danger">
          <span class="stat-label">Overdue > 30 Days</span>
          <div class="stat-value">$18K</div>
          <div class="stat-delta neg">4 tenants</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">On Payment Plans</span>
          <div class="stat-value">3</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Invoices Sent</span>
          <div class="stat-value">42</div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>AR & Collections — Invoice Tracker</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="arSearch" placeholder="Search invoices…" oninput="filterAR()">
            </div>
            <button class="btn btn-accent btn-sm" onclick="openARModal()">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              New Invoice
            </button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Tenant</th><th>Unit</th><th>Type</th><th>Amount</th><th>Due Date</th><th>Status</th><th>Days Overdue</th><th>Actions</th></tr></thead>
          <tbody id="arTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ APPROVAL MATRIX ════ -->
    <div class="view" id="view-approval-matrix">
      <div class="stats-grid">
        <div class="stat-card danger">
          <span class="stat-label">Awaiting Approval</span>
          <div class="stat-value" id="pendingApprovals">4</div>
        </div>
        <div class="stat-card success">
          <span class="stat-label">Approved This Month</span>
          <div class="stat-value">18</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Avg Approval Time</span>
          <div class="stat-value">1.4d</div>
        </div>
        <div class="stat-card danger">
          <span class="stat-label">Rejected</span>
          <div class="stat-value">2</div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>Pending Approvals</h2>
          <button class="btn btn-accent btn-sm" onclick="openApprovalModal()">New Request</button>
        </div>
        <div id="approvalList"></div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>Role-Based Approval Limits</h2>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Role</th><th>Expense Limit</th><th>Refund Limit</th><th>Discount Limit</th><th>Vendor Bills</th></tr></thead>
            <tbody>
              <tr><td><strong>Property Manager</strong></td><td>$500</td><td>$250</td><td>5%</td><td>$1,000</td></tr>
              <tr><td><strong>Regional Director</strong></td><td>$5,000</td><td>$2,000</td><td>15%</td><td>$10,000</td></tr>
              <tr><td><strong>CFO</strong></td><td>$50,000</td><td>$20,000</td><td>30%</td><td>$100,000</td></tr>
              <tr><td><strong>CEO</strong></td><td>Unlimited</td><td>Unlimited</td><td>Unlimited</td><td>Unlimited</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ AUDIT LOG ════ -->
    <div class="view" id="view-audit-log">
      <div class="section-card">
        <div class="section-header">
          <h2>Immutable Audit Log</h2>
          <div class="section-header-actions">
            <select class="btn btn-sm" id="auditFilter" onchange="filterAuditLog()" style="letter-spacing:0;text-transform:none;padding:6px 10px;">
              <option value="all">All Actions</option>
              <option value="create">Create</option>
              <option value="edit">Edit</option>
              <option value="delete">Delete</option>
              <option value="approve">Approve</option>
            </select>
            <button class="btn btn-sm" onclick="exportAuditCSV()">Export Log</button>
          </div>
        </div>
        <div id="auditLogList"></div>
      </div>
    </div>

    <!-- ════ LEASE INTELLIGENCE ════ -->
    <div class="view" id="view-lease-intelligence">
      <div class="stats-grid">
        <div class="stat-card danger">
          <span class="stat-label">Expiring in 60 Days</span>
          <div class="stat-value">5</div>
          <div class="stat-delta neg">Action required</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Renewal Probability</span>
          <div class="stat-value">72%</div>
        </div>
        <div class="stat-card success">
          <span class="stat-label">CPI Escalations Due</span>
          <div class="stat-value">8</div>
          <div class="stat-delta">Avg +3.4%</div>
        </div>
        <div class="stat-card danger">
          <span class="stat-label">High Churn Risk</span>
          <div class="stat-value">3</div>
          <div class="stat-delta neg">Follow up now</div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>Lease Intelligence Engine</h2>
          <button class="btn btn-accent btn-sm" onclick="openLeaseModal()">Add Lease</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Tenant</th><th>Unit</th><th>Lease End</th><th>Days Left</th><th>Monthly Rent</th><th>Escalation</th><th>Renewal Risk</th><th>Actions</th></tr></thead>
            <tbody id="leaseTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ VENDOR CONTROL ════ -->
    <div class="view" id="view-vendor-control">
      <div class="section-card">
        <div class="section-header">
          <h2>Vendor & Procurement Control</h2>
          <button class="btn btn-accent btn-sm" onclick="openVendorModal()">Add Vendor</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Vendor</th><th>Category</th><th>Compliance Docs</th><th>Active POs</th><th>Spend YTD</th><th>SLA Status</th><th>Actions</th></tr></thead>
            <tbody id="vendorTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>3-Way Match — PO / Invoice / Work Completion</h2>
          <button class="btn btn-sm" onclick="openPOModal()">New PO</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>PO Number</th><th>Vendor</th><th>Amount</th><th>PO</th><th>Invoice</th><th>Completion</th><th>Match Status</th><th>Pay</th></tr></thead>
            <tbody id="poTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ TENANT 360 ════ -->
    <div class="view" id="view-tenant-360">
      <div class="section-card">
        <div class="section-header">
          <h2>Tenant 360 — Full Profile View</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="tenantSearch" placeholder="Search tenants…" oninput="filterTenants()">
            </div>
            <button class="btn btn-accent btn-sm" onclick="openTenantModal()">Add Tenant</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Tenant</th><th>Unit</th><th>Lease Period</th><th>Payment History</th><th>Open Tickets</th><th>Legal Flag</th><th>Actions</th></tr></thead>
            <tbody id="tenantTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ AI COPILOT ════ -->
    <div class="view" id="view-ai-copilot">
      <div class="section-card">
        <div class="section-header">
          <h2>AI Copilot — Natural Language Commands</h2>
          <span style="font-size:0.68rem;color:var(--muted);letter-spacing:1px;">POWERED BY TAISEEL AI</span>
        </div>
        <div class="ai-chat-wrap">
          <div style="padding:0 0 12px;border-bottom:1px solid var(--border);margin-bottom:16px;">
            <p style="font-size:0.75rem;color:var(--muted);">Try natural language commands to control the system. No expert knowledge needed.</p>
          </div>
          <div style="margin-bottom:12px;">
            <span style="font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);">Quick Prompts</span>
            <div class="ai-quick-prompts" style="margin-top:8px;" id="quickPrompts">
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">Show overdue tenants in Tower A</button>
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">What is our NOI this quarter?</button>
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">Leases expiring in 60 days</button>
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">Flag high-risk tenants for review</button>
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">Pending approvals above $5,000</button>
              <button class="quick-prompt" onclick="sendQuickPrompt(this)">Vacancy impact on NOI if +5%?</button>
            </div>
          </div>
          <div class="ai-messages" id="aiMessages">
            <div class="ai-msg ai">Hello. I'm your AI property management assistant. Ask me anything about your portfolio, financials, tenants, or operations. I can also run actions for you.</div>
          </div>
          <div class="ai-input-row">
            <input type="text" id="aiInput" placeholder="e.g. Show me all overdue invoices above $2,000…" onkeydown="if(event.key==='Enter')sendAIMessage()">
            <button class="btn btn-primary" onclick="sendAIMessage()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ════ PROPERTIES ════ -->
    <div class="view" id="view-properties-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Residential Properties</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="propertiesSearch" placeholder="Search properties…" oninput="filterProperties()">
            </div>
            <button onclick="openPropertyModal()" class="btn btn-accent btn-sm">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Property
            </button>
            <button onclick="fetchProperties()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="propertiesLoader" class="loader-row"><span class="spinner"></span> Loading properties…</div>
        <div class="table-wrap" id="propertiesTableContainer" style="display:none;">
          <table>
            <thead><tr><th>Address</th><th>Type</th><th>Beds / Baths</th><th>Sqft</th><th>Current Value</th><th>Est. Rent</th><th>Year Built</th><th>Actions</th></tr></thead>
            <tbody id="propertiesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ UNITS ════ -->
    <div class="view" id="view-units-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Building Units</h2>
          <div class="section-header-actions">
            <a href="palm-central-private-residences.html#valuation" class="btn btn-sm">Open Listing</a>
            <button onclick="fetchUnits()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="unitsLoader" class="loader-row"><span class="spinner"></span> Loading units…</div>
        <div class="table-wrap" id="unitsTableContainer" style="display:none;">
          <table>
            <thead><tr><th>Unit</th><th>Status</th><th>Value</th><th>Rent</th><th>Last Sold</th><th>Update</th></tr></thead>
            <tbody id="unitsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ REGISTRATIONS ════ -->
    <div class="view" id="view-registrations-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Registrations</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="regSearch" placeholder="Search registrations…" oninput="filterRegistrations()">
            </div>
            <button onclick="exportCSV()" class="btn btn-sm">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export CSV
            </button>
            <button onclick="fetchLeads()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="loader" class="loader-row"><span class="spinner"></span> Fetching registrations…</div>
        <div class="table-wrap" id="tableContainer" style="display:none;">
          <table>
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ TENANTS ════ -->
    <div class="view" id="view-tenants-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Tenant Management</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="tenantsSearch" placeholder="Search tenants…" oninput="renderTenants()">
            </div>
            <button class="btn btn-accent btn-sm" onclick="openTenantModal()">+ Add Tenant</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th onclick="sortTable('tenantsTableBody',0,this)">Name</th><th>Unit / Property</th><th>Email</th><th>Phone</th><th>Lease Start</th><th>Lease End</th><th>Rent/mo</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="tenantsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ ROI CALCULATOR ════ -->
    <div class="view" id="view-roi-view">
      <div class="section-card">
        <div class="section-header"><h2>ROI &amp; Cash Flow Calculator</h2></div>
        <div class="modal-body">
          <div class="roi-grid">
            <div>
              <div class="form-grid-modal" style="margin-bottom:20px;">
                <div class="form-group"><label>Purchase Price ($)</label><input type="number" id="roi_purchase" value="250000" oninput="calcROI()"></div>
                <div class="form-group"><label>Current Value ($)</label><input type="number" id="roi_value" value="310000" oninput="calcROI()"></div>
                <div class="form-group"><label>Monthly Rent ($)</label><input type="number" id="roi_rent" value="2200" oninput="calcROI()"></div>
                <div class="form-group"><label>Monthly Expenses ($)</label><input type="number" id="roi_expenses" value="400" oninput="calcROI()"></div>
                <div class="form-group"><label>Mortgage Payment ($/mo)</label><input type="number" id="roi_mortgage" value="1100" oninput="calcROI()"></div>
                <div class="form-group"><label>Vacancy Rate (%)</label><input type="number" id="roi_vacancy" value="5" min="0" max="100" oninput="calcROI()"></div>
                <div class="form-group"><label>Property Tax ($/yr)</label><input type="number" id="roi_tax" value="3600" oninput="calcROI()"></div>
                <div class="form-group"><label>Insurance ($/yr)</label><input type="number" id="roi_insurance" value="1200" oninput="calcROI()"></div>
              </div>
            </div>
            <div class="roi-result">
              <div style="font-size:0.7rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Results</div>
              <div class="roi-result-row"><span class="roi-result-label">Effective Monthly Rent</span><span id="roi_eff_rent">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Annual Gross Income</span><span id="roi_gross">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Annual Expenses</span><span id="roi_annual_exp">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">NOI (Net Operating Income)</span><span id="roi_noi">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Annual Cash Flow</span><span id="roi_cf">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Cash-on-Cash Return</span><span id="roi_coc">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Cap Rate</span><span id="roi_caprate">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Gross Rental Yield</span><span id="roi_gryrld">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label">Value Appreciation</span><span id="roi_apprc">—</span></div>
              <div class="roi-result-row"><span class="roi-result-label" style="font-weight:700;font-size:0.8rem;">Total ROI (excl. leverage)</span><span id="roi_total" style="color:var(--success);font-size:1.1rem;">—</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ════ NOTES LOG ════ -->
    <div class="view" id="view-notes-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Property Notes Log</h2>
          <div class="section-header-actions">
            <select class="filter-select" id="notesPropertyFilter" onchange="renderNotes()">
              <option value="all">All Properties</option>
            </select>
          </div>
        </div>
        <div style="padding:20px 28px 10px;">
          <div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:10px;">Add Note</div>
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;margin-bottom:16px;align-items:start;">
            <select class="filter-select" id="noteProperty" style="padding:10px 12px;font-size:0.8rem;height:42px;">
              <option value="">Select property/unit…</option>
            </select>
          </div>
          <div class="note-input-row">
            <textarea id="noteText" placeholder="Write a note about any property, unit, tenant, or general portfolio item…"></textarea>
            <button class="btn btn-primary" onclick="addNote()" style="align-self:flex-end;">Add Note</button>
          </div>
        </div>
        <div class="notes-log" id="notesList"></div>
      </div>
    </div>

    <!-- ════ VACANCY PIPELINE ════ -->
    <div class="view" id="view-vacancy-view">
      <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-bottom:24px;">
        <div class="stat-card"><span class="stat-label">Vacant Units</span><div class="stat-value" id="vac_vacant">—</div></div>
        <div class="stat-card"><span class="stat-label">Listed / Marketing</span><div class="stat-value" id="vac_listed">—</div></div>
        <div class="stat-card"><span class="stat-label">Applications</span><div class="stat-value" id="vac_apps">—</div></div>
        <div class="stat-card"><span class="stat-label">Avg Days on Market</span><div class="stat-value" id="vac_dom">—</div></div>
      </div>
      <div class="section-card">
        <div class="section-header">
          <h2>Vacancy Funnel</h2>
          <button class="btn btn-accent btn-sm" onclick="openVacancyModal()">+ Add Vacancy Record</button>
        </div>
        <div class="funnel-wrap" id="vacancyFunnel"></div>
      </div>
      <div class="section-card">
        <div class="section-header"><h2>Vacancy Records</h2></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Unit / Property</th><th>Vacant Since</th><th>Days on Market</th><th>Stage</th><th>Asking Rent</th><th>Showings</th><th>Applications</th><th>Actions</th></tr></thead>
            <tbody id="vacancyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /page-content -->
</div><!-- /main -->

<!-- Toast -->
<div id="toast"></div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmMsg">This action cannot be undone.</p>
    <div class="confirm-actions">
      <button class="btn" onclick="closeConfirm(false)">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn" onclick="closeConfirm(true)">Delete</button>
    </div>
  </div>
</div>

<!-- ════ MODALS ════ -->

<!-- Property Modal -->
<div class="modal-overlay" id="propertyModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="propertyModalTitle">Add New Property</h2>
      <button class="modal-close" onclick="closeModal('propertyModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="propertyForm">
        <input type="hidden" id="propertyId">
        <div class="form-grid">
          <div class="form-group full"><label>Address *</label><input type="text" id="address" required></div>
          <div class="form-group"><label>Current Value ($) *</label><input type="number" id="currentValue" min="1" required></div>
          <div class="form-group"><label>Estimated Rent ($/mo)</label><input type="number" id="estimatedRent" min="0"></div>
          <div class="form-group"><label>Square Feet *</label><input type="number" id="sqft" min="1" required></div>
          <div class="form-group"><label>Bedrooms *</label><input type="number" id="bedrooms" min="0" required></div>
          <div class="form-group"><label>Bathrooms *</label><input type="number" id="bathrooms" min="0" step="0.5" required></div>
          <div class="form-group"><label>Lot Size (sqft)</label><input type="number" id="lotSize" min="0"></div>
          <div class="form-group"><label>Property Type *</label>
            <select id="propertyType" required>
              <option value="">Select Type</option>
              <option value="Single Family">Single Family</option>
              <option value="Condo">Condo</option>
              <option value="Townhouse">Townhouse</option>
              <option value="Multi-Family">Multi-Family</option>
              <option value="Land">Land</option>
            </select>
          </div>
          <div class="form-group"><label>Year Built *</label><input type="number" id="yearBuilt" min="1800" max="2030" required></div>
          <div class="form-group"><label>Project Slug *</label>
            <select id="projectSlug" required>
              <option value="">Select Project</option>
              <option value="palm-central-private-residences">Palm Central</option>
              <option value="the-heights-residences">The Heights</option>
              <option value="brilliant-tower">Brilliant Tower</option>
              <option value="inzovu-mall">Inzovu Mall</option>
              <option value="kigali-heights">Kigali Heights</option>
            </select>
          </div>
          <div class="form-group"><label>Purchase Price ($)</label><input type="number" id="purchasePrice" min="0"></div>
          <div class="form-group"><label>Last Sold Date</label><input type="date" id="lastSoldAt"></div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('propertyModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitPropertyForm()">Save Property</button>
    </div>
  </div>
</div>

<!-- Home Listing Modal -->
<div class="modal-overlay" id="homeModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="homeModalTitle">Create Home Listing</h2>
      <button class="modal-close" onclick="closeModal('homeModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Home Address *</label><input type="text" id="homeAddress"></div>
        <div class="form-group"><label>Status</label>
          <select id="homeStatus">
            <option value="occupied">Occupied</option>
            <option value="vacancy">Vacancy</option>
            <option value="listed">Listed</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div class="form-group"><label>Lease Details *</label><input type="text" id="homeLease"></div>
        <div class="form-group"><label>Rent Price ($)</label><input type="number" id="homeRent" min="0"></div>
        <div class="form-group full"><label>Maintenance Request</label><input type="text" id="homeMaintenance"></div>
        <div class="form-group full"><label>Notice</label><input type="text" id="homeNotice"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('homeModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitHomeForm()">Create Listing</button>
    </div>
  </div>
</div>

<!-- Apartment Unit Modal -->
<div class="modal-overlay" id="unitModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="unitModalTitle">Add Apartment Unit</h2>
      <button class="modal-close" onclick="closeModal('unitModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Unit *</label><input type="text" id="unitName"></div>
        <div class="form-group"><label>Address *</label><input type="text" id="unitAddress"></div>
        <div class="form-group"><label>Type *</label><input type="text" id="unitType"></div>
        <div class="form-group"><label>Price ($) *</label><input type="number" id="unitPrice" min="0"></div>
        <div class="form-group"><label>Rent Price ($) *</label><input type="number" id="unitRent" min="0"></div>
        <div class="form-group"><label>Status</label>
          <select id="unitStatus">
            <option value="vacant">Vacant</option>
            <option value="listed">Listed</option>
            <option value="occupied">Occupied</option>
          </select>
        </div>
        <div class="form-group full"><label>Building Announcement</label><input type="text" id="unitAnnouncement"></div>
        <div class="form-group full"><label>Turnover Tracking</label><input type="text" id="unitTurnover"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitUnitForm()">Create Unit</button>
    </div>
  </div>
</div>

<!-- Lead Modal -->
<div class="modal-overlay" id="leadModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="leadModalTitle">Add Lead</h2>
      <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Lead Name *</label><input type="text" id="portalLeadName"></div>
        <div class="form-group"><label>Email</label><input type="email" id="portalLeadEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="portalLeadPhone"></div>
        <div class="form-group full"><label>Source / Qualification *</label><input type="text" id="portalLeadSource"></div>
        <div class="form-group"><label>Pipeline Stage</label>
          <select id="portalLeadStage">
            <option value="inquiry">Inquiry</option>
            <option value="qualified">Qualified</option>
            <option value="showing">Showing</option>
            <option value="offer">Offer</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="form-group"><label>Timeline</label>
          <select id="portalLeadTimeline">
            <option value="immediately">Immediately</option>
            <option value="in 3 months">In 3 months</option>
            <option value="in 6 months">In 6 months</option>
            <option value="later">Later</option>
          </select>
        </div>
        <div class="form-group full"><label>Preferences &amp; Priorities *</label><input type="text" id="portalLeadPrefs"></div>
        <div class="form-group full"><label>Follow-up Pipeline Step *</label><input type="text" id="portalLeadFollowup"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('leadModal')">Cancel</button>
      <button class="btn btn-accent" onclick="submitLeadForm()">Save Lead</button>
    </div>
  </div>
</div>

<!-- Admin Report Modal -->
<div class="modal-overlay" id="adminModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Add Portfolio Report</h2>
      <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Portfolio-Level Report *</label><input type="text" id="adminReport"></div>
        <div class="form-group full"><label>Workflow</label><input type="text" id="adminWorkflow"></div>
        <div class="form-group full"><label>Cross-Portal Monitoring</label><input type="text" id="adminMonitoring"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('adminModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAdminForm()">Add Report</button>
    </div>
  </div>
</div>

<!-- Operations Modal -->
<div class="modal-overlay" id="opsModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Work Order</h2>
      <button class="modal-close" onclick="closeModal('opsModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Work Order Description *</label><input type="text" id="opsWorkOrder"></div>
        <div class="form-group"><label>Priority</label>
          <select id="opsPriority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
        </div>
        <div class="form-group"><label>Status</label>
          <select id="opsStatus"><option value="open">Open</option><option value="in-progress">In Progress</option><option value="closed">Closed</option></select>
        </div>
        <div class="form-group"><label>Assigned To</label><input type="text" id="opsAssigned"></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="opsDue"></div>
        <div class="form-group"><label>Estimated Cost ($)</label><input type="number" id="opsCost" min="0"></div>
        <div class="form-group full"><label>Service-Level Tracking</label><input type="text" id="opsServiceLevel"></div>
        <div class="form-group full"><label>Preventive Maintenance Log</label><input type="text" id="opsPreventive"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('opsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitOpsForm()">Save Work Order</button>
    </div>
  </div>
</div>

<!-- AR Invoice Modal -->
<div class="modal-overlay" id="arModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="arModalTitle">New Invoice</h2>
      <button class="modal-close" onclick="closeModal('arModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Tenant Name *</label><input type="text" id="arTenant"></div>
        <div class="form-group"><label>Unit *</label><input type="text" id="arUnit"></div>
        <div class="form-group"><label>Type</label>
          <select id="arType">
            <option value="Rent">Rent</option>
            <option value="Service Charge">Service Charge</option>
            <option value="Utility">Utility</option>
            <option value="Penalty">Penalty</option>
          </select>
        </div>
        <div class="form-group"><label>Amount ($) *</label><input type="number" id="arAmount" min="0"></div>
        <div class="form-group"><label>Due Date *</label><input type="date" id="arDueDate"></div>
        <div class="form-group"><label>Status</label>
          <select id="arStatus">
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="overdue">Overdue</option>
            <option value="payment-plan">Payment Plan</option>
          </select>
        </div>
        <div class="form-group full"><label>Notes</label><textarea id="arNotes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('arModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitARForm()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- Approval Modal -->
<div class="modal-overlay" id="approvalModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>New Approval Request</h2>
      <button class="modal-close" onclick="closeModal('approvalModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Request Title *</label><input type="text" id="approvalTitle"></div>
        <div class="form-group"><label>Type</label>
          <select id="approvalType">
            <option value="Expense">Expense</option>
            <option value="Refund">Refund</option>
            <option value="Discount">Discount</option>
            <option value="Vendor Bill">Vendor Bill</option>
          </select>
        </div>
        <div class="form-group"><label>Amount ($) *</label><input type="number" id="approvalAmount" min="0"></div>
        <div class="form-group"><label>Requested By *</label><input type="text" id="approvalRequester"></div>
        <div class="form-group full"><label>Justification</label><textarea id="approvalJustification"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('approvalModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitApprovalForm()">Submit Request</button>
    </div>
  </div>
</div>

<!-- P&L Modal -->
<div class="modal-overlay" id="plModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Add P&L Entry</h2>
      <button class="modal-close" onclick="closeModal('plModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Property *</label><input type="text" id="plProperty"></div>
        <div class="form-group"><label>Revenue ($) *</label><input type="number" id="plRevenue" min="0"></div>
        <div class="form-group"><label>Expenses ($) *</label><input type="number" id="plExpenses" min="0"></div>
        <div class="form-group"><label>Occupancy (%)</label><input type="number" id="plOccupancy" min="0" max="100"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('plModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitPLForm()">Save Entry</button>
    </div>
  </div>
</div>

<!-- Capex Modal -->
<div class="modal-overlay" id="capexModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Add Capex Item</h2>
      <button class="modal-close" onclick="closeModal('capexModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Item *</label><input type="text" id="capexItem"></div>
        <div class="form-group"><label>Property *</label><input type="text" id="capexProperty"></div>
        <div class="form-group"><label>Budget ($) *</label><input type="number" id="capexBudget" min="0"></div>
        <div class="form-group"><label>Spent ($)</label><input type="number" id="capexSpent" min="0"></div>
        <div class="form-group"><label>Status</label>
          <select id="capexStatus">
            <option value="planned">Planned</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('capexModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitCapexForm()">Save</button>
    </div>
  </div>
</div>

<!-- Lease Modal -->
<div class="modal-overlay" id="leaseModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="leaseModalTitle">Add Lease</h2>
      <button class="modal-close" onclick="closeModal('leaseModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Tenant *</label><input type="text" id="leaseTenant"></div>
        <div class="form-group"><label>Unit *</label><input type="text" id="leaseUnit"></div>
        <div class="form-group"><label>Lease End Date *</label><input type="date" id="leaseEnd"></div>
        <div class="form-group"><label>Monthly Rent ($) *</label><input type="number" id="leaseRent" min="0"></div>
        <div class="form-group"><label>Escalation Type</label>
          <select id="leaseEscalation">
            <option value="CPI">CPI Linked</option>
            <option value="Fixed 3%">Fixed 3%</option>
            <option value="Fixed 5%">Fixed 5%</option>
            <option value="None">None</option>
          </select>
        </div>
        <div class="form-group"><label>Renewal Risk</label>
          <select id="leaseRisk">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('leaseModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitLeaseForm()">Save Lease</button>
    </div>
  </div>
</div>

<!-- Vendor Modal -->
<div class="modal-overlay" id="vendorModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="vendorModalTitle">Add Vendor</h2>
      <button class="modal-close" onclick="closeModal('vendorModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Vendor Name *</label><input type="text" id="vendorName"></div>
        <div class="form-group"><label>Category *</label>
          <select id="vendorCategory">
            <option value="Plumbing">Plumbing</option>
            <option value="Electrical">Electrical</option>
            <option value="Cleaning">Cleaning</option>
            <option value="HVAC">HVAC</option>
            <option value="Security">Security</option>
            <option value="Landscaping">Landscaping</option>
            <option value="General">General</option>
          </select>
        </div>
        <div class="form-group"><label>Compliance Docs</label>
          <select id="vendorCompliance">
            <option value="Complete">Complete</option>
            <option value="Partial">Partial</option>
            <option value="Missing">Missing</option>
          </select>
        </div>
        <div class="form-group"><label>Spend YTD ($)</label><input type="number" id="vendorSpend" min="0"></div>
        <div class="form-group"><label>SLA Status</label>
          <select id="vendorSLA">
            <option value="On Track">On Track</option>
            <option value="At Risk">At Risk</option>
            <option value="Breached">Breached</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('vendorModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitVendorForm()">Save Vendor</button>
    </div>
  </div>
</div>

<!-- PO Modal -->
<div class="modal-overlay" id="poModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>New Purchase Order</h2>
      <button class="modal-close" onclick="closeModal('poModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Vendor *</label><input type="text" id="poVendor"></div>
        <div class="form-group"><label>Amount ($) *</label><input type="number" id="poAmount" min="0"></div>
        <div class="form-group"><label>PO Issued</label>
          <select id="poPO"><option value="Yes">Yes</option><option value="No">No</option></select>
        </div>
        <div class="form-group"><label>Invoice Received</label>
          <select id="poInvoice"><option value="No">No</option><option value="Yes">Yes</option></select>
        </div>
        <div class="form-group"><label>Work Completed</label>
          <select id="poCompletion"><option value="No">No</option><option value="Yes">Yes</option></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('poModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitPOForm()">Create PO</button>
    </div>
  </div>
</div>

<!-- Tenant Modal -->
<div class="modal-overlay" id="tenantModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="tenantModalTitle">Add Tenant</h2>
      <button class="modal-close" onclick="closeModal('tenantModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group"><label>First Name *</label><input type="text" id="tenantFirst"></div>
        <div class="form-group"><label>Last Name *</label><input type="text" id="tenantLast"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="tenantEmail"></div>
        <div class="form-group"><label>Phone *</label><input type="tel" id="tenantPhone"></div>
        <div class="form-group"><label>Unit / Property</label><input type="text" id="tenantUnit"></div>
        <div class="form-group"><label>Monthly Rent ($)</label><input type="number" id="tenantRent" min="0"></div>
        <div class="form-group"><label>Lease Start</label><input type="date" id="tenantLeaseStart"></div>
        <div class="form-group"><label>Lease End</label><input type="date" id="tenantLeaseEnd"></div>
        <div class="form-group"><label>Emergency Contact</label><input type="text" id="tenantEmergency"></div>
        <div class="form-group"><label>Status</label>
          <select id="tenantStatus"><option value="active">Active</option><option value="notice">Notice Period</option><option value="past">Past</option></select>
        </div>
        <div class="form-group full"><label>Notes</label><textarea id="tenantNotes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('tenantModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitTenantForm()">Save Tenant</button>
    </div>
  </div>
</div>

<!-- Vacancy Modal -->
<div class="modal-overlay" id="vacancyModal">
  <div class="modal-box narrow">
    <div class="modal-head">
      <h2>Add Vacancy Record</h2>
      <button class="modal-close" onclick="closeModal('vacancyModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Unit / Property *</label><input type="text" id="vacUnit"></div>
        <div class="form-group"><label>Vacant Since</label><input type="date" id="vacSince"></div>
        <div class="form-group"><label>Asking Rent ($/mo)</label><input type="number" id="vacRent" min="0"></div>
        <div class="form-group"><label>Stage</label>
          <select id="vacStage">
            <option value="vacant">Vacant</option>
            <option value="marketing">Marketing</option>
            <option value="showing">Showing</option>
            <option value="application">Application</option>
            <option value="approved">Approved</option>
          </select>
        </div>
        <div class="form-group"><label>Showings Scheduled</label><input type="number" id="vacShowings" min="0" value="0"></div>
        <div class="form-group"><label>Applications Received</label><input type="number" id="vacApps" min="0" value="0"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('vacancyModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitVacancyForm()">Save</button>
    </div>
  </div>
</div>

<!-- Detail View Popup -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-box">
    <div class="modal-head">
      <h2 id="detailTitle">Detail View</h2>
      <button class="modal-close" onclick="closeModal('detailOverlay')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('detailOverlay')">Close</button></div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════
let currentLeads = [];
let propertiesData = [];
let unitsData = [];

const adminPortalRows = [
  { id: 1, report: 'Monthly valuation + occupancy', workflow: 'Budget approval pending CFO', monitoring: 'Homes, apartments, leads all synced' }
];
const homesPortalRows = [];
const apartmentPortalRows = [];
const leadsPortalRows = [];
const operationsPortalRows = [
  { id: 1, workOrder: 'Assign plumbing issue to Vendor A', serviceLevel: 'Target response < 24h', preventive: 'Quarterly HVAC check logged' }
];

// Finance State
let arRows = [
  { id:1, tenant:'Ahmed Al-Rashid', unit:'A-104', type:'Rent', amount:3200, dueDate:'2025-02-01', status:'overdue', notes:'' },
  { id:2, tenant:'Sara Kamau', unit:'B-202', type:'Rent', amount:2800, dueDate:'2025-02-01', status:'paid', notes:'' },
  { id:3, tenant:'James Mwangi', unit:'C-301', type:'Service Charge', amount:450, dueDate:'2025-02-15', status:'pending', notes:'' },
  { id:4, tenant:'Fatima Nkosi', unit:'A-205', type:'Rent', amount:4100, dueDate:'2025-01-01', status:'overdue', notes:'Payment plan initiated' },
  { id:5, tenant:'David Okonkwo', unit:'D-107', type:'Utility', amount:320, dueDate:'2025-02-20', status:'pending', notes:'' },
];
let nextARId = 6;

let approvalRows = [
  { id:1, title:'Elevator maintenance contract', type:'Vendor Bill', amount:12500, requester:'James K.', status:'pending', justification:'Annual contract renewal' },
  { id:2, title:'Tenant move-out refund - Unit C-301', type:'Refund', amount:1800, requester:'Sarah M.', status:'pending', justification:'Deposit minus damages' },
  { id:3, title:'Emergency roof repair - Tower B', type:'Expense', amount:8400, requester:'Ahmed R.', status:'pending', justification:'Storm damage, urgent' },
  { id:4, title:'10% discount for 3-year lease renewal', type:'Discount', amount:0, requester:'David O.', status:'pending', justification:'Retain long-term tenant' },
];
let nextApprovalId = 5;

let auditLog = [
  { id:1, action:'create', actor:'Sarah M.', detail:'Added property — Palm Central Unit A-104', time:'Today, 09:14' },
  { id:2, action:'approve', actor:'CFO System', detail:'Approved invoice #INV-2031 — $3,200 from Ahmed Al-Rashid', time:'Today, 08:52' },
  { id:3, action:'edit', actor:'James K.', detail:'Updated unit B-202 status → Occupied', time:'Yesterday, 17:30' },
  { id:4, action:'delete', actor:'Admin', detail:'Removed expired vendor contract — CleanPro Ltd.', time:'Yesterday, 14:10' },
  { id:5, action:'create', actor:'Sarah M.', detail:'New work order assigned — Plumbing, Unit D-107', time:'Feb 24, 11:05' },
  { id:6, action:'approve', actor:'Regional Director', detail:'Approved capex $8,400 — Emergency roof repair', time:'Feb 23, 16:45' },
  { id:7, action:'edit', actor:'David O.', detail:'Modified lease escalation — Unit A-205, CPI → Fixed 3%', time:'Feb 22, 09:20' },
  { id:8, action:'create', actor:'Fatima N.', detail:'Payment plan initiated — Unit A-205, $4,100 overdue', time:'Feb 20, 13:00' },
];

let plRows = [
  { id:1, property:'Palm Central Tower A', revenue:42000, expenses:18000, occupancy:92 },
  { id:2, property:'The Heights Residences', revenue:31500, expenses:12000, occupancy:88 },
  { id:3, property:'Brilliant Tower', revenue:28000, expenses:9500, occupancy:95 },
  { id:4, property:'Kigali Heights', revenue:19000, expenses:8200, occupancy:76 },
];
let nextPLId = 5;

let capexRows = [
  { id:1, item:'Elevator Modernization', property:'Palm Central', budget:45000, spent:38000, status:'in-progress' },
  { id:2, item:'Lobby Renovation', property:'The Heights', budget:22000, spent:22000, status:'completed' },
  { id:3, item:'Roof Waterproofing', property:'Brilliant Tower', budget:15000, spent:2000, status:'planned' },
];
let nextCapexId = 4;

let leaseRows = [
  { id:1, tenant:'Ahmed Al-Rashid', unit:'A-104', leaseEnd:'2025-04-01', rent:3200, escalation:'CPI', risk:'High' },
  { id:2, tenant:'Sara Kamau', unit:'B-202', leaseEnd:'2025-07-15', rent:2800, escalation:'Fixed 3%', risk:'Low' },
  { id:3, tenant:'James Mwangi', unit:'C-301', leaseEnd:'2025-03-31', rent:2400, escalation:'None', risk:'Medium' },
  { id:4, tenant:'Fatima Nkosi', unit:'A-205', leaseEnd:'2025-03-01', rent:4100, escalation:'CPI', risk:'High' },
  { id:5, tenant:'David Okonkwo', unit:'D-107', leaseEnd:'2025-09-30', rent:1900, escalation:'Fixed 5%', risk:'Low' },
];
let nextLeaseId = 6;

let vendorRows = [
  { id:1, name:'FastFix Plumbing', category:'Plumbing', compliance:'Complete', activePOs:2, spendYTD:8400, sla:'On Track' },
  { id:2, name:'LightUp Electrical', category:'Electrical', compliance:'Complete', activePOs:1, spendYTD:5200, sla:'On Track' },
  { id:3, name:'CleanPro Services', category:'Cleaning', compliance:'Partial', activePOs:3, spendYTD:14000, sla:'At Risk' },
  { id:4, name:'CoolAir HVAC', category:'HVAC', compliance:'Missing', activePOs:0, spendYTD:2100, sla:'Breached' },
];
let nextVendorId = 5;

let poRows = [
  { id:1, poNum:'PO-2041', vendor:'FastFix Plumbing', amount:8400, po:'Yes', invoice:'Yes', completion:'Yes' },
  { id:2, poNum:'PO-2042', vendor:'CleanPro Services', amount:3200, po:'Yes', invoice:'Yes', completion:'No' },
  { id:3, poNum:'PO-2043', vendor:'LightUp Electrical', amount:1800, po:'Yes', invoice:'No', completion:'No' },
];
let nextPOId = 4;
let nextPONum = 2044;

let tenantRows = [
  { id:1, name:'Ahmed Al-Rashid', unit:'A-104', leaseStart:'2023-04-01', leaseEnd:'2025-04-01', payHistory:'Fair', tickets:2, legal:'Notice Served' },
  { id:2, name:'Sara Kamau', unit:'B-202', leaseStart:'2022-07-15', leaseEnd:'2025-07-15', payHistory:'Excellent', tickets:0, legal:'None' },
  { id:3, name:'James Mwangi', unit:'C-301', leaseStart:'2023-03-31', leaseEnd:'2025-03-31', payHistory:'Good', tickets:1, legal:'None' },
  { id:4, name:'Fatima Nkosi', unit:'A-205', leaseStart:'2022-03-01', leaseEnd:'2025-03-01', payHistory:'Poor', tickets:3, legal:'Dispute' },
];
let nextTenantId = 5;

let nextId = { admin: 2, home: 1, apt: 1, lead: 1, ops: 2, tenant: 1, note: 1, vac: 1 };
let confirmCallback = null;

// Original Tenants, Notes, Vacancy state
const tenantsRows = [];
const notesRows = [];
const vacancyRows = [];

// ══════════════════════════════════════════════
//  NAV
// ══════════════════════════════════════════════
const viewTitles = {
  'overview': 'Dashboard',
  'admin-portal': 'Admin Portal',
  'homes-portal': 'Individual Homes',
  'apartments-portal': 'Apartments',
  'leads-portal': 'Leads',
  'operations-portal': 'Operations',
  'finance-hub': 'Finance Hub',
  'ar-collections': 'AR & Collections',
  'approval-matrix': 'Approval Matrix',
  'audit-log': 'Audit Log',
  'lease-intelligence': 'Lease Intelligence',
  'vendor-control': 'Vendor Control',
  'tenant-360': 'Tenant 360',
  'ai-copilot': 'AI Copilot',
  'properties-view': 'Residential Properties',
  'units-view': 'Building Units',
  'registrations-view': 'Registrations',
  'tenants-view': 'Tenant Management',
  'roi-view': 'ROI Calculator',
  'notes-view': 'Notes Log',
  'vacancy-view': 'Vacancy Pipeline'
};

function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const viewEl = document.getElementById('view-' + id);
  if (viewEl) viewEl.classList.add('active');
  event?.currentTarget?.classList.add('active');
  document.getElementById('topbarTitle').textContent = viewTitles[id] || id;
  if (window.innerWidth < 900) {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('open');
  }
  if (id === 'roi-view') calcROI();
  if (id === 'vacancy-view') renderVacancyView();
  if (id === 'notes-view') renderNotes();
  if (id === 'tenants-view') renderTenants();
  if (id === 'leads-portal') renderLeadsPortal();
  if (id === 'operations-portal') renderOperationsPortal();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

// ══════════════════════════════════════════════
//  TOAST
// ══════════════════════════════════════════════
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type === 'error' ? 'show error' : 'show';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ''; }, 3200);
}

// ══════════════════════════════════════════════
//  CONFIRM DIALOG
// ══════════════════════════════════════════════
function openConfirm(title, msg, cb, btnLabel = 'Delete') {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmOkBtn').textContent = btnLabel;
  confirmCallback = cb;
  document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm(result) {
  document.getElementById('confirmOverlay').classList.remove('active');
  if (result && confirmCallback) confirmCallback();
  confirmCallback = null;
}

// ══════════════════════════════════════════════
//  MODALS
// ══════════════════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// ══════════════════════════════════════════════
//  TABLE SORT
// ══════════════════════════════════════════════
let sortState = {};
function sortTable(tbodyId, colIdx, thEl) {
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const key = tbodyId + colIdx;
  const asc = sortState[key] !== true;
  sortState[key] = asc;
  document.querySelectorAll('th.sorted-asc,th.sorted-desc').forEach(t=>{t.classList.remove('sorted-asc','sorted-desc');});
  if(thEl) thEl.classList.add(asc?'sorted-asc':'sorted-desc');
  rows.sort((a,b)=>{
    const ta=(a.cells[colIdx]?.textContent||'').trim();
    const tb=(b.cells[colIdx]?.textContent||'').trim();
    const na=parseFloat(ta.replace(/[^0-9.-]/g,'')), nb=parseFloat(tb.replace(/[^0-9.-]/g,''));
    if(!isNaN(na)&&!isNaN(nb)) return asc?na-nb:nb-na;
    return asc?ta.localeCompare(tb):tb.localeCompare(ta);
  });
  rows.forEach(r=>tbody.appendChild(r));
}

// ══════════════════════════════════════════════
//  BADGE HELPERS
// ══════════════════════════════════════════════
function statusBadge(status) {
  const map = {
    occupied: 'badge-green', listed: 'badge-blue', vacant: 'badge-gold',
    vacancy: 'badge-gold', sold: 'badge-gray', immediately: 'badge-green',
    'in 3 months': 'badge-blue', 'in 6 months': 'badge-gold', later: 'badge-gray',
    paid: 'badge-green', pending: 'badge-blue', overdue: 'badge-red',
    'payment-plan': 'badge-purple',
    'On Track': 'badge-green', 'At Risk': 'badge-gold', 'Breached': 'badge-red',
    Low: 'badge-green', Medium: 'badge-gold', High: 'badge-red',
    Excellent: 'badge-green', Good: 'badge-blue', Fair: 'badge-gold', Poor: 'badge-red',
    Complete: 'badge-green', Partial: 'badge-gold', Missing: 'badge-red',
    planned: 'badge-gray', 'in-progress': 'badge-blue', completed: 'badge-green',
    approved: 'badge-green', rejected: 'badge-red',
    None: 'badge-gray', 'Notice Served': 'badge-gold', Eviction: 'badge-red', Dispute: 'badge-red'
  };
  return `<span class="badge ${map[status] || 'badge-gray'}">${status}</span>`;
}

// ══════════════════════════════════════════════
//  AUDIT LOG HELPER
// ══════════════════════════════════════════════
function addAuditEntry(action, actor, detail) {
  const now = new Date();
  auditLog.unshift({
    id: Date.now(),
    action,
    actor,
    detail,
    time: 'Just now'
  });
  renderAuditLog();
}

// ══════════════════════════════════════════════
//  ADMIN PORTAL
// ══════════════════════════════════════════════
function renderAdminPortal() {
  const tbody = document.getElementById('adminPortalTableBody');
  tbody.innerHTML = adminPortalRows.length
    ? adminPortalRows.map(r => `
        <tr>
          <td>${r.report}</td>
          <td>${r.workflow}</td>
          <td>${r.monitoring}</td>
          <td>
            <button class="btn btn-sm" onclick="editAdminRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAdminRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="4"><div class="empty-state">No reports yet.</div></td></tr>`;
}

function openAdminModal(id = null) {
  const editing = id ? adminPortalRows.find(r => r.id === id) : null;
  document.getElementById('adminReport').value = editing?.report || '';
  document.getElementById('adminWorkflow').value = editing?.workflow || '';
  document.getElementById('adminMonitoring').value = editing?.monitoring || '';
  document.getElementById('adminModal').dataset.editId = id || '';
  openModal('adminModal');
}
function submitAdminForm() {
  const report = document.getElementById('adminReport').value.trim();
  if (!report) return showToast('Report field is required.', 'error');
  const editId = parseInt(document.getElementById('adminModal').dataset.editId);
  if (editId) {
    const r = adminPortalRows.find(x => x.id === editId);
    if (r) { r.report = report; r.workflow = document.getElementById('adminWorkflow').value.trim(); r.monitoring = document.getElementById('adminMonitoring').value.trim(); }
    addAuditEntry('edit', 'Admin', `Updated portfolio report — ${report}`);
  } else {
    adminPortalRows.push({ id: nextId.admin++, report, workflow: document.getElementById('adminWorkflow').value.trim(), monitoring: document.getElementById('adminMonitoring').value.trim() });
    addAuditEntry('create', 'Admin', `Added portfolio report — ${report}`);
  }
  closeModal('adminModal');
  renderAdminPortal();
  showToast('Report saved.');
}
function editAdminRow(id) { openAdminModal(id); }
function deleteAdminRow(id) {
  openConfirm('Delete Report', 'Remove this portfolio report?', () => {
    const r = adminPortalRows.find(x => x.id === id);
    const i = adminPortalRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Deleted portfolio report — ${r?.report}`); adminPortalRows.splice(i, 1); }
    renderAdminPortal();
    showToast('Report deleted.');
  });
}

// ══════════════════════════════════════════════
//  HOMES PORTAL
// ══════════════════════════════════════════════
function renderHomesPortal() {
  const tbody = document.getElementById('homePortalTableBody');
  tbody.innerHTML = homesPortalRows.length
    ? homesPortalRows.map(r => `
        <tr>
          <td><strong>${r.address}</strong></td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.lease}${r.rent ? ` — $${Number(r.rent).toLocaleString()}/mo` : ''}</td>
          <td>${r.maintenance || '<span style="color:var(--muted)">—</span>'}</td>
          <td>${r.notice || '<span style="color:var(--muted)">—</span>'}</td>
          <td>
            <button class="btn btn-sm" onclick="viewHomeDetail(${r.id})">View</button>
            <button class="btn btn-sm" onclick="editHomeRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteHomeRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="6"><div class="empty-state">No home listings yet. Click "Create Listing" to add one.</div></td></tr>`;
}

function openHomeModal(id = null) {
  const editing = id ? homesPortalRows.find(r => r.id === id) : null;
  document.getElementById('homeAddress').value = editing?.address || '';
  document.getElementById('homeStatus').value = editing?.status || 'occupied';
  document.getElementById('homeLease').value = editing?.lease || '';
  document.getElementById('homeRent').value = editing?.rent || '';
  document.getElementById('homeMaintenance').value = editing?.maintenance || '';
  document.getElementById('homeNotice').value = editing?.notice || '';
  document.getElementById('homeModalTitle').textContent = id ? 'Edit Home Listing' : 'Create Home Listing';
  document.getElementById('homeModal').dataset.editId = id || '';
  openModal('homeModal');
}
function submitHomeForm() {
  const address = document.getElementById('homeAddress').value.trim();
  if (!address) return showToast('Address is required.', 'error');
  const editId = parseInt(document.getElementById('homeModal').dataset.editId);
  const data = {
    address, status: document.getElementById('homeStatus').value,
    lease: document.getElementById('homeLease').value.trim(),
    rent: document.getElementById('homeRent').value,
    maintenance: document.getElementById('homeMaintenance').value.trim(),
    notice: document.getElementById('homeNotice').value.trim()
  };
  if (editId) {
    const r = homesPortalRows.find(x => x.id === editId);
    if (r) { Object.assign(r, data); addAuditEntry('edit', 'Admin', `Updated home listing — ${address}`); }
  } else {
    homesPortalRows.unshift({ id: nextId.home++, ...data });
    addAuditEntry('create', 'Admin', `Created home listing — ${address}`);
  }
  closeModal('homeModal');
  renderHomesPortal();
  showToast(editId ? 'Listing updated.' : 'Listing created.');
}
function editHomeRow(id) { openHomeModal(id); }
function deleteHomeRow(id) {
  openConfirm('Delete Listing', 'Remove this home listing?', () => {
    const r = homesPortalRows.find(x => x.id === id);
    const i = homesPortalRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Deleted home listing — ${r?.address}`); homesPortalRows.splice(i, 1); }
    renderHomesPortal();
    showToast('Listing deleted.');
  });
}
function viewHomeDetail(id) {
  const r = homesPortalRows.find(x => x.id === id);
  if (!r) return;
  document.getElementById('detailTitle').textContent = r.address;
  document.getElementById('detailBody').innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      ${[['Status', statusBadge(r.status)],['Lease', r.lease],['Rent', r.rent ? '$'+Number(r.rent).toLocaleString()+'/mo' : '—'],['Maintenance', r.maintenance||'—'],['Notice', r.notice||'—']].map(([k,v])=>`<tr><td style="padding:12px 0;font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);width:40%;border-bottom:1px solid var(--border);">${k}</td><td style="padding:12px 0;font-size:.85rem;border-bottom:1px solid var(--border);">${v}</td></tr>`).join('')}
    </table>`;
  openModal('detailOverlay');
}

// ══════════════════════════════════════════════
//  APARTMENTS PORTAL
// ══════════════════════════════════════════════
function renderApartmentsPortal() {
  const tbody = document.getElementById('apartmentPortalTableBody');
  tbody.innerHTML = apartmentPortalRows.length
    ? apartmentPortalRows.map(r => `
        <tr>
          <td><strong>${r.unit}</strong><br><small style="color:var(--muted)">${r.address}</small><br><small>${r.type}</small></td>
          <td>$${Number(r.price).toLocaleString()}</td>
          <td>$${Number(r.rent).toLocaleString()}/mo</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.announcement || '<span style="color:var(--muted)">—</span>'}</td>
          <td>${r.turnover || '<span style="color:var(--muted)">—</span>'}</td>
          <td>
            <button class="btn btn-sm" onclick="editAptRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAptRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="7"><div class="empty-state">No apartment units yet. Click "Add Unit" to create one.</div></td></tr>`;
}

function openUnitModal(id = null) {
  const editing = id ? apartmentPortalRows.find(r => r.id === id) : null;
  document.getElementById('unitName').value = editing?.unit || '';
  document.getElementById('unitAddress').value = editing?.address || '';
  document.getElementById('unitType').value = editing?.type || '';
  document.getElementById('unitPrice').value = editing?.price || '';
  document.getElementById('unitRent').value = editing?.rent || '';
  document.getElementById('unitStatus').value = editing?.status || 'vacant';
  document.getElementById('unitAnnouncement').value = editing?.announcement || '';
  document.getElementById('unitTurnover').value = editing?.turnover || '';
  document.getElementById('unitModalTitle').textContent = id ? 'Edit Unit' : 'Add Apartment Unit';
  document.getElementById('unitModal').dataset.editId = id || '';
  openModal('unitModal');
}
function submitUnitForm() {
  const unit = document.getElementById('unitName').value.trim();
  if (!unit) return showToast('Unit name is required.', 'error');
  const editId = parseInt(document.getElementById('unitModal').dataset.editId);
  const data = {
    unit, address: document.getElementById('unitAddress').value.trim(),
    type: document.getElementById('unitType').value.trim(),
    price: Number(document.getElementById('unitPrice').value),
    rent: Number(document.getElementById('unitRent').value),
    status: document.getElementById('unitStatus').value,
    announcement: document.getElementById('unitAnnouncement').value.trim(),
    turnover: document.getElementById('unitTurnover').value.trim()
  };
  if (editId) {
    const r = apartmentPortalRows.find(x => x.id === editId);
    if (r) { Object.assign(r, data); addAuditEntry('edit', 'Admin', `Updated unit — ${unit}`); }
  } else {
    apartmentPortalRows.unshift({ id: nextId.apt++, ...data });
    addAuditEntry('create', 'Admin', `Added apartment unit — ${unit}`);
  }
  closeModal('unitModal');
  renderApartmentsPortal();
  showToast(editId ? 'Unit updated.' : 'Unit created.');
}
function editAptRow(id) { openUnitModal(id); }
function deleteAptRow(id) {
  openConfirm('Delete Unit', 'Remove this apartment unit?', () => {
    const r = apartmentPortalRows.find(x => x.id === id);
    const i = apartmentPortalRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Deleted unit — ${r?.unit}`); apartmentPortalRows.splice(i, 1); }
    renderApartmentsPortal();
    showToast('Unit deleted.');
  });
}

// ══════════════════════════════════════════════
//  LEADS PORTAL
// ══════════════════════════════════════════════
const PIPELINE_STAGES = ['inquiry','qualified','showing','offer','closed'];
let leadsTableVisible = true;
function renderLeadsPipeline(){
  const board=document.getElementById('leadsPipelineBoard');
  if(!board) return;
  board.innerHTML = PIPELINE_STAGES.map(stage=>{
    const cards=leadsPortalRows.filter(r=>r.stage===stage);
    return `<div class="pipeline-col">
      <div class="pipeline-col-head">${stage.charAt(0).toUpperCase()+stage.slice(1)}<span>${cards.length}</span></div>
      ${cards.map(c=>`<div class="pipeline-card" onclick="openLeadModal(${c.id})">
        <div class="pipeline-card-name">${c.name}</div>
        <div class="pipeline-card-sub">${c.source||''}</div>
        <div style="margin-top:6px;">${timelineBadge(c.timeline)}</div>
      </div>`).join('')||'<div style="font-size:0.7rem;color:var(--muted);text-align:center;padding:12px;">Empty</div>'}
    </div>`;
  }).join('');
}
function toggleLeadsView(){
  leadsTableVisible=!leadsTableVisible;
  const el=document.getElementById('leadsTableCard');
  if(el) el.style.display=leadsTableVisible?'':'none';
}
function renderLeadsPortal(){
  const q=(document.getElementById('leadsSearch')?.value||'').toLowerCase();
  const tf=(document.getElementById('leadsTimelineFilter')?.value)||'all';
  let rows=leadsPortalRows.filter(r=>(tf==='all'||r.timeline===tf)&&(!q||JSON.stringify(r).toLowerCase().includes(q)));
  const tbody=document.getElementById('leadPortalTableBody');
  if(!tbody) return;
  tbody.innerHTML = rows.length
    ? rows.map(r => `<tr>
        <td><strong>${r.name}</strong></td>
        <td>${r.email?`<a href="mailto:${r.email}" style="color:var(--primary)">${r.email}</a>`:'—'}</td>
        <td>${r.source||'—'}</td>
        <td>${timelineBadge(r.timeline)}</td>
        <td>${r.preferences||'—'}</td>
        <td>${r.followup||'—'}</td>
        <td style="white-space:nowrap;">
          <button class="btn btn-sm" onclick="openLeadModal(${r.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="delLeadRow(${r.id})">Del</button>
        </td>
      </tr>`).join('')
    : `<tr><td colspan="7"><div class="empty-state">No leads yet. Add one above.</div></td></tr>`;
  renderLeadsPipeline();
}
function openLeadModal(id=null){
  const e=id?leadsPortalRows.find(r=>r.id===id):null;
  document.getElementById('portalLeadName').value=e?.name||'';
  document.getElementById('portalLeadEmail').value=e?.email||'';
  document.getElementById('portalLeadPhone').value=e?.phone||'';
  document.getElementById('portalLeadSource').value=e?.source||'';
  document.getElementById('portalLeadStage').value=e?.stage||'inquiry';
  document.getElementById('portalLeadTimeline').value=e?.timeline||'immediately';
  document.getElementById('portalLeadPrefs').value=e?.preferences||'';
  document.getElementById('portalLeadFollowup').value=e?.followup||'';
  document.getElementById('leadModalTitle').textContent=id?'Edit Lead':'Add Lead';
  document.getElementById('leadModal').dataset.editId=id||'';
  openModal('leadModal');
}
function submitLeadForm(){
  const name=document.getElementById('portalLeadName').value.trim();
  if(!name) return showToast('Lead name is required.','error');
  const eid=parseInt(document.getElementById('leadModal').dataset.editId);
  const data={
    name,
    email:document.getElementById('portalLeadEmail').value.trim(),
    phone:document.getElementById('portalLeadPhone').value.trim(),
    source:document.getElementById('portalLeadSource').value.trim(),
    stage:document.getElementById('portalLeadStage').value,
    timeline:document.getElementById('portalLeadTimeline').value,
    preferences:document.getElementById('portalLeadPrefs').value.trim(),
    followup:document.getElementById('portalLeadFollowup').value.trim()
  };
  if(eid){const r=leadsPortalRows.find(x=>x.id===eid);if(r)Object.assign(r,data);}
  else leadsPortalRows.unshift({id:nextId.lead++,...data});
  closeModal('leadModal');
  renderLeadsPortal();
  showToast(eid?'Lead updated.':'Lead added.');
}
function delLeadRow(id){
  openConfirm('Delete Lead','Remove this lead from the pipeline?',()=>{
    const i=leadsPortalRows.findIndex(r=>r.id===id);
    if(i>-1)leadsPortalRows.splice(i,1);
    renderLeadsPortal();
    showToast('Lead deleted.');
  });
}
function exportLeadsCSV(){
  const data=leadsPortalRows;
  if(!data.length) return showToast('No leads to export.','error');
  const k=['name','email','phone','source','stage','timeline','preferences','followup'];
  const csv=[k.join(','),...data.map(r=>k.map(k=>`"${r[k]||''}"`).join(','))].join('\n');
  const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);
  const a=document.createElement('a');a.href=u;a.download=`leads_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(u);
  showToast('Leads exported.');
}
function filterLeadsPortal(){ renderLeadsPortal(); }

// ══════════════════════════════════════════════
//  OPERATIONS PORTAL
// ══════════════════════════════════════════════
function renderOperationsPortal(){
  const sf=(document.getElementById('maintStatusFilter')?.value)||'all';
  const pf=(document.getElementById('maintPriorityFilter')?.value)||'all';
  let rows=operationsPortalRows.filter(r=>(sf==='all'||r.status===sf)&&(pf==='all'||r.priority===pf));
  const today=new Date();
  const tbody=document.getElementById('operationsPortalTableBody');
  if(!tbody) return;
  tbody.innerHTML=rows.length?rows.map(r=>{
    const overdue=r.due&&new Date(r.due)<today&&r.status!=='closed';
    return`<tr${overdue?' style="background:#fef8f8"':''}>
    <td><strong>${r.workOrder}</strong>${overdue?'<br><span style="font-size:0.62rem;color:var(--danger);font-weight:700">OVERDUE</span>':''}</td>
    <td>${priorityBadge(r.priority)}</td>
    <td>${statusBadge(r.status)}</td>
    <td>${r.serviceLevel||'—'}</td>
    <td>${r.preventive||'—'}</td>
    <td>${r.cost>0?'$'+Number(r.cost).toLocaleString():'—'}</td>
    <td>${r.assigned||'—'}</td>
    <td class="${overdue?'priority-high':''}">${r.due||'—'}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="openOpsModal(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delOpsRow(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state">No work orders yet.</div></td></tr>`;
}
function openOpsModal(id=null){
  const e=id?operationsPortalRows.find(r=>r.id===id):null;
  document.getElementById('opsWorkOrder').value=e?.workOrder||'';
  document.getElementById('opsPriority').value=e?.priority||'high';
  document.getElementById('opsStatus').value=e?.status||'open';
  document.getElementById('opsAssigned').value=e?.assigned||'';
  document.getElementById('opsDue').value=e?.due||'';
  document.getElementById('opsCost').value=e?.cost||'';
  document.getElementById('opsServiceLevel').value=e?.serviceLevel||'';
  document.getElementById('opsPreventive').value=e?.preventive||'';
  document.getElementById('opsModal').dataset.editId=id||'';
  openModal('opsModal');
}
function submitOpsForm(){
  const wo=document.getElementById('opsWorkOrder').value.trim();
  if(!wo) return showToast('Work order is required.','error');
  const eid=parseInt(document.getElementById('opsModal').dataset.editId);
  const data={workOrder:wo,priority:document.getElementById('opsPriority').value,status:document.getElementById('opsStatus').value,
    assigned:document.getElementById('opsAssigned').value.trim(),due:document.getElementById('opsDue').value,
    cost:Number(document.getElementById('opsCost').value)||0,serviceLevel:document.getElementById('opsServiceLevel').value.trim(),
    preventive:document.getElementById('opsPreventive').value.trim()};
  if(eid){const r=operationsPortalRows.find(x=>x.id===eid);if(r)Object.assign(r,data);}
  else{operationsPortalRows.push({id:nextId.ops++,...data});addAuditEntry('create','Admin',`New work order — ${wo}`);}
  closeModal('opsModal');
  renderOperationsPortal();
  showToast(eid?'Work order updated.':'Work order added.');
}
function delOpsRow(id){
  openConfirm('Delete Work Order','Remove this work order?',()=>{
    const i=operationsPortalRows.findIndex(r=>r.id===id);
    if(i>-1)operationsPortalRows.splice(i,1);
    renderOperationsPortal();
    showToast('Deleted.');
  });
}

// ══════════════════════════════════════════════
//  FINANCE HUB
// ══════════════════════════════════════════════
function renderCashFlowForecast() {
  const months = ['Mar','Apr','May','Jun','Jul','Aug'];
  const values = [138, 142, 156, 149, 163, 171];
  const maxVal = Math.max(...values);
  const grid = document.getElementById('cashFlowForecastGrid');
  if (!grid) return;
  grid.innerHTML = months.map((m, i) => {
    const pct = (values[i] / maxVal) * 100;
    const color = pct > 90 ? '#2e7d32' : pct > 70 ? '#c5a059' : '#c0392b';
    return `
      <div class="forecast-col">
        <div class="f-val">$${values[i]}K</div>
        <div class="forecast-bar-wrap">
          <div class="forecast-bar-fill" style="height:${pct}%;background:${color};"></div>
        </div>
        <div class="f-label">${m}</div>
      </div>`;
  }).join('');
}

function renderPLTable() {
  const tbody = document.getElementById('plTableBody');
  tbody.innerHTML = plRows.map(r => {
    const noi = r.revenue - r.expenses;
    const margin = ((noi / r.revenue) * 100).toFixed(1);
    return `<tr>
      <td><strong>${r.property}</strong></td>
      <td>$${r.revenue.toLocaleString()}</td>
      <td>$${r.expenses.toLocaleString()}</td>
      <td><strong style="color:${noi > 0 ? 'var(--success)' : 'var(--danger)'}">$${noi.toLocaleString()}</strong></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="progress-wrap" style="width:80px;"><div class="progress-bar ${r.occupancy > 85 ? 'success' : r.occupancy > 70 ? '' : 'danger'}" style="width:${r.occupancy}%"></div></div>
          <span style="font-size:0.72rem;">${r.occupancy}%</span>
        </div>
      </td>
      <td><span style="font-size:0.82rem;font-weight:700;color:${Number(margin) > 40 ? 'var(--success)' : 'var(--accent)'}">${margin}%</span></td>
    </tr>`;
  }).join('');
}

function openPLModal() { openModal('plModal'); }
function submitPLForm() {
  const property = document.getElementById('plProperty').value.trim();
  if (!property) return showToast('Property is required.', 'error');
  plRows.push({
    id: nextPLId++,
    property,
    revenue: Number(document.getElementById('plRevenue').value),
    expenses: Number(document.getElementById('plExpenses').value),
    occupancy: Number(document.getElementById('plOccupancy').value)
  });
  closeModal('plModal');
  renderPLTable();
  addAuditEntry('create', 'Admin', `Added P&L entry — ${property}`);
  showToast('P&L entry added.');
}

function renderCapexTable() {
  const tbody = document.getElementById('capexTableBody');
  tbody.innerHTML = capexRows.map(r => {
    const pct = Math.min((r.spent / r.budget) * 100, 100);
    const over = r.spent > r.budget;
    return `<tr>
      <td><strong>${r.item}</strong></td>
      <td>${r.property}</td>
      <td>$${r.budget.toLocaleString()}</td>
      <td style="color:${over ? 'var(--danger)' : 'var(--text)'}">$${r.spent.toLocaleString()}${over ? ' <span style="color:var(--danger);font-size:0.68rem;">OVER</span>' : ''}</td>
      <td>${statusBadge(r.status)}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteCapexRow(${r.id})">Remove</button>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="6"><div class="empty-state">No capex items.</div></td></tr>`;
}

function openCapexModal() { openModal('capexModal'); }
function submitCapexForm() {
  const item = document.getElementById('capexItem').value.trim();
  if (!item) return showToast('Item is required.', 'error');
  capexRows.push({
    id: nextCapexId++,
    item,
    property: document.getElementById('capexProperty').value.trim(),
    budget: Number(document.getElementById('capexBudget').value),
    spent: Number(document.getElementById('capexSpent').value) || 0,
    status: document.getElementById('capexStatus').value
  });
  closeModal('capexModal');
  renderCapexTable();
  addAuditEntry('create', 'Admin', `Added capex — ${item}`);
  showToast('Capex item added.');
}
function deleteCapexRow(id) {
  openConfirm('Remove Capex Item', 'Remove this item?', () => {
    const i = capexRows.findIndex(r => r.id === id);
    if (i > -1) capexRows.splice(i, 1);
    renderCapexTable();
    showToast('Item removed.');
  });
}

// ══════════════════════════════════════════════
//  AR & COLLECTIONS
// ══════════════════════════════════════════════
function daysOverdue(dueDateStr) {
  const due = new Date(dueDateStr);
  const today = new Date();
  const diff = Math.floor((today - due) / (1000 * 60 * 60 * 24));
  return diff > 0 ? diff : 0;
}

function renderARTable(rows = arRows) {
  const tbody = document.getElementById('arTableBody');
  tbody.innerHTML = rows.map(r => {
    const over = daysOverdue(r.dueDate);
    return `<tr>
      <td><strong>${r.tenant}</strong></td>
      <td>${r.unit}</td>
      <td>${r.type}</td>
      <td><strong>$${r.amount.toLocaleString()}</strong></td>
      <td>${r.dueDate}</td>
      <td>${statusBadge(r.status)}</td>
      <td>${r.status === 'overdue' ? `<span style="color:var(--danger);font-weight:700;">${over}d</span>` : '—'}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-sm" onclick="markARPaid(${r.id})">Mark Paid</button>
        <button class="btn btn-sm btn-danger" onclick="deleteARRow(${r.id})">Remove</button>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="8"><div class="empty-state">No invoices.</div></td></tr>`;
}
function filterAR() {
  const q = document.getElementById('arSearch').value.toLowerCase();
  renderARTable(arRows.filter(r => JSON.stringify(r).toLowerCase().includes(q)));
}
function openARModal(id = null) {
  const editing = id ? arRows.find(r => r.id === id) : null;
  document.getElementById('arTenant').value = editing?.tenant || '';
  document.getElementById('arUnit').value = editing?.unit || '';
  document.getElementById('arType').value = editing?.type || 'Rent';
  document.getElementById('arAmount').value = editing?.amount || '';
  document.getElementById('arDueDate').value = editing?.dueDate || '';
  document.getElementById('arStatus').value = editing?.status || 'pending';
  document.getElementById('arNotes').value = editing?.notes || '';
  document.getElementById('arModal').dataset.editId = id || '';
  openModal('arModal');
}
function submitARForm() {
  const tenant = document.getElementById('arTenant').value.trim();
  if (!tenant) return showToast('Tenant name is required.', 'error');
  const editId = parseInt(document.getElementById('arModal').dataset.editId);
  const data = {
    tenant, unit: document.getElementById('arUnit').value.trim(),
    type: document.getElementById('arType').value,
    amount: Number(document.getElementById('arAmount').value),
    dueDate: document.getElementById('arDueDate').value,
    status: document.getElementById('arStatus').value,
    notes: document.getElementById('arNotes').value.trim()
  };
  if (editId) {
    const r = arRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    arRows.unshift({ id: nextARId++, ...data });
    addAuditEntry('create', 'Admin', `New invoice — ${tenant} $${data.amount}`);
  }
  closeModal('arModal');
  renderARTable();
  showToast('Invoice saved.');
}
function markARPaid(id) {
  const r = arRows.find(x => x.id === id);
  if (r) { r.status = 'paid'; addAuditEntry('approve', 'Admin', `Marked invoice paid — ${r.tenant} $${r.amount}`); renderARTable(); showToast('Invoice marked as paid.'); }
}
function deleteARRow(id) {
  openConfirm('Remove Invoice', 'Remove this invoice?', () => {
    const r = arRows.find(x => x.id === id);
    const i = arRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Deleted invoice — ${r?.tenant}`); arRows.splice(i, 1); }
    renderARTable();
    showToast('Invoice removed.');
  });
}

// ══════════════════════════════════════════════
//  APPROVAL MATRIX
// ══════════════════════════════════════════════
function renderApprovalList() {
  const el = document.getElementById('approvalList');
  const pending = approvalRows.filter(r => r.status === 'pending');
  document.getElementById('pendingApprovals').textContent = pending.length;
  document.getElementById('pendingApprovalsCount').textContent = pending.length;
  el.innerHTML = pending.length
    ? pending.map(r => `
        <div class="approval-card">
          <div class="approval-meta">
            <h4>${r.title}</h4>
            <p>${r.type} · Requested by ${r.requester}${r.justification ? ' — ' + r.justification : ''}</p>
          </div>
          ${r.amount > 0 ? `<div class="approval-amount">$${r.amount.toLocaleString()}</div>` : ''}
          <div class="approval-actions">
            <button class="btn btn-sm btn-primary" onclick="resolveApproval(${r.id},'approved')">Approve</button>
            <button class="btn btn-sm btn-danger" onclick="resolveApproval(${r.id},'rejected')">Reject</button>
          </div>
        </div>`).join('')
    : `<div class="empty-state">All approvals cleared.</div>`;
}
function openApprovalModal() { openModal('approvalModal'); }
function submitApprovalForm() {
  const title = document.getElementById('approvalTitle').value.trim();
  if (!title) return showToast('Title is required.', 'error');
  approvalRows.unshift({
    id: nextApprovalId++,
    title,
    type: document.getElementById('approvalType').value,
    amount: Number(document.getElementById('approvalAmount').value) || 0,
    requester: document.getElementById('approvalRequester').value.trim(),
    justification: document.getElementById('approvalJustification').value.trim(),
    status: 'pending'
  });
  closeModal('approvalModal');
  renderApprovalList();
  addAuditEntry('create', 'Admin', `New approval request — ${title}`);
  showToast('Request submitted.');
}
function resolveApproval(id, decision) {
  const r = approvalRows.find(x => x.id === id);
  if (r) {
    r.status = decision;
    addAuditEntry('approve', 'Admin', `${decision === 'approved' ? 'Approved' : 'Rejected'} — ${r.title}${r.amount > 0 ? ' $'+r.amount.toLocaleString() : ''}`);
    renderApprovalList();
    showToast(`Request ${decision}.`);
  }
}

// ══════════════════════════════════════════════
//  AUDIT LOG
// ══════════════════════════════════════════════
function renderAuditLog(filter = 'all') {
  const el = document.getElementById('auditLogList');
  if (!el) return;
  const filtered = filter === 'all' ? auditLog : auditLog.filter(e => e.action === filter);
  el.innerHTML = filtered.length
    ? filtered.map(e => `
        <div class="audit-row">
          <div class="audit-dot ${e.action}"></div>
          <div class="audit-content">
            <div class="audit-action">${e.actor}</div>
            <div class="audit-detail">${e.detail}</div>
          </div>
          <div class="audit-time">${e.time}</div>
        </div>`).join('')
    : `<div class="empty-state">No entries for this filter.</div>`;
}
function filterAuditLog() {
  const filter = document.getElementById('auditFilter').value;
  renderAuditLog(filter);
}
function exportAuditCSV() {
  const csv = ['Action,Actor,Detail,Time', ...auditLog.map(e => `"${e.action}","${e.actor}","${e.detail}","${e.time}"`)].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'audit_log.csv'; a.click();
  URL.revokeObjectURL(url);
  showToast('Audit log exported.');
}

// ══════════════════════════════════════════════
//  LEASE INTELLIGENCE
// ══════════════════════════════════════════════
function daysToDate(dateStr) {
  const d = new Date(dateStr);
  const today = new Date();
  return Math.floor((d - today) / (1000 * 60 * 60 * 24));
}

function renderLeaseTable() {
  const tbody = document.getElementById('leaseTableBody');
  tbody.innerHTML = leaseRows.map(r => {
    const days = daysToDate(r.leaseEnd);
    const urgency = days < 30 ? 'badge-red' : days < 60 ? 'badge-gold' : 'badge-green';
    return `<tr>
      <td><strong>${r.tenant}</strong></td>
      <td>${r.unit}</td>
      <td>${r.leaseEnd}</td>
      <td><span class="badge ${urgency}">${days > 0 ? days + 'd' : 'Expired'}</span></td>
      <td>$${r.rent.toLocaleString()}/mo</td>
      <td>${r.escalation}</td>
      <td>${statusBadge(r.risk)}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-sm" onclick="editLeaseRow(${r.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteLeaseRow(${r.id})">Remove</button>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="8"><div class="empty-state">No leases.</div></td></tr>`;
}
function openLeaseModal(id = null) {
  const editing = id ? leaseRows.find(r => r.id === id) : null;
  document.getElementById('leaseTenant').value = editing?.tenant || '';
  document.getElementById('leaseUnit').value = editing?.unit || '';
  document.getElementById('leaseEnd').value = editing?.leaseEnd || '';
  document.getElementById('leaseRent').value = editing?.rent || '';
  document.getElementById('leaseEscalation').value = editing?.escalation || 'CPI';
  document.getElementById('leaseRisk').value = editing?.risk || 'Low';
  document.getElementById('leaseModalTitle').textContent = id ? 'Edit Lease' : 'Add Lease';
  document.getElementById('leaseModal').dataset.editId = id || '';
  openModal('leaseModal');
}
function submitLeaseForm() {
  const tenant = document.getElementById('leaseTenant').value.trim();
  if (!tenant) return showToast('Tenant is required.', 'error');
  const editId = parseInt(document.getElementById('leaseModal').dataset.editId);
  const data = {
    tenant, unit: document.getElementById('leaseUnit').value.trim(),
    leaseEnd: document.getElementById('leaseEnd').value,
    rent: Number(document.getElementById('leaseRent').value),
    escalation: document.getElementById('leaseEscalation').value,
    risk: document.getElementById('leaseRisk').value
  };
  if (editId) {
    const r = leaseRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    leaseRows.push({ id: nextLeaseId++, ...data });
    addAuditEntry('create', 'Admin', `Added lease — ${tenant} ${data.unit}`);
  }
  closeModal('leaseModal');
  renderLeaseTable();
  showToast(editId ? 'Lease updated.' : 'Lease added.');
}
function editLeaseRow(id) { openLeaseModal(id); }
function deleteLeaseRow(id) {
  openConfirm('Remove Lease', 'Remove this lease record?', () => {
    const i = leaseRows.findIndex(r => r.id === id);
    if (i > -1) leaseRows.splice(i, 1);
    renderLeaseTable();
    showToast('Lease removed.');
  });
}

// ══════════════════════════════════════════════
//  VENDOR CONTROL
// ══════════════════════════════════════════════
function renderVendorTable() {
  const tbody = document.getElementById('vendorTableBody');
  tbody.innerHTML = vendorRows.map(r => `<tr>
    <td><strong>${r.name}</strong></td>
    <td>${r.category}</td>
    <td>${statusBadge(r.compliance)}</td>
    <td>${r.activePOs}</td>
    <td>$${r.spendYTD.toLocaleString()}</td>
    <td>${statusBadge(r.sla)}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editVendorRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteVendorRow(${r.id})">Remove</button>
    </td>
  </tr>`).join('') || `<tr><td colspan="7"><div class="empty-state">No vendors.</div></td></tr>`;
}
function openVendorModal(id = null) {
  const editing = id ? vendorRows.find(r => r.id === id) : null;
  document.getElementById('vendorName').value = editing?.name || '';
  document.getElementById('vendorCategory').value = editing?.category || 'General';
  document.getElementById('vendorCompliance').value = editing?.compliance || 'Complete';
  document.getElementById('vendorSpend').value = editing?.spendYTD || '';
  document.getElementById('vendorSLA').value = editing?.sla || 'On Track';
  document.getElementById('vendorModal').dataset.editId = id || '';
  openModal('vendorModal');
}
function submitVendorForm() {
  const name = document.getElementById('vendorName').value.trim();
  if (!name) return showToast('Vendor name is required.', 'error');
  const editId = parseInt(document.getElementById('vendorModal').dataset.editId);
  const data = {
    name, category: document.getElementById('vendorCategory').value,
    compliance: document.getElementById('vendorCompliance').value,
    activePOs: 0,
    spendYTD: Number(document.getElementById('vendorSpend').value) || 0,
    sla: document.getElementById('vendorSLA').value
  };
  if (editId) {
    const r = vendorRows.find(x => x.id === editId);
    if (r) { data.activePOs = r.activePOs; Object.assign(r, data); }
  } else {
    vendorRows.push({ id: nextVendorId++, ...data });
    addAuditEntry('create', 'Admin', `Added vendor — ${name}`);
  }
  closeModal('vendorModal');
  renderVendorTable();
  showToast(editId ? 'Vendor updated.' : 'Vendor added.');
}
function editVendorRow(id) { openVendorModal(id); }
function deleteVendorRow(id) {
  openConfirm('Remove Vendor', 'Remove this vendor?', () => {
    const r = vendorRows.find(x => x.id === id);
    const i = vendorRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Removed vendor — ${r?.name}`); vendorRows.splice(i, 1); }
    renderVendorTable();
    showToast('Vendor removed.');
  });
}

function renderPOTable() {
  const tbody = document.getElementById('poTableBody');
  tbody.innerHTML = poRows.map(r => {
    const matched = r.po === 'Yes' && r.invoice === 'Yes' && r.completion === 'Yes';
    const partialMatch = (r.po === 'Yes' || r.invoice === 'Yes' || r.completion === 'Yes') && !matched;
    const matchStatus = matched ? 'badge-green' : partialMatch ? 'badge-gold' : 'badge-gray';
    const matchLabel = matched ? 'Full Match' : partialMatch ? 'Partial' : 'Pending';
    return `<tr>
      <td><strong>${r.poNum}</strong></td>
      <td>${r.vendor}</td>
      <td>$${r.amount.toLocaleString()}</td>
      <td>${r.po === 'Yes' ? '✓' : '—'}</td>
      <td>${r.invoice === 'Yes' ? '✓' : '—'}</td>
      <td>${r.completion === 'Yes' ? '✓' : '—'}</td>
      <td><span class="badge ${matchStatus}">${matchLabel}</span></td>
      <td>${matched ? `<button class="btn btn-sm btn-primary" onclick="payPO(${r.id})">Release Payment</button>` : `<span style="font-size:0.72rem;color:var(--muted)">Awaiting match</span>`}</td>
    </tr>`;
  }).join('') || `<tr><td colspan="8"><div class="empty-state">No purchase orders.</div></td></tr>`;
}
function openPOModal() { openModal('poModal'); }
function submitPOForm() {
  const vendor = document.getElementById('poVendor').value.trim();
  if (!vendor) return showToast('Vendor is required.', 'error');
  const num = `PO-${nextPONum++}`;
  poRows.push({
    id: nextPOId++,
    poNum: num,
    vendor,
    amount: Number(document.getElementById('poAmount').value),
    po: document.getElementById('poPO').value,
    invoice: document.getElementById('poInvoice').value,
    completion: document.getElementById('poCompletion').value
  });
  closeModal('poModal');
  renderPOTable();
  addAuditEntry('create', 'Admin', `New PO ${num} — ${vendor}`);
  showToast('PO created.');
}
function payPO(id) {
  const r = poRows.find(x => x.id === id);
  if (r) { addAuditEntry('approve', 'Admin', `Payment released — ${r.poNum} $${r.amount.toLocaleString()}`); showToast(`Payment released for ${r.poNum}.`); }
}

// ══════════════════════════════════════════════
//  TENANT 360
// ══════════════════════════════════════════════
function renderTenantTable(rows = tenantRows) {
  const tbody = document.getElementById('tenantTableBody');
  tbody.innerHTML = rows.map(r => `<tr>
    <td><strong>${r.name}</strong></td>
    <td>${r.unit}</td>
    <td style="font-size:0.72rem;">${r.leaseStart} → ${r.leaseEnd}</td>
    <td>${statusBadge(r.payHistory)}</td>
    <td>${r.tickets > 0 ? `<span style="color:${r.tickets > 2 ? 'var(--danger)':'var(--accent)'}">${r.tickets} open</span>` : '—'}</td>
    <td>${r.legal !== 'None' ? statusBadge(r.legal) : '—'}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editTenantRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteTenantRow(${r.id})">Remove</button>
    </td>
  </tr>`).join('') || `<tr><td colspan="7"><div class="empty-state">No tenants.</div></td></tr>`;
}
function filterTenants() {
  const q = document.getElementById('tenantSearch').value.toLowerCase();
  renderTenantTable(tenantRows.filter(r => JSON.stringify(r).toLowerCase().includes(q)));
}
function openTenantModal(id = null) {
  const editing = id ? tenantRows.find(r => r.id === id) : null;
  document.getElementById('tenantName').value = editing?.name || '';
  document.getElementById('tenantUnit').value = editing?.unit || '';
  document.getElementById('tenantLeaseStart').value = editing?.leaseStart || '';
  document.getElementById('tenantLeaseEnd').value = editing?.leaseEnd || '';
  document.getElementById('tenantPayHistory').value = editing?.payHistory || 'Good';
  document.getElementById('tenantTickets').value = editing?.tickets || 0;
  document.getElementById('tenantLegal').value = editing?.legal || 'None';
  document.getElementById('tenantModalTitle').textContent = id ? 'Edit Tenant' : 'Add Tenant';
  document.getElementById('tenantModal').dataset.editId = id || '';
  openModal('tenantModal');
}
function submitTenantForm() {
  const name = document.getElementById('tenantName').value.trim();
  if (!name) return showToast('Tenant name is required.', 'error');
  const editId = parseInt(document.getElementById('tenantModal').dataset.editId);
  const data = {
    name, unit: document.getElementById('tenantUnit').value.trim(),
    leaseStart: document.getElementById('tenantLeaseStart').value,
    leaseEnd: document.getElementById('tenantLeaseEnd').value,
    payHistory: document.getElementById('tenantPayHistory').value,
    tickets: Number(document.getElementById('tenantTickets').value),
    legal: document.getElementById('tenantLegal').value
  };
  if (editId) {
    const r = tenantRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    tenantRows.push({ id: nextTenantId++, ...data });
    addAuditEntry('create', 'Admin', `Added tenant — ${name}`);
  }
  closeModal('tenantModal');
  renderTenantTable();
  showToast(editId ? 'Tenant updated.' : 'Tenant added.');
}
function editTenantRow(id) { openTenantModal(id); }
function deleteTenantRow(id) {
  openConfirm('Remove Tenant', 'Remove this tenant record?', () => {
    const r = tenantRows.find(x => x.id === id);
    const i = tenantRows.findIndex(r => r.id === id);
    if (i > -1) { addAuditEntry('delete', 'Admin', `Removed tenant — ${r?.name}`); tenantRows.splice(i, 1); }
    renderTenantTable();
    showToast('Tenant removed.');
  });
}

// ══════════════════════════════════════════════
//  AI COPILOT
// ══════════════════════════════════════════════
const aiResponses = {
  'overdue': () => {
    const overdue = arRows.filter(r => r.status === 'overdue');
    if (!overdue.length) return 'No overdue invoices found.';
    return `Found ${overdue.length} overdue invoices:\n${overdue.map(r => `• ${r.tenant} — Unit ${r.unit} — $${r.amount.toLocaleString()} (${daysOverdue(r.dueDate)} days overdue)`).join('\n')}\n\nRecommendation: Send reminders to high-risk tenants and escalate those over 30 days.`;
  },
  'noi': () => {
    const total = plRows.reduce((s, r) => s + (r.revenue - r.expenses), 0);
    return `Net Operating Income (NOI) this quarter: $${total.toLocaleString()}\n\n${plRows.map(r => `• ${r.property}: $${(r.revenue - r.expenses).toLocaleString()}`).join('\n')}\n\nOverall portfolio margin: ${((total / plRows.reduce((s, r) => s + r.revenue, 0)) * 100).toFixed(1)}%`;
  },
  'leases': () => {
    const expiring = leaseRows.filter(r => daysToDate(r.leaseEnd) < 60 && daysToDate(r.leaseEnd) > 0);
    if (!expiring.length) return 'No leases expiring in the next 60 days.';
    return `${expiring.length} leases expiring within 60 days:\n${expiring.map(r => `• ${r.tenant} — Unit ${r.unit} — ${daysToDate(r.leaseEnd)} days left — Risk: ${r.risk}`).join('\n')}\n\nAction: Contact high-risk tenants immediately to begin renewal discussions.`;
  },
  'high-risk': () => {
    const risk = tenantRows.filter(r => r.payHistory === 'Poor' || r.legal !== 'None');
    return `${risk.length} high-risk tenants flagged:\n${risk.map(r => `• ${r.tenant} — Unit ${r.unit} — ${r.payHistory} payment history — Legal: ${r.legal}`).join('\n')}`;
  },
  'pending approvals': () => {
    const big = approvalRows.filter(r => r.status === 'pending' && r.amount >= 5000);
    if (!big.length) return 'No pending approvals above $5,000.';
    return `${big.length} approvals above $5,000:\n${big.map(r => `• ${r.title} — $${r.amount.toLocaleString()} — Requested by ${r.requester}`).join('\n')}`;
  },
  'vacancy': () => {
    const avg = plRows.reduce((s, r) => s + r.occupancy, 0) / plRows.length;
    const currentNOI = plRows.reduce((s, r) => s + (r.revenue - r.expenses), 0);
    const lostRevenue = plRows.reduce((s, r) => s + r.revenue * 0.05, 0);
    return `Current portfolio occupancy: ${avg.toFixed(1)}%\nCurrent NOI: $${currentNOI.toLocaleString()}\n\nIf vacancy increases by 5%, estimated revenue loss: $${lostRevenue.toFixed(0).toLocaleString()}\nEstimated new NOI: $${(currentNOI - lostRevenue).toFixed(0).toLocaleString()}\n\nRecommendation: Strengthen lease renewals and reduce average vacancy turnaround time.`;
  }
};

function matchAIPrompt(msg) {
  const m = msg.toLowerCase();
  if (m.includes('overdue')) return aiResponses['overdue']();
  if (m.includes('noi') || m.includes('net operating')) return aiResponses['noi']();
  if (m.includes('expir') || m.includes('lease')) return aiResponses['leases']();
  if (m.includes('high-risk') || m.includes('high risk')) return aiResponses['high-risk']();
  if (m.includes('approval') || m.includes('5,000') || m.includes('5000')) return aiResponses['pending approvals']();
  if (m.includes('vacanc') || m.includes('5%') || m.includes('impact')) return aiResponses['vacancy']();
  return `I understand you're asking about "${msg}". Here's what I found in your portfolio:\n\n• Total Properties: ${propertiesData.length || plRows.length}\n• Overdue Invoices: ${arRows.filter(r => r.status === 'overdue').length}\n• Pending Approvals: ${approvalRows.filter(r => r.status === 'pending').length}\n• Leases Expiring Soon: ${leaseRows.filter(r => daysToDate(r.leaseEnd) < 60 && daysToDate(r.leaseEnd) > 0).length}\n\nTry asking about overdue tenants, NOI, lease expirations, or approval requests.`;
}

function sendAIMessage() {
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if (!msg) return;
  addAIMessage(msg, 'user');
  input.value = '';
  setTimeout(() => {
    const response = matchAIPrompt(msg);
    addAIMessage(response, 'ai');
  }, 600);
}

function addAIMessage(text, type) {
  const container = document.getElementById('aiMessages');
  const div = document.createElement('div');
  div.className = `ai-msg ${type}`;
  div.style.whiteSpace = 'pre-wrap';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function sendQuickPrompt(btn) {
  document.getElementById('aiInput').value = btn.textContent;
  sendAIMessage();
}

// ══════════════════════════════════════════════
//  REGISTRATIONS (Leads from API)
// ══════════════════════════════════════════════
async function fetchLeads() {
  const loader = document.getElementById('loader');
  const tableContainer = document.getElementById('tableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Fetching registrations…';
  tableContainer.style.display = 'none';
  try {
    const response = await fetch('/api/admin/registrations');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    const data = await response.json();
    currentLeads = data;
    renderLeads(data);
    loader.style.display = 'none';
    tableContainer.style.display = 'block';
    updateStats();
    renderRecentActivity();
  } catch (err) {
    loader.innerHTML = 'Error loading registrations. Check server connection.';
    showToast('Failed to load registrations.', 'error');
  }
}

function renderLeads(data) {
  const head = document.getElementById('tableHead');
  const body = document.getElementById('tableBody');
  if (data.length === 0) {
    head.innerHTML = '';
    body.innerHTML = '<tr><td colspan="100%"><div class="empty-state">No registrations found yet.</div></td></tr>';
    return;
  }
  const keys = ['timestamp', 'First Name', 'Last Name', 'Email Address'];
  data.forEach(lead => { Object.keys(lead).forEach(k => { if (!keys.includes(k) && k !== 'timestamp') keys.push(k); }); });
  head.innerHTML = keys.map(k => `<th>${k.replace(/Address/g,'').replace(/[*?]/g,'').trim()}</th>`).join('');
  body.innerHTML = [...data].reverse().map(lead => `<tr>${keys.map(k => {
    let val = lead[k] || '—';
    if (k === 'timestamp') { const d = new Date(val); val = `<span class="timestamp">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`; }
    return `<td>${val}</td>`;
  }).join('')}</tr>`).join('');
}

let filteredLeads = [];
function filterRegistrations() {
  const q = document.getElementById('regSearch').value.toLowerCase();
  filteredLeads = currentLeads.filter(l => JSON.stringify(l).toLowerCase().includes(q));
  renderLeads(filteredLeads.length || q ? filteredLeads : currentLeads);
}

function exportCSV() {
  const data = filteredLeads.length ? filteredLeads : currentLeads;
  if (!data.length) return showToast('No data to export.', 'error');
  const keys = Object.keys(data[0]);
  const csv = [keys.join(','), ...data.map(r => keys.map(k => `"${r[k]||''}"`).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `leads_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported.');
}

// ══════════════════════════════════════════════
//  PROPERTIES
// ══════════════════════════════════════════════
async function fetchProperties() {
  const loader = document.getElementById('propertiesLoader');
  const table = document.getElementById('propertiesTableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Loading properties…';
  table.style.display = 'none';
  try {
    const response = await fetch('/api/properties');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    propertiesData = await response.json();
    renderProperties(propertiesData);
    loader.style.display = 'none';
    table.style.display = 'block';
    updateStats();
  } catch (error) {
    loader.innerHTML = 'Failed to load properties.';
    showToast('Failed to load properties.', 'error');
  }
}

function renderProperties(properties) {
  const body = document.getElementById('propertiesTableBody');
  body.innerHTML = properties.length ? properties.map(p => `
    <tr>
      <td><strong>${p.address}</strong></td>
      <td><span class="badge badge-gray">${p.property_type || '—'}</span></td>
      <td>${p.bedrooms} bd / ${p.bathrooms} ba</td>
      <td>${Number(p.sqft).toLocaleString()} sqft</td>
      <td><strong>$${Number(p.current_value).toLocaleString()}</strong></td>
      <td>${p.estimated_rent ? '$'+Number(p.estimated_rent).toLocaleString()+'/mo' : '—'}</td>
      <td>${p.year_built}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-sm" onclick="editProperty(${p.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProperty(${p.id})">Delete</button>
        <a href="property-detail.html?id=${p.id}" class="btn btn-sm">View</a>
      </td>
    </tr>`).join('')
    : `<tr><td colspan="8"><div class="empty-state">No properties found. Click "Add Property" to begin.</div></td></tr>`;
}

function filterProperties() {
  const q = document.getElementById('propertiesSearch').value.toLowerCase();
  renderProperties(propertiesData.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

function openPropertyModal(propertyId = null) {
  const form = document.getElementById('propertyForm');
  form.reset();
  document.getElementById('propertyId').value = '';
  document.getElementById('propertyModalTitle').textContent = 'Add New Property';
  if (propertyId) {
    const p = propertiesData.find(x => x.id === propertyId);
    if (p) {
      document.getElementById('propertyModalTitle').textContent = 'Edit Property';
      document.getElementById('propertyId').value = p.id;
      document.getElementById('address').value = p.address;
      document.getElementById('currentValue').value = p.current_value;
      document.getElementById('estimatedRent').value = p.estimated_rent || '';
      document.getElementById('sqft').value = p.sqft;
      document.getElementById('bedrooms').value = p.bedrooms;
      document.getElementById('bathrooms').value = p.bathrooms;
      document.getElementById('lotSize').value = p.lot_size || '';
      document.getElementById('propertyType').value = p.property_type;
      document.getElementById('yearBuilt').value = p.year_built;
      document.getElementById('projectSlug').value = p.project_slug;
      document.getElementById('purchasePrice').value = p.purchase_price || '';
      document.getElementById('lastSoldAt').value = p.last_sold_at || '';
    }
  }
  openModal('propertyModal');
}
function closePropertyModal() { closeModal('propertyModal'); }
function editProperty(id) { openPropertyModal(id); }

async function deleteProperty(id) {
  openConfirm('Delete Property', 'Permanently delete this property?', async () => {
    try {
      const r = await fetch(`/api/properties/${id}`, { method: 'DELETE' });
      if (!r.ok) throw new Error();
      await fetchProperties();
      showToast('Property deleted.');
    } catch { showToast('Failed to delete property.', 'error'); }
  });
}

async function submitPropertyForm() {
  const propertyId = document.getElementById('propertyId').value;
  const payload = {
    address: document.getElementById('address').value,
    current_value: parseInt(document.getElementById('currentValue').value),
    estimated_rent: parseInt(document.getElementById('estimatedRent').value) || 0,
    sqft: parseInt(document.getElementById('sqft').value),
    bedrooms: parseInt(document.getElementById('bedrooms').value),
    bathrooms: parseFloat(document.getElementById('bathrooms').value),
    lot_size: parseInt(document.getElementById('lotSize').value) || 0,
    property_type: document.getElementById('propertyType').value,
    year_built: parseInt(document.getElementById('yearBuilt').value),
    project_slug: document.getElementById('projectSlug').value,
    purchase_price: parseInt(document.getElementById('purchasePrice').value) || null,
    last_sold_at: document.getElementById('lastSoldAt').value || null
  };
  try {
    const url = propertyId ? `/api/properties/${propertyId}` : '/api/properties';
    const method = propertyId ? 'PATCH' : 'POST';
    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) throw new Error();
    closePropertyModal();
    await fetchProperties();
    addAuditEntry(propertyId ? 'edit' : 'create', 'Admin', `${propertyId ? 'Updated' : 'Added'} property — ${payload.address}`);
    showToast(propertyId ? 'Property updated.' : 'Property saved.');
  } catch { showToast('Failed to save property.', 'error'); }
}

// ══════════════════════════════════════════════
//  UNITS
// ══════════════════════════════════════════════
async function fetchUnits() {
  const loader = document.getElementById('unitsLoader');
  const table = document.getElementById('unitsTableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Loading units…';
  table.style.display = 'none';
  try {
    const response = await fetch('/api/units');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    unitsData = await response.json();
    renderUnits(unitsData);
    loader.style.display = 'none';
    table.style.display = 'block';
    updateStats();
  } catch (error) {
    loader.innerHTML = 'Failed to load units.';
    showToast('Failed to load units.', 'error');
  }
}

function renderUnits(units) {
  const body = document.getElementById('unitsTableBody');
  body.innerHTML = units.length ? units.map(unit => `
    <tr>
      <td><strong>${unit.unit}</strong></td>
      <td>${statusBadge(unit.status)}</td>
      <td>$${Number(unit.value).toLocaleString()}</td>
      <td>$${Number(unit.rent).toLocaleString()}/mo</td>
      <td>${unit.last_sold_at || '—'}</td>
      <td>
        <form class="inline-edit" data-id="${unit.id}" onsubmit="saveUnit(event, this)">
          <select name="status">
            <option value="occupied" ${unit.status==='occupied'?'selected':''}>Occupied</option>
            <option value="vacant" ${unit.status==='vacant'?'selected':''}>Vacant</option>
            <option value="listed" ${unit.status==='listed'?'selected':''}>Listed</option>
          </select>
          <input name="value" type="number" min="1" value="${unit.value}" required style="width:100px">
          <input name="rent" type="number" min="0" value="${unit.rent}" required style="width:90px">
          <button class="btn btn-primary btn-sm" type="submit">Save</button>
        </form>
      </td>
    </tr>`).join('')
    : `<tr><td colspan="6"><div class="empty-state">No units found.</div></td></tr>`;
}

async function saveUnit(event, form) {
  event.preventDefault();
  const id = form.dataset.id;
  const payload = { status: form.status.value, value: Number(form.value.value), rent: Number(form.rent.value) };
  try {
    const r = await fetch(`/api/units/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!r.ok) throw new Error();
    await fetchUnits();
    addAuditEntry('edit', 'Admin', `Updated unit ${id} status → ${payload.status}`);
    showToast('Unit updated.');
  } catch { showToast('Failed to update unit.', 'error'); }
}

// ══════════════════════════════════════════════
//  STATS & ACTIVITY
// ══════════════════════════════════════════════
function updateStats() {
  document.getElementById('totalLeads').textContent = currentLeads.length || '—';
  document.getElementById('totalProperties').textContent = propertiesData.length || '—';
  document.getElementById('totalUnits').textContent = unitsData.length || '—';
  const total = propertiesData.reduce((s,p) => s+(p.current_value||0),0) + unitsData.reduce((s,u) => s+(u.value||0),0);
  document.getElementById('portfolioValue').textContent = total > 0 ? '$'+(total/1e6).toFixed(1)+'M' : '—';
}

function renderRecentActivity() {
  const el = document.getElementById('recentActivityList');
  const items = [];
  if (currentLeads.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">📋 <strong>${currentLeads.length}</strong> registration${currentLeads.length>1?'s':''} on file</td></tr>`);
  if (propertiesData.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">🏠 <strong>${propertiesData.length}</strong> residential propert${propertiesData.length>1?'ies':'y'} tracked</td></tr>`);
  if (unitsData.length) {
    const vacant = unitsData.filter(u => u.status === 'vacant').length;
    items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">🏢 <strong>${unitsData.length}</strong> units — <strong>${vacant}</strong> vacant</td></tr>`);
  }
  if (leadsPortalRows.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">👥 <strong>${leadsPortalRows.length}</strong> pipeline lead${leadsPortalRows.length>1?'s':''}</td></tr>`);
  const overdueCount = arRows.filter(r => r.status === 'overdue').length;
  if (overdueCount) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;"><span style="color:var(--danger)">⚠️ <strong>${overdueCount}</strong> overdue invoice${overdueCount>1?'s':''} — action needed</span></td></tr>`);
  const pendingCount = approvalRows.filter(r => r.status === 'pending').length;
  if (pendingCount) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">✅ <strong>${pendingCount}</strong> approval${pendingCount>1?'s':''} waiting</td></tr>`);
  if (!items.length) { el.innerHTML = '<div class="empty-state">No recent activity data.</div>'; return; }
  el.outerHTML = `<div class="table-wrap"><table><tbody>${items.join('')}</tbody></table></div>`;
}

function refreshAll() {
  fetchLeads();
  fetchProperties();
  fetchUnits();
  showToast('Refreshing all data…');
}

// ══════════════════════════════════════════════
//  CLOSE MODALS ON OVERLAY CLICK
// ══════════════════════════════════════════════
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal(overlay.id);
  });
});

// ══════════════════════════════════════════════
//  KEYBOARD ESC CLOSE
// ══════════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active, .confirm-overlay.active').forEach(el => el.classList.remove('active'));
  }
});

// ══════════════════════════════════════════════
//  TENANT MANAGEMENT (Original)
// ══════════════════════════════════════════════
function renderTenants(){
  const q=(document.getElementById('tenantsSearch')?.value||'').toLowerCase();
  let rows=tenantsRows.filter(r=>!q||JSON.stringify(r).toLowerCase().includes(q));
  const today=new Date();
  const tbody=document.getElementById('tenantsTableBody');
  if(!tbody) return;
  tbody.innerHTML=rows.length?rows.map(r=>{
    const expiring=r.leaseEnd&&Math.round((new Date(r.leaseEnd)-today)/(1000*60*60*24))<=30&&Math.round((new Date(r.leaseEnd)-today)/(1000*60*60*24))>=0;
    return`<tr${expiring?' style="background:#fffbf0"':''}>
    <td><strong>${r.first} ${r.last}</strong>${expiring?'<br><span style="font-size:0.62rem;color:var(--warn);font-weight:700">LEASE EXPIRING SOON</span>':''}</td>
    <td>${r.unit||'—'}</td>
    <td>${r.email?`<a href="mailto:${r.email}" style="color:var(--primary)">${r.email}</a>`:'—'}</td>
    <td>${r.phone||'—'}</td>
    <td>${r.leaseStart||'—'}</td>
    <td class="${expiring?'priority-med':''}">${r.leaseEnd||'—'}</td>
    <td>$${Number(r.rent||0).toLocaleString()}/mo</td>
    <td>${statusBadge(r.status)}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="openTenantMgmtModal(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delTenantMgmt(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state">No tenants yet. Add one above.</div></td></tr>`;
  updateNoteSelectors();
}
function openTenantModal(id=null){
  // For Tenant 360 view (intelligence section)
  const editing = id ? tenantRows.find(r => r.id === id) : null;
  document.getElementById('tenantModalTitle').textContent = id ? 'Edit Tenant' : 'Add Tenant';
  document.getElementById('tenantModal').dataset.mode = 'tenant360';
  document.getElementById('tenantModal').dataset.editId = id || '';
  // check which mode we're in by looking at current active view
  const isOriginal = document.getElementById('view-tenants-view')?.classList.contains('active');
  if(isOriginal) { openTenantMgmtModal(id); return; }
  openModal('tenantModal');
}
function openTenantMgmtModal(id=null){
  const e=id?tenantsRows.find(r=>r.id===id):null;
  document.getElementById('tenantFirst').value=e?.first||'';
  document.getElementById('tenantLast').value=e?.last||'';
  document.getElementById('tenantEmail').value=e?.email||'';
  document.getElementById('tenantPhone').value=e?.phone||'';
  document.getElementById('tenantUnit').value=e?.unit||'';
  document.getElementById('tenantRent').value=e?.rent||'';
  document.getElementById('tenantLeaseStart').value=e?.leaseStart||'';
  document.getElementById('tenantLeaseEnd').value=e?.leaseEnd||'';
  document.getElementById('tenantEmergency').value=e?.emergency||'';
  document.getElementById('tenantStatus').value=e?.status||'active';
  document.getElementById('tenantNotes').value=e?.notes||'';
  document.getElementById('tenantModalTitle').textContent=id?'Edit Tenant':'Add Tenant';
  document.getElementById('tenantModal').dataset.mode='mgmt';
  document.getElementById('tenantModal').dataset.editId=id||'';
  openModal('tenantModal');
}
function submitTenantForm(){
  const mode=document.getElementById('tenantModal').dataset.mode;
  const eid=parseInt(document.getElementById('tenantModal').dataset.editId);
  if(mode==='mgmt'){
    const first=document.getElementById('tenantFirst').value.trim();
    if(!first) return showToast('First name required.','error');
    const data={first,last:document.getElementById('tenantLast').value.trim(),email:document.getElementById('tenantEmail').value.trim(),
      phone:document.getElementById('tenantPhone').value.trim(),unit:document.getElementById('tenantUnit').value.trim(),
      rent:Number(document.getElementById('tenantRent').value)||0,leaseStart:document.getElementById('tenantLeaseStart').value,
      leaseEnd:document.getElementById('tenantLeaseEnd').value,emergency:document.getElementById('tenantEmergency').value.trim(),
      status:document.getElementById('tenantStatus').value,notes:document.getElementById('tenantNotes').value.trim()};
    if(eid){const r=tenantsRows.find(x=>x.id===eid);if(r)Object.assign(r,data);}
    else tenantsRows.unshift({id:nextId.tenant++,...data});
    closeModal('tenantModal');renderTenants();showToast(eid?'Tenant updated.':'Tenant added.');
  } else {
    // Tenant 360 mode
    const name = document.getElementById('tenantFirst').value.trim() + ' ' + document.getElementById('tenantLast').value.trim();
    if(!name.trim()) return showToast('Tenant name is required.','error');
    const data = {
      name: name.trim(), unit: document.getElementById('tenantUnit').value.trim(),
      leaseStart: document.getElementById('tenantLeaseStart').value,
      leaseEnd: document.getElementById('tenantLeaseEnd').value,
      payHistory: 'Good', tickets: 0, legal: 'None'
    };
    if(eid){const r=tenantRows.find(x=>x.id===eid);if(r)Object.assign(r,data);}
    else{tenantRows.push({id:nextTenantId++,...data});addAuditEntry('create','Admin',`Added tenant — ${data.name}`);}
    closeModal('tenantModal');renderTenantTable();showToast(eid?'Tenant updated.':'Tenant added.');
  }
}
function delTenantMgmt(id){
  openConfirm('Delete Tenant','Remove this tenant record?',()=>{
    const i=tenantsRows.findIndex(r=>r.id===id);
    if(i>-1)tenantsRows.splice(i,1);
    renderTenants();showToast('Deleted.');
  });
}

// ══════════════════════════════════════════════
//  ROI CALCULATOR
// ══════════════════════════════════════════════
function calcROI(){
  const purchase=parseFloat(document.getElementById('roi_purchase')?.value)||0;
  const value=parseFloat(document.getElementById('roi_value')?.value)||0;
  const rent=parseFloat(document.getElementById('roi_rent')?.value)||0;
  const expenses=parseFloat(document.getElementById('roi_expenses')?.value)||0;
  const mortgage=parseFloat(document.getElementById('roi_mortgage')?.value)||0;
  const vacancy=parseFloat(document.getElementById('roi_vacancy')?.value)||0;
  const tax=parseFloat(document.getElementById('roi_tax')?.value)||0;
  const insurance=parseFloat(document.getElementById('roi_insurance')?.value)||0;
  const effRent=rent*(1-vacancy/100);
  const annualGross=effRent*12;
  const annualExp=expenses*12+tax+insurance;
  const noi=annualGross-annualExp;
  const annualCF=noi-(mortgage*12);
  const coc=purchase>0?(annualCF/purchase*100).toFixed(2)+'%':'—';
  const capRate=value>0?(noi/value*100).toFixed(2)+'%':'—';
  const gry=value>0?((annualGross/value)*100).toFixed(2)+'%':'—';
  const apprc=purchase>0?((value-purchase)/purchase*100).toFixed(2)+'%':'—';
  const roi=purchase>0?(((value-purchase)+annualCF)/purchase*100).toFixed(2)+'%':'—';
  const fmt=v=>'$'+Math.round(v).toLocaleString();
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.innerHTML=v;};
  set('roi_eff_rent','$'+effRent.toFixed(0)+'/mo');
  set('roi_gross',fmt(annualGross));
  set('roi_annual_exp',fmt(annualExp));
  set('roi_noi',fmt(noi));
  set('roi_cf',`<span style="color:${annualCF>=0?'var(--success)':'var(--danger)'}">${fmt(annualCF)}</span>`);
  set('roi_coc',coc);
  set('roi_caprate',capRate);
  set('roi_gryrld',gry);
  set('roi_apprc',apprc);
  set('roi_total',`<span style="color:var(--success)">${roi}</span>`);
}

// ══════════════════════════════════════════════
//  NOTES LOG
// ══════════════════════════════════════════════
function updateNoteSelectors(){
  const opts=['<option value="">Select property/unit…</option>',
    ...homesPortalRows.map(r=>`<option value="${r.address}">${r.address}</option>`),
    ...apartmentPortalRows.map(r=>`<option value="${r.unit}">${r.unit} — ${r.address}</option>`),
    ...tenantsRows.map(r=>`<option value="${r.first} ${r.last}">${r.first} ${r.last} (${r.unit||'tenant'})</option>`),
  ].join('');
  ['noteProperty','notesPropertyFilter'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      const prev=el.value;
      if(id==='notesPropertyFilter') el.innerHTML='<option value="all">All Properties</option>'+opts.replace('<option value="">Select property/unit…</option>','');
      else el.innerHTML=opts;
      el.value=prev;
    }
  });
}
function addNote(){
  const text=document.getElementById('noteText')?.value.trim();
  if(!text) return showToast('Enter a note first.','error');
  const prop=document.getElementById('noteProperty')?.value||'';
  notesRows.unshift({id:nextId.note++,text,property:prop,time:new Date().toISOString()});
  if(document.getElementById('noteText')) document.getElementById('noteText').value='';
  renderNotes();showToast('Note added.');
}
function renderNotes(){
  const filter=(document.getElementById('notesPropertyFilter')?.value)||'all';
  let rows=notesRows.filter(n=>filter==='all'||n.property===filter);
  const el=document.getElementById('notesList');
  if(!el) return;
  el.innerHTML=rows.length?rows.map(n=>`
    <div class="note-entry">
      <div class="note-header">
        <span class="note-author">${n.property||'General Portfolio'}</span>
        <span class="note-time">${new Date(n.time).toLocaleString()}</span>
      </div>
      <div class="note-text">${n.text}</div>
    </div>`).join(''):'<div class="empty-state">No notes yet. Write the first one above.</div>';
}

// ══════════════════════════════════════════════
//  VACANCY PIPELINE
// ══════════════════════════════════════════════
function renderVacancyView(){
  const VSTAGES=['vacant','marketing','showing','application','approved'];
  const today=new Date();
  const vac=document.getElementById('vac_vacant');const lst=document.getElementById('vac_listed');
  const apps=document.getElementById('vac_apps');const dom=document.getElementById('vac_dom');
  if(vac) vac.textContent=vacancyRows.filter(v=>v.stage==='vacant').length||unitsData.filter(u=>u.status==='vacant').length||'—';
  if(lst) lst.textContent=vacancyRows.filter(v=>v.stage==='marketing').length||'—';
  if(apps) apps.textContent=vacancyRows.reduce((s,v)=>s+(v.apps||0),0)||'—';
  const doms=vacancyRows.map(v=>{if(!v.since)return 0;return Math.round((today-new Date(v.since))/(1000*60*60*24));});
  if(dom) dom.textContent=doms.length?Math.round(doms.reduce((a,b)=>a+b,0)/doms.length)+'d':'—';
  const funnelEl=document.getElementById('vacancyFunnel');
  if(funnelEl){
    const maxS=vacancyRows.length||1;
    funnelEl.innerHTML=VSTAGES.map((s,i)=>{
      const cnt=vacancyRows.filter(v=>v.stage===s).length;
      const colors=['var(--primary)','#2d5e38','#4a8a5b','var(--accent)','var(--success)'];
      const pct=Math.round(cnt/maxS*100);
      return`<div class="funnel-stage">
        <div class="funnel-label" style="text-transform:capitalize">${s}</div>
        <div class="funnel-bar-wrap">
          <div class="funnel-bar" style="width:${pct||8}%;background:${colors[i]};min-width:40px;"><span>${cnt}</span></div>
        </div>
        <div class="funnel-count">${pct}%</div>
      </div>`;
    }).join('');
  }
  const tbody=document.getElementById('vacancyTableBody');
  if(tbody) tbody.innerHTML=vacancyRows.length?vacancyRows.map(r=>{
    const days=r.since?Math.round((today-new Date(r.since))/(1000*60*60*24)):0;
    return`<tr>
    <td><strong>${r.unit}</strong></td>
    <td>${r.since||'—'}</td>
    <td><strong>${days}</strong> days</td>
    <td>${statusBadge(r.stage)}</td>
    <td>${r.rent?'$'+Number(r.rent).toLocaleString()+'/mo':'—'}</td>
    <td>${r.showings||0}</td>
    <td>${r.apps||0}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="openVacancyModal(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delVacancyRow(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="8"><div class="empty-state">No vacancy records yet.</div></td></tr>`;
}
function openVacancyModal(id=null){
  const e=id?vacancyRows.find(r=>r.id===id):null;
  document.getElementById('vacUnit').value=e?.unit||'';
  document.getElementById('vacSince').value=e?.since||new Date().toISOString().split('T')[0];
  document.getElementById('vacRent').value=e?.rent||'';
  document.getElementById('vacStage').value=e?.stage||'vacant';
  document.getElementById('vacShowings').value=e?.showings||0;
  document.getElementById('vacApps').value=e?.apps||0;
  document.getElementById('vacancyModal').dataset.editId=id||'';
  openModal('vacancyModal');
}
function submitVacancyForm(){
  const unit=document.getElementById('vacUnit').value.trim();
  if(!unit) return showToast('Unit required.','error');
  const eid=parseInt(document.getElementById('vacancyModal').dataset.editId);
  const data={unit,since:document.getElementById('vacSince').value,rent:Number(document.getElementById('vacRent').value)||0,
    stage:document.getElementById('vacStage').value,showings:Number(document.getElementById('vacShowings').value)||0,
    apps:Number(document.getElementById('vacApps').value)||0};
  if(eid){const r=vacancyRows.find(x=>x.id===eid);if(r)Object.assign(r,data);}
  else vacancyRows.push({id:nextId.vac++,...data});
  closeModal('vacancyModal');renderVacancyView();showToast('Vacancy record saved.');
}
function delVacancyRow(id){
  openConfirm('Delete','Remove this vacancy record?',()=>{
    const i=vacancyRows.findIndex(r=>r.id===id);
    if(i>-1)vacancyRows.splice(i,1);
    renderVacancyView();showToast('Deleted.');
  });
}

// ══════════════════════════════════════════════
//  BADGE HELPERS (ensure these exist)
// ══════════════════════════════════════════════
function priorityBadge(p){
  const m={high:'priority-high',medium:'priority-med',low:'priority-low'};
  return `<span class="${m[p]||''}">▲ ${p}</span>`;
}
function timelineBadge(t){
  const m={'immediately':'badge-red','in 3 months':'badge-orange','in 6 months':'badge-gold','later':'badge-gray'};
  return `<span class="badge ${m[t]||'badge-gray'}">${t}</span>`;
}

// ══════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════
renderAdminPortal();
renderHomesPortal();
renderApartmentsPortal();
renderLeadsPortal();
renderOperationsPortal();
renderTenants();
renderNotes();
calcROI();
renderCashFlowForecast();
renderPLTable();
renderCapexTable();
renderARTable();
renderApprovalList();
renderAuditLog();
renderLeaseTable();
renderVendorTable();
renderPOTable();
renderTenantTable();
fetchLeads();
fetchProperties();
fetchUnits();
</script>
</body>
</html>
