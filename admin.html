<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Taiseel Development</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a3c22;
      --accent: #c5a059;
      --bg: #fcfcfc;
      --white: #ffffff;
      --text: #333;
      --muted: #999;
      --border: #eeeeee;
      --sidebar-w: 240px;
      --danger: #c0392b;
      --success: #2e7d32;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      display: flex;
      min-height: 100vh;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: var(--primary);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0;
      z-index: 200;
      transition: transform 0.3s ease;
    }
    .sidebar-brand {
      padding: 32px 28px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-brand h1 {
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--white);
    }
    .sidebar-brand span {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.4);
      letter-spacing: 2px;
    }
    .sidebar-nav { flex: 1; padding: 20px 0; }
    .nav-section-label {
      padding: 16px 28px 6px;
      font-size: 0.6rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.3);
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 28px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      text-decoration: none;
    }
    .nav-item:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .nav-item.active { color: var(--white); border-left-color: var(--accent); background: rgba(255,255,255,0.07); }
    .nav-item svg { opacity: 0.7; flex-shrink: 0; }
    .nav-item.active svg { opacity: 1; }
    .sidebar-footer {
      padding: 20px 28px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-footer a {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.72rem; font-weight: 600; letter-spacing: 1px;
      color: rgba(255,255,255,0.5); text-decoration: none;
      transition: color 0.2s;
    }
    .sidebar-footer a:hover { color: var(--white); }

    /* ── MOBILE SIDEBAR TOGGLE ── */
    .sidebar-toggle {
      display: none;
      position: fixed; top: 16px; left: 16px; z-index: 300;
      background: var(--primary); color: white;
      border: none; border-radius: 8px;
      width: 40px; height: 40px;
      cursor: pointer; align-items: center; justify-content: center;
    }
    .sidebar-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 199;
    }

    /* ── MAIN ── */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    .topbar-title { font-size: 0.85rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .page-content { padding: 40px; flex: 1; }

    /* ── BUTTONS ── */
    .btn {
      padding: 10px 20px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text);
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.25s;
      border-radius: 8px;
      text-decoration: none;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { border-color: var(--primary); color: var(--primary); }
    .btn-primary { background: var(--primary); color: var(--white); border-color: var(--primary); }
    .btn-primary:hover { background: #15311b; color: var(--white); }
    .btn-accent { background: var(--accent); color: var(--white); border-color: var(--accent); }
    .btn-accent:hover { background: #b08f4a; color: var(--white); }
    .btn-danger { background: transparent; color: var(--danger); border-color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.65rem; letter-spacing: 1px; }
    .btn-icon { padding: 8px; border-radius: 8px; }

    /* ── VIEWS (pages) ── */
    .view { display: none; }
    .view.active { display: block; }

    /* ── STATS GRID ── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 36px;
    }
    .stat-card {
      background: var(--white);
      padding: 28px 32px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      transition: transform 0.25s, box-shadow 0.25s;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.07); }
    .stat-card::before {
      content: ''; position: absolute; top: 0; left: 0;
      width: 3px; height: 100%; background: var(--accent);
    }
    .stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 2.2rem; font-weight: 300; color: var(--primary); }
    .stat-delta { font-size: 0.7rem; color: var(--success); margin-top: 4px; }

    /* ── SECTION CARD ── */
    .section-card {
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      margin-bottom: 28px;
      overflow: hidden;
    }
    .section-header {
      padding: 22px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .section-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--primary);
    }
    .section-header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* ── TABLE ── */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; text-align: left; }
    th {
      background: #f9f9f9;
      padding: 14px 24px;
      font-size: 0.67rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    td {
      padding: 16px 24px;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
      color: #555;
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .timestamp { font-size: 0.72rem; color: var(--muted); }

    /* ── BADGES ── */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .badge-green { background: #e9f5ed; color: var(--success); }
    .badge-gold { background: #fef9ec; color: #b08f4a; }
    .badge-blue { background: #e8f4fd; color: #1565c0; }
    .badge-gray { background: #f3f3f3; color: #777; }
    .badge-red { background: #fdecea; color: var(--danger); }

    /* ── FORMS ── */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      padding: 24px 32px;
      background: #fafafa;
      border-bottom: 1px solid var(--border);
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label {
      font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; color: var(--muted);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.82rem;
      background: var(--white);
      color: var(--text);
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-actions { padding: 16px 32px 24px; display: flex; gap: 10px; flex-wrap: wrap; }

    /* ── MODAL ── */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 500;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: var(--white);
      border-radius: 20px;
      width: 90%; max-width: 760px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: 0 24px 80px rgba(0,0,0,0.25);
      animation: modalIn 0.25s ease;
    }
    @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-head {
      padding: 28px 36px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--white); z-index: 1;
    }
    .modal-head h2 { font-size: 1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
    .modal-close { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 22px; line-height: 1; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
    .modal-close:hover { background: var(--border); color: var(--text); }
    .modal-body { padding: 32px 36px; }
    .modal-body .form-grid { padding: 0; background: none; border: none; }
    .modal-footer { padding: 20px 36px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

    /* ── LOADER ── */
    .loader-row {
      padding: 48px;
      text-align: center;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 0.72rem;
    }
    .spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── SEARCH BAR ── */
    .search-bar {
      position: relative; display: flex; align-items: center;
    }
    .search-bar input {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px 8px 34px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.78rem;
      width: 200px;
      transition: border-color 0.2s, width 0.3s;
    }
    .search-bar input:focus { outline: none; border-color: var(--primary); width: 260px; }
    .search-bar svg { position: absolute; left: 10px; pointer-events: none; }

    /* ── PORTAL CARDS ── */
    .portal-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 24px 32px;
    }
    .portal-info-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      background: var(--white);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .portal-info-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.06); transform: translateY(-2px); }
    .portal-info-card h3 { font-size: 0.78rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; color: var(--primary); }
    .portal-info-card p { color: #777; font-size: 0.78rem; margin-bottom: 10px; line-height: 1.5; }
    .portal-info-card ul { margin-left: 14px; color: #666; font-size: 0.75rem; }
    .portal-info-card li { margin-bottom: 4px; }

    /* ── INLINE EDIT FORM ── */
    .inline-edit { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .inline-edit input, .inline-edit select {
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 8px; font: inherit; font-size: 0.75rem;
      width: auto;
    }

    /* ── TOAST ── */
    #toast {
      position: fixed; bottom: 32px; right: 32px;
      background: var(--primary); color: white;
      padding: 14px 22px; border-radius: 10px;
      font-size: 0.78rem; font-weight: 600; letter-spacing: 1px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      transform: translateY(80px); opacity: 0;
      transition: all 0.3s ease; z-index: 999;
      max-width: 320px;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.error { background: var(--danger); }

    /* ── EMPTY STATE ── */
    .empty-state { padding: 48px; text-align: center; color: var(--muted); font-size: 0.82rem; }
    .empty-state svg { margin-bottom: 12px; opacity: 0.3; }

    /* ── TABS ── */
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); padding: 0 32px; }
    .tab-btn {
      padding: 14px 20px;
      font-size: 0.72rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
      background: none; border: none; cursor: pointer; color: var(--muted);
      border-bottom: 2px solid transparent; margin-bottom: -1px;
      transition: all 0.2s;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-btn:hover:not(.active) { color: var(--text); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ── CONFIRM POPUP ── */
    .confirm-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.4); z-index: 600;
      align-items: center; justify-content: center;
    }
    .confirm-overlay.active { display: flex; }
    .confirm-box {
      background: var(--white); border-radius: 16px;
      padding: 36px; max-width: 380px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      text-align: center; animation: modalIn 0.2s ease;
    }
    .confirm-box h3 { font-size: 1rem; font-weight: 700; margin-bottom: 10px; color: var(--text); }
    .confirm-box p { color: var(--muted); font-size: 0.82rem; margin-bottom: 24px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }

    /* ── DETAIL POPUP ── */
    .detail-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 500;
      align-items: center; justify-content: center;
    }
    .detail-overlay.active { display: flex; }
    .detail-box {
      background: var(--white);
      border-radius: 20px;
      width: 90%; max-width: 600px;
      max-height: 85vh; overflow-y: auto;
      box-shadow: 0 24px 80px rgba(0,0,0,0.25);
      animation: modalIn 0.25s ease;
    }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.open { display: block; }
      .sidebar-toggle { display: flex; }
      .main { margin-left: 0; }
      .topbar { padding: 0 20px 0 60px; }
      .page-content { padding: 24px 20px; }
      .section-header { padding: 18px 20px; }
      th, td { padding: 12px 16px; }
      .form-grid { padding: 18px 20px; }
      .form-actions { padding: 12px 20px 18px; }
      .portal-overview { padding: 18px 20px; }
      .tabs { padding: 0 20px; }
      .modal-body { padding: 24px; }
      .modal-head, .modal-footer { padding: 20px 24px; }
    }
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .topbar-title { display: none; }
    }
  </style>
</head>
<body>

<!-- Sidebar Toggle (mobile) -->
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Menu">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h1>Taiseel</h1>
    <span>Management Portal</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Overview</div>
    <a class="nav-item active" onclick="showView('overview')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>

    <div class="nav-section-label">Portals</div>
    <a class="nav-item" onclick="showView('admin-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg>
      Admin Portal
    </a>
    <a class="nav-item" onclick="showView('homes-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>
      Individual Homes
    </a>
    <a class="nav-item" onclick="showView('apartments-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h2v2H9zm4 0h2v2h-2zm-4 4h2v2H9zm4 0h2v2h-2z"/></svg>
      Apartments
    </a>
    <a class="nav-item" onclick="showView('leads-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Leads
    </a>
    <a class="nav-item" onclick="showView('operations-portal')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
      Operations
    </a>

    <div class="nav-section-label">Data</div>
    <a class="nav-item" onclick="showView('properties-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Properties
    </a>
    <a class="nav-item" onclick="showView('units-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
      Building Units
    </a>
    <a class="nav-item" onclick="showView('registrations-view')" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Registrations
    </a>
  </nav>
  <div class="sidebar-footer">
    <a href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      View Public Site
    </a>
  </div>
</aside>

<!-- Main Content -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <span class="topbar-title" id="topbarTitle">Dashboard</span>
    </div>
    <div class="topbar-right">
      <button onclick="refreshAll()" class="btn btn-sm">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
        Refresh All
      </button>
    </div>
  </header>

  <div class="page-content">

    <!-- ════ DASHBOARD ════ -->
    <div class="view active" id="view-overview">
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Total Leads</span>
          <div class="stat-value" id="totalLeads">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Total Properties</span>
          <div class="stat-value" id="totalProperties">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Total Units</span>
          <div class="stat-value" id="totalUnits">—</div>
        </div>
        <div class="stat-card">
          <span class="stat-label">Portfolio Value</span>
          <div class="stat-value" id="portfolioValue">—</div>
        </div>
      </div>

      <!-- Portal Overview Cards -->
      <div class="section-card">
        <div class="section-header"><h2>Property Management Portals</h2></div>
        <div class="portal-overview">
          <div class="portal-info-card">
            <h3>1. Admin Portal</h3>
            <p>Portfolio command center.</p>
            <ul><li>Portfolio-level reports</li><li>Workflow management</li><li>Cross-portal monitoring</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>2. Individual Homes</h3>
            <p>Single-home operations and resident lifecycle.</p>
            <ul><li>Lease/rent or sold status</li><li>Create property listing</li><li>Maintenance and notices</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>3. Apartment Portal</h3>
            <p>Multi-unit inventory and occupancy operations.</p>
            <ul><li>Create unit with address/type/price/rent</li><li>Vacant/listed/occupied status</li><li>Announcements and turnover</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>4. Leads Portal</h3>
            <p>Track source, qualification, and timelines.</p>
            <ul><li>Lead source + qualification details</li><li>Preferences and priorities</li><li>Follow-up pipeline</li></ul>
          </div>
          <div class="portal-info-card">
            <h3>5. Operations Portal</h3>
            <p>Service execution and preventive management.</p>
            <ul><li>Work order assignment</li><li>Service-level tracking</li><li>Preventive maintenance logs</li></ul>
          </div>
        </div>
      </div>

      <!-- Quick Activity Summary -->
      <div class="section-card">
        <div class="section-header"><h2>Recent Activity</h2></div>
        <div id="recentActivityList" class="loader-row"><span class="spinner"></span> Loading…</div>
      </div>
    </div>

    <!-- ════ ADMIN PORTAL ════ -->
    <div class="view" id="view-admin-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Admin Portal — Portfolio Reports</h2>
          <button class="btn btn-accent btn-sm" onclick="openAdminModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Report
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Portfolio-Level Report</th><th>Workflow</th><th>Cross-Portal Monitoring</th><th>Actions</th></tr></thead>
            <tbody id="adminPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ HOMES PORTAL ════ -->
    <div class="view" id="view-homes-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Individual Homes Portal</h2>
          <button class="btn btn-accent btn-sm" onclick="openHomeModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Create Listing
          </button>
        </div>
        <p style="padding:0 32px 16px;font-size:0.78rem;color:var(--muted);">Includes lease details and rent/sold status, listing creation, maintenance requests, and notices.</p>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Address</th><th>Status</th><th>Lease / Rent</th><th>Maintenance</th><th>Notice</th><th>Actions</th></tr></thead>
            <tbody id="homePortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ APARTMENTS PORTAL ════ -->
    <div class="view" id="view-apartments-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Apartment Portal</h2>
          <button class="btn btn-accent btn-sm" onclick="openUnitModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Unit
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Unit / Address / Type</th><th>Price</th><th>Rent</th><th>Status</th><th>Announcement</th><th>Turnover</th><th>Actions</th></tr></thead>
            <tbody id="apartmentPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ LEADS PORTAL ════ -->
    <div class="view" id="view-leads-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Leads Portal</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="leadsSearch" placeholder="Search leads…" oninput="filterLeadsPortal()">
            </div>
            <button class="btn btn-accent btn-sm" onclick="openLeadModal()">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Lead
            </button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Lead</th><th>Source / Qualification</th><th>Timeline</th><th>Preferences / Priorities</th><th>Follow-up Pipeline</th><th>Actions</th></tr></thead>
            <tbody id="leadPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ OPERATIONS PORTAL ════ -->
    <div class="view" id="view-operations-portal">
      <div class="section-card">
        <div class="section-header">
          <h2>Operations Portal</h2>
          <button class="btn btn-accent btn-sm" onclick="openOpsModal()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Work Order
          </button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Work Order Assignment</th><th>Service-Level Tracking</th><th>Preventive Maintenance Logs</th><th>Actions</th></tr></thead>
            <tbody id="operationsPortalTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ PROPERTIES ════ -->
    <div class="view" id="view-properties-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Residential Properties</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="propertiesSearch" placeholder="Search properties…" oninput="filterProperties()">
            </div>
            <button onclick="openPropertyModal()" class="btn btn-accent btn-sm">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Property
            </button>
            <button onclick="fetchProperties()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="propertiesLoader" class="loader-row"><span class="spinner"></span> Loading properties…</div>
        <div class="table-wrap" id="propertiesTableContainer" style="display:none;">
          <table>
            <thead><tr><th>Address</th><th>Type</th><th>Beds / Baths</th><th>Sqft</th><th>Current Value</th><th>Est. Rent</th><th>Year Built</th><th>Actions</th></tr></thead>
            <tbody id="propertiesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ UNITS ════ -->
    <div class="view" id="view-units-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Building Units</h2>
          <div class="section-header-actions">
            <a href="palm-central-private-residences.html#valuation" class="btn btn-sm">Open Listing</a>
            <button onclick="fetchUnits()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="unitsLoader" class="loader-row"><span class="spinner"></span> Loading units…</div>
        <div class="table-wrap" id="unitsTableContainer" style="display:none;">
          <table>
            <thead><tr><th>Unit</th><th>Status</th><th>Value</th><th>Rent</th><th>Last Sold</th><th>Update</th></tr></thead>
            <tbody id="unitsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════ REGISTRATIONS ════ -->
    <div class="view" id="view-registrations-view">
      <div class="section-card">
        <div class="section-header">
          <h2>Registrations</h2>
          <div class="section-header-actions">
            <div class="search-bar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="regSearch" placeholder="Search registrations…" oninput="filterRegistrations()">
            </div>
            <button onclick="exportCSV()" class="btn btn-sm">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export CSV
            </button>
            <button onclick="fetchLeads()" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="loader" class="loader-row"><span class="spinner"></span> Fetching registrations…</div>
        <div class="table-wrap" id="tableContainer" style="display:none;">
          <table>
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /page-content -->
</div><!-- /main -->

<!-- Toast -->
<div id="toast"></div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmMsg">This action cannot be undone.</p>
    <div class="confirm-actions">
      <button class="btn" onclick="closeConfirm(false)">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn" onclick="closeConfirm(true)">Delete</button>
    </div>
  </div>
</div>

<!-- ════ MODALS ════ -->

<!-- Property Modal -->
<div class="modal-overlay" id="propertyModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="propertyModalTitle">Add New Property</h2>
      <button class="modal-close" onclick="closeModal('propertyModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="propertyForm">
        <input type="hidden" id="propertyId">
        <div class="form-grid">
          <div class="form-group full"><label>Address *</label><input type="text" id="address" required></div>
          <div class="form-group"><label>Current Value ($) *</label><input type="number" id="currentValue" min="1" required></div>
          <div class="form-group"><label>Estimated Rent ($/mo)</label><input type="number" id="estimatedRent" min="0"></div>
          <div class="form-group"><label>Square Feet *</label><input type="number" id="sqft" min="1" required></div>
          <div class="form-group"><label>Bedrooms *</label><input type="number" id="bedrooms" min="0" required></div>
          <div class="form-group"><label>Bathrooms *</label><input type="number" id="bathrooms" min="0" step="0.5" required></div>
          <div class="form-group"><label>Lot Size (sqft)</label><input type="number" id="lotSize" min="0"></div>
          <div class="form-group"><label>Property Type *</label>
            <select id="propertyType" required>
              <option value="">Select Type</option>
              <option value="Single Family">Single Family</option>
              <option value="Condo">Condo</option>
              <option value="Townhouse">Townhouse</option>
              <option value="Multi-Family">Multi-Family</option>
              <option value="Land">Land</option>
            </select>
          </div>
          <div class="form-group"><label>Year Built *</label><input type="number" id="yearBuilt" min="1800" max="2030" required></div>
          <div class="form-group"><label>Project Slug *</label>
            <select id="projectSlug" required>
              <option value="">Select Project</option>
              <option value="palm-central-private-residences">Palm Central</option>
              <option value="the-heights-residences">The Heights</option>
              <option value="brilliant-tower">Brilliant Tower</option>
              <option value="inzovu-mall">Inzovu Mall</option>
              <option value="kigali-heights">Kigali Heights</option>
            </select>
          </div>
          <div class="form-group"><label>Purchase Price ($)</label><input type="number" id="purchasePrice" min="0"></div>
          <div class="form-group"><label>Last Sold Date</label><input type="date" id="lastSoldAt"></div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('propertyModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitPropertyForm()">Save Property</button>
    </div>
  </div>
</div>

<!-- Home Listing Modal -->
<div class="modal-overlay" id="homeModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="homeModalTitle">Create Home Listing</h2>
      <button class="modal-close" onclick="closeModal('homeModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Home Address *</label><input type="text" id="homeAddress"></div>
        <div class="form-group"><label>Status</label>
          <select id="homeStatus">
            <option value="occupied">Occupied</option>
            <option value="vacancy">Vacancy</option>
            <option value="listed">Listed</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div class="form-group"><label>Lease Details *</label><input type="text" id="homeLease"></div>
        <div class="form-group"><label>Rent Price ($)</label><input type="number" id="homeRent" min="0"></div>
        <div class="form-group full"><label>Maintenance Request</label><input type="text" id="homeMaintenance"></div>
        <div class="form-group full"><label>Notice</label><input type="text" id="homeNotice"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('homeModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitHomeForm()">Create Listing</button>
    </div>
  </div>
</div>

<!-- Apartment Unit Modal -->
<div class="modal-overlay" id="unitModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="unitModalTitle">Add Apartment Unit</h2>
      <button class="modal-close" onclick="closeModal('unitModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Unit *</label><input type="text" id="unitName"></div>
        <div class="form-group"><label>Address *</label><input type="text" id="unitAddress"></div>
        <div class="form-group"><label>Type *</label><input type="text" id="unitType"></div>
        <div class="form-group"><label>Price ($) *</label><input type="number" id="unitPrice" min="0"></div>
        <div class="form-group"><label>Rent Price ($) *</label><input type="number" id="unitRent" min="0"></div>
        <div class="form-group"><label>Status</label>
          <select id="unitStatus">
            <option value="vacant">Vacant</option>
            <option value="listed">Listed</option>
            <option value="occupied">Occupied</option>
          </select>
        </div>
        <div class="form-group full"><label>Building Announcement</label><input type="text" id="unitAnnouncement"></div>
        <div class="form-group full"><label>Turnover Tracking</label><input type="text" id="unitTurnover"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitUnitForm()">Create Unit</button>
    </div>
  </div>
</div>

<!-- Lead Modal -->
<div class="modal-overlay" id="leadModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="leadModalTitle">Add Lead</h2>
      <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Lead Name *</label><input type="text" id="portalLeadName"></div>
        <div class="form-group full"><label>Source / Qualification Details *</label><input type="text" id="portalLeadSource"></div>
        <div class="form-group"><label>Timeline</label>
          <select id="portalLeadTimeline">
            <option value="immediately">Immediately</option>
            <option value="in 3 months">In 3 months</option>
            <option value="in 6 months">In 6 months</option>
            <option value="later">Later</option>
          </select>
        </div>
        <div class="form-group"><label>Preferences & Priorities *</label><input type="text" id="portalLeadPrefs"></div>
        <div class="form-group full"><label>Follow-up Pipeline Step *</label><input type="text" id="portalLeadFollowup"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('leadModal')">Cancel</button>
      <button class="btn btn-accent" onclick="submitLeadForm()">Add Lead</button>
    </div>
  </div>
</div>

<!-- Admin Report Modal -->
<div class="modal-overlay" id="adminModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Add Portfolio Report</h2>
      <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Portfolio-Level Report *</label><input type="text" id="adminReport"></div>
        <div class="form-group full"><label>Workflow</label><input type="text" id="adminWorkflow"></div>
        <div class="form-group full"><label>Cross-Portal Monitoring</label><input type="text" id="adminMonitoring"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('adminModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAdminForm()">Add Report</button>
    </div>
  </div>
</div>

<!-- Operations Modal -->
<div class="modal-overlay" id="opsModal">
  <div class="modal-box">
    <div class="modal-head">
      <h2>Add Work Order</h2>
      <button class="modal-close" onclick="closeModal('opsModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label>Work Order Assignment *</label><input type="text" id="opsWorkOrder"></div>
        <div class="form-group full"><label>Service-Level Tracking</label><input type="text" id="opsServiceLevel"></div>
        <div class="form-group full"><label>Preventive Maintenance Log</label><input type="text" id="opsPreventive"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('opsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitOpsForm()">Add Work Order</button>
    </div>
  </div>
</div>

<!-- Detail View Popup -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-box">
    <div class="modal-head">
      <h2 id="detailTitle">Detail View</h2>
      <button class="modal-close" onclick="closeModal('detailOverlay')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('detailOverlay')">Close</button></div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════
let currentLeads = [];
let propertiesData = [];
let unitsData = [];

const adminPortalRows = [
  { id: 1, report: 'Monthly valuation + occupancy', workflow: 'Budget approval pending CFO', monitoring: 'Homes, apartments, leads all synced' }
];
const homesPortalRows = [];
const apartmentPortalRows = [];
const leadsPortalRows = [];
const operationsPortalRows = [
  { id: 1, workOrder: 'Assign plumbing issue to Vendor A', serviceLevel: 'Target response < 24h', preventive: 'Quarterly HVAC check logged' }
];

let nextId = { admin: 2, home: 1, apt: 1, lead: 1, ops: 2 };

// Confirm dialog
let confirmCallback = null;

// ══════════════════════════════════════════════
//  NAV
// ══════════════════════════════════════════════
const viewTitles = {
  'overview': 'Dashboard',
  'admin-portal': 'Admin Portal',
  'homes-portal': 'Individual Homes',
  'apartments-portal': 'Apartments',
  'leads-portal': 'Leads',
  'operations-portal': 'Operations',
  'properties-view': 'Residential Properties',
  'units-view': 'Building Units',
  'registrations-view': 'Registrations'
};

function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const viewEl = document.getElementById('view-' + id);
  if (viewEl) viewEl.classList.add('active');
  event?.currentTarget?.classList.add('active');
  document.getElementById('topbarTitle').textContent = viewTitles[id] || id;
  // close sidebar on mobile
  if (window.innerWidth < 900) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('open'); }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

// ══════════════════════════════════════════════
//  TOAST
// ══════════════════════════════════════════════
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type === 'error' ? 'show error' : 'show';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ''; }, 3200);
}

// ══════════════════════════════════════════════
//  CONFIRM DIALOG
// ══════════════════════════════════════════════
function openConfirm(title, msg, cb, btnLabel = 'Delete') {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmOkBtn').textContent = btnLabel;
  confirmCallback = cb;
  document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm(result) {
  document.getElementById('confirmOverlay').classList.remove('active');
  if (result && confirmCallback) confirmCallback();
  confirmCallback = null;
}

// ══════════════════════════════════════════════
//  MODALS
// ══════════════════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// ══════════════════════════════════════════════
//  BADGE HELPERS
// ══════════════════════════════════════════════
function statusBadge(status) {
  const map = {
    occupied: 'badge-green', listed: 'badge-blue', vacant: 'badge-gold',
    vacancy: 'badge-gold', sold: 'badge-gray', immediately: 'badge-green',
    'in 3 months': 'badge-blue', 'in 6 months': 'badge-gold', later: 'badge-gray'
  };
  return `<span class="badge ${map[status] || 'badge-gray'}">${status}</span>`;
}

// ══════════════════════════════════════════════
//  ADMIN PORTAL
// ══════════════════════════════════════════════
function renderAdminPortal() {
  const tbody = document.getElementById('adminPortalTableBody');
  tbody.innerHTML = adminPortalRows.length
    ? adminPortalRows.map(r => `
        <tr>
          <td>${r.report}</td>
          <td>${r.workflow}</td>
          <td>${r.monitoring}</td>
          <td>
            <button class="btn btn-sm" onclick="editAdminRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAdminRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="4"><div class="empty-state">No reports yet.</div></td></tr>`;
}

function openAdminModal(id = null) {
  const editing = id ? adminPortalRows.find(r => r.id === id) : null;
  document.getElementById('adminReport').value = editing?.report || '';
  document.getElementById('adminWorkflow').value = editing?.workflow || '';
  document.getElementById('adminMonitoring').value = editing?.monitoring || '';
  document.getElementById('adminModal').dataset.editId = id || '';
  openModal('adminModal');
}
function submitAdminForm() {
  const report = document.getElementById('adminReport').value.trim();
  if (!report) return showToast('Report field is required.', 'error');
  const editId = parseInt(document.getElementById('adminModal').dataset.editId);
  if (editId) {
    const r = adminPortalRows.find(x => x.id === editId);
    if (r) { r.report = report; r.workflow = document.getElementById('adminWorkflow').value.trim(); r.monitoring = document.getElementById('adminMonitoring').value.trim(); }
  } else {
    adminPortalRows.push({ id: nextId.admin++, report, workflow: document.getElementById('adminWorkflow').value.trim(), monitoring: document.getElementById('adminMonitoring').value.trim() });
  }
  closeModal('adminModal');
  renderAdminPortal();
  showToast('Report saved.');
}
function editAdminRow(id) { openAdminModal(id); }
function deleteAdminRow(id) {
  openConfirm('Delete Report', 'Remove this portfolio report?', () => {
    const i = adminPortalRows.findIndex(r => r.id === id);
    if (i > -1) adminPortalRows.splice(i, 1);
    renderAdminPortal();
    showToast('Report deleted.');
  });
}

// ══════════════════════════════════════════════
//  HOMES PORTAL
// ══════════════════════════════════════════════
function renderHomesPortal() {
  const tbody = document.getElementById('homePortalTableBody');
  tbody.innerHTML = homesPortalRows.length
    ? homesPortalRows.map(r => `
        <tr>
          <td><strong>${r.address}</strong></td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.lease}${r.rent ? ` &mdash; $${Number(r.rent).toLocaleString()}/mo` : ''}</td>
          <td>${r.maintenance || '<span style="color:var(--muted)">—</span>'}</td>
          <td>${r.notice || '<span style="color:var(--muted)">—</span>'}</td>
          <td>
            <button class="btn btn-sm" onclick="viewHomeDetail(${r.id})">View</button>
            <button class="btn btn-sm" onclick="editHomeRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteHomeRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="6"><div class="empty-state">No home listings yet. Click "Create Listing" to add one.</div></td></tr>`;
}

function openHomeModal(id = null) {
  const editing = id ? homesPortalRows.find(r => r.id === id) : null;
  document.getElementById('homeAddress').value = editing?.address || '';
  document.getElementById('homeStatus').value = editing?.status || 'occupied';
  document.getElementById('homeLease').value = editing?.lease || '';
  document.getElementById('homeRent').value = editing?.rent || '';
  document.getElementById('homeMaintenance').value = editing?.maintenance || '';
  document.getElementById('homeNotice').value = editing?.notice || '';
  document.getElementById('homeModalTitle').textContent = id ? 'Edit Home Listing' : 'Create Home Listing';
  document.getElementById('homeModal').dataset.editId = id || '';
  openModal('homeModal');
}
function submitHomeForm() {
  const address = document.getElementById('homeAddress').value.trim();
  if (!address) return showToast('Address is required.', 'error');
  const editId = parseInt(document.getElementById('homeModal').dataset.editId);
  const data = {
    address, status: document.getElementById('homeStatus').value,
    lease: document.getElementById('homeLease').value.trim(),
    rent: document.getElementById('homeRent').value,
    maintenance: document.getElementById('homeMaintenance').value.trim(),
    notice: document.getElementById('homeNotice').value.trim()
  };
  if (editId) {
    const r = homesPortalRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    homesPortalRows.unshift({ id: nextId.home++, ...data });
  }
  closeModal('homeModal');
  renderHomesPortal();
  showToast(editId ? 'Listing updated.' : 'Listing created.');
}
function editHomeRow(id) { openHomeModal(id); }
function deleteHomeRow(id) {
  openConfirm('Delete Listing', 'Remove this home listing?', () => {
    const i = homesPortalRows.findIndex(r => r.id === id);
    if (i > -1) homesPortalRows.splice(i, 1);
    renderHomesPortal();
    showToast('Listing deleted.');
  });
}
function viewHomeDetail(id) {
  const r = homesPortalRows.find(x => x.id === id);
  if (!r) return;
  document.getElementById('detailTitle').textContent = r.address;
  document.getElementById('detailBody').innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      ${[['Status', statusBadge(r.status)],['Lease', r.lease],['Rent', r.rent ? '$'+Number(r.rent).toLocaleString()+'/mo' : '—'],['Maintenance', r.maintenance||'—'],['Notice', r.notice||'—']].map(([k,v])=>`<tr><td style="padding:12px 0;font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);width:40%;border-bottom:1px solid var(--border);">${k}</td><td style="padding:12px 0;font-size:.85rem;border-bottom:1px solid var(--border);">${v}</td></tr>`).join('')}
    </table>`;
  openModal('detailOverlay');
}

// ══════════════════════════════════════════════
//  APARTMENTS PORTAL
// ══════════════════════════════════════════════
function renderApartmentsPortal() {
  const tbody = document.getElementById('apartmentPortalTableBody');
  tbody.innerHTML = apartmentPortalRows.length
    ? apartmentPortalRows.map(r => `
        <tr>
          <td><strong>${r.unit}</strong><br><small style="color:var(--muted)">${r.address}</small><br><small>${r.type}</small></td>
          <td>$${Number(r.price).toLocaleString()}</td>
          <td>$${Number(r.rent).toLocaleString()}/mo</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.announcement || '<span style="color:var(--muted)">—</span>'}</td>
          <td>${r.turnover || '<span style="color:var(--muted)">—</span>'}</td>
          <td>
            <button class="btn btn-sm" onclick="editAptRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAptRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="7"><div class="empty-state">No apartment units yet. Click "Add Unit" to create one.</div></td></tr>`;
}

function openUnitModal(id = null) {
  const editing = id ? apartmentPortalRows.find(r => r.id === id) : null;
  document.getElementById('unitName').value = editing?.unit || '';
  document.getElementById('unitAddress').value = editing?.address || '';
  document.getElementById('unitType').value = editing?.type || '';
  document.getElementById('unitPrice').value = editing?.price || '';
  document.getElementById('unitRent').value = editing?.rent || '';
  document.getElementById('unitStatus').value = editing?.status || 'vacant';
  document.getElementById('unitAnnouncement').value = editing?.announcement || '';
  document.getElementById('unitTurnover').value = editing?.turnover || '';
  document.getElementById('unitModalTitle').textContent = id ? 'Edit Unit' : 'Add Apartment Unit';
  document.getElementById('unitModal').dataset.editId = id || '';
  openModal('unitModal');
}
function submitUnitForm() {
  const unit = document.getElementById('unitName').value.trim();
  if (!unit) return showToast('Unit name is required.', 'error');
  const editId = parseInt(document.getElementById('unitModal').dataset.editId);
  const data = {
    unit, address: document.getElementById('unitAddress').value.trim(),
    type: document.getElementById('unitType').value.trim(),
    price: Number(document.getElementById('unitPrice').value),
    rent: Number(document.getElementById('unitRent').value),
    status: document.getElementById('unitStatus').value,
    announcement: document.getElementById('unitAnnouncement').value.trim(),
    turnover: document.getElementById('unitTurnover').value.trim()
  };
  if (editId) {
    const r = apartmentPortalRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    apartmentPortalRows.unshift({ id: nextId.apt++, ...data });
  }
  closeModal('unitModal');
  renderApartmentsPortal();
  showToast(editId ? 'Unit updated.' : 'Unit created.');
}
function editAptRow(id) { openUnitModal(id); }
function deleteAptRow(id) {
  openConfirm('Delete Unit', 'Remove this apartment unit?', () => {
    const i = apartmentPortalRows.findIndex(r => r.id === id);
    if (i > -1) apartmentPortalRows.splice(i, 1);
    renderApartmentsPortal();
    showToast('Unit deleted.');
  });
}

// ══════════════════════════════════════════════
//  LEADS PORTAL
// ══════════════════════════════════════════════
function renderLeadsPortal(rows = leadsPortalRows) {
  const tbody = document.getElementById('leadPortalTableBody');
  tbody.innerHTML = rows.length
    ? rows.map(r => `
        <tr>
          <td><strong>${r.name}</strong></td>
          <td>${r.source}</td>
          <td>${statusBadge(r.timeline)}</td>
          <td>${r.preferences}</td>
          <td>${r.followup}</td>
          <td>
            <button class="btn btn-sm" onclick="editLeadRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteLeadRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="6"><div class="empty-state">No lead details yet. Click "Add Lead" to start.</div></td></tr>`;
}
function filterLeadsPortal() {
  const q = document.getElementById('leadsSearch').value.toLowerCase();
  renderLeadsPortal(leadsPortalRows.filter(r => r.name.toLowerCase().includes(q) || r.source.toLowerCase().includes(q)));
}

function openLeadModal(id = null) {
  const editing = id ? leadsPortalRows.find(r => r.id === id) : null;
  document.getElementById('portalLeadName').value = editing?.name || '';
  document.getElementById('portalLeadSource').value = editing?.source || '';
  document.getElementById('portalLeadTimeline').value = editing?.timeline || 'immediately';
  document.getElementById('portalLeadPrefs').value = editing?.preferences || '';
  document.getElementById('portalLeadFollowup').value = editing?.followup || '';
  document.getElementById('leadModalTitle').textContent = id ? 'Edit Lead' : 'Add Lead';
  document.getElementById('leadModal').dataset.editId = id || '';
  openModal('leadModal');
}
function submitLeadForm() {
  const name = document.getElementById('portalLeadName').value.trim();
  if (!name) return showToast('Lead name is required.', 'error');
  const editId = parseInt(document.getElementById('leadModal').dataset.editId);
  const data = {
    name, source: document.getElementById('portalLeadSource').value.trim(),
    timeline: document.getElementById('portalLeadTimeline').value,
    preferences: document.getElementById('portalLeadPrefs').value.trim(),
    followup: document.getElementById('portalLeadFollowup').value.trim()
  };
  if (editId) {
    const r = leadsPortalRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    leadsPortalRows.unshift({ id: nextId.lead++, ...data });
  }
  closeModal('leadModal');
  renderLeadsPortal();
  showToast(editId ? 'Lead updated.' : 'Lead added.');
}
function editLeadRow(id) { openLeadModal(id); }
function deleteLeadRow(id) {
  openConfirm('Delete Lead', 'Remove this lead from the pipeline?', () => {
    const i = leadsPortalRows.findIndex(r => r.id === id);
    if (i > -1) leadsPortalRows.splice(i, 1);
    renderLeadsPortal();
    showToast('Lead deleted.');
  });
}

// ══════════════════════════════════════════════
//  OPERATIONS PORTAL
// ══════════════════════════════════════════════
function renderOperationsPortal() {
  const tbody = document.getElementById('operationsPortalTableBody');
  tbody.innerHTML = operationsPortalRows.length
    ? operationsPortalRows.map(r => `
        <tr>
          <td>${r.workOrder}</td>
          <td>${r.serviceLevel}</td>
          <td>${r.preventive}</td>
          <td>
            <button class="btn btn-sm" onclick="editOpsRow(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteOpsRow(${r.id})">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="4"><div class="empty-state">No work orders yet.</div></td></tr>`;
}
function openOpsModal(id = null) {
  const editing = id ? operationsPortalRows.find(r => r.id === id) : null;
  document.getElementById('opsWorkOrder').value = editing?.workOrder || '';
  document.getElementById('opsServiceLevel').value = editing?.serviceLevel || '';
  document.getElementById('opsPreventive').value = editing?.preventive || '';
  document.getElementById('opsModal').dataset.editId = id || '';
  openModal('opsModal');
}
function submitOpsForm() {
  const workOrder = document.getElementById('opsWorkOrder').value.trim();
  if (!workOrder) return showToast('Work order is required.', 'error');
  const editId = parseInt(document.getElementById('opsModal').dataset.editId);
  const data = { workOrder, serviceLevel: document.getElementById('opsServiceLevel').value.trim(), preventive: document.getElementById('opsPreventive').value.trim() };
  if (editId) {
    const r = operationsPortalRows.find(x => x.id === editId);
    if (r) Object.assign(r, data);
  } else {
    operationsPortalRows.push({ id: nextId.ops++, ...data });
  }
  closeModal('opsModal');
  renderOperationsPortal();
  showToast(editId ? 'Work order updated.' : 'Work order added.');
}
function editOpsRow(id) { openOpsModal(id); }
function deleteOpsRow(id) {
  openConfirm('Delete Work Order', 'Remove this work order?', () => {
    const i = operationsPortalRows.findIndex(r => r.id === id);
    if (i > -1) operationsPortalRows.splice(i, 1);
    renderOperationsPortal();
    showToast('Work order deleted.');
  });
}

// ══════════════════════════════════════════════
//  REGISTRATIONS (Leads from API)
// ══════════════════════════════════════════════
async function fetchLeads() {
  const loader = document.getElementById('loader');
  const tableContainer = document.getElementById('tableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Fetching registrations…';
  tableContainer.style.display = 'none';

  try {
    const response = await fetch('/api/admin/registrations');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    const data = await response.json();
    currentLeads = data;
    renderLeads(data);
    loader.style.display = 'none';
    tableContainer.style.display = 'block';
    updateStats();
    renderRecentActivity();
  } catch (err) {
    loader.innerHTML = 'Error loading registrations. Check server connection.';
    showToast('Failed to load registrations.', 'error');
  }
}

function renderLeads(data) {
  const head = document.getElementById('tableHead');
  const body = document.getElementById('tableBody');
  if (data.length === 0) {
    head.innerHTML = '';
    body.innerHTML = '<tr><td colspan="100%"><div class="empty-state">No registrations found yet.</div></td></tr>';
    return;
  }
  const keys = ['timestamp', 'First Name', 'Last Name', 'Email Address'];
  data.forEach(lead => { Object.keys(lead).forEach(k => { if (!keys.includes(k) && k !== 'timestamp') keys.push(k); }); });
  head.innerHTML = keys.map(k => `<th>${k.replace(/Address/g,'').replace(/[*?]/g,'').trim()}</th>`).join('');
  body.innerHTML = [...data].reverse().map(lead => `<tr>${keys.map(k => {
    let val = lead[k] || '—';
    if (k === 'timestamp') { const d = new Date(val); val = `<span class="timestamp">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`; }
    return `<td>${val}</td>`;
  }).join('')}</tr>`).join('');
}

let filteredLeads = [];
function filterRegistrations() {
  const q = document.getElementById('regSearch').value.toLowerCase();
  filteredLeads = currentLeads.filter(l => JSON.stringify(l).toLowerCase().includes(q));
  renderLeads(filteredLeads.length || q ? filteredLeads : currentLeads);
}

function exportCSV() {
  const data = filteredLeads.length ? filteredLeads : currentLeads;
  if (!data.length) return showToast('No data to export.', 'error');
  const keys = Object.keys(data[0]);
  const csv = [keys.join(','), ...data.map(r => keys.map(k => `"${r[k]||''}"`).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `leads_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported.');
}

// ══════════════════════════════════════════════
//  PROPERTIES
// ══════════════════════════════════════════════
async function fetchProperties() {
  const loader = document.getElementById('propertiesLoader');
  const table = document.getElementById('propertiesTableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Loading properties…';
  table.style.display = 'none';
  try {
    const response = await fetch('/api/properties');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    propertiesData = await response.json();
    renderProperties(propertiesData);
    loader.style.display = 'none';
    table.style.display = 'block';
    updateStats();
  } catch (error) {
    loader.innerHTML = 'Failed to load properties.';
    showToast('Failed to load properties.', 'error');
  }
}

function renderProperties(properties) {
  const body = document.getElementById('propertiesTableBody');
  body.innerHTML = properties.length ? properties.map(p => `
    <tr>
      <td><strong>${p.address}</strong></td>
      <td><span class="badge badge-gray">${p.property_type || '—'}</span></td>
      <td>${p.bedrooms} bd / ${p.bathrooms} ba</td>
      <td>${Number(p.sqft).toLocaleString()} sqft</td>
      <td><strong>$${Number(p.current_value).toLocaleString()}</strong></td>
      <td>${p.estimated_rent ? '$'+Number(p.estimated_rent).toLocaleString()+'/mo' : '—'}</td>
      <td>${p.year_built}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-sm" onclick="editProperty(${p.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProperty(${p.id})">Delete</button>
        <a href="property-detail.html?id=${p.id}" class="btn btn-sm">View</a>
      </td>
    </tr>`).join('')
    : `<tr><td colspan="8"><div class="empty-state">No properties found. Click "Add Property" to begin.</div></td></tr>`;
}

function filterProperties() {
  const q = document.getElementById('propertiesSearch').value.toLowerCase();
  renderProperties(propertiesData.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

function openPropertyModal(propertyId = null) {
  const form = document.getElementById('propertyForm');
  form.reset();
  document.getElementById('propertyId').value = '';
  document.getElementById('propertyModalTitle').textContent = 'Add New Property';
  if (propertyId) {
    const p = propertiesData.find(x => x.id === propertyId);
    if (p) {
      document.getElementById('propertyModalTitle').textContent = 'Edit Property';
      document.getElementById('propertyId').value = p.id;
      document.getElementById('address').value = p.address;
      document.getElementById('currentValue').value = p.current_value;
      document.getElementById('estimatedRent').value = p.estimated_rent || '';
      document.getElementById('sqft').value = p.sqft;
      document.getElementById('bedrooms').value = p.bedrooms;
      document.getElementById('bathrooms').value = p.bathrooms;
      document.getElementById('lotSize').value = p.lot_size || '';
      document.getElementById('propertyType').value = p.property_type;
      document.getElementById('yearBuilt').value = p.year_built;
      document.getElementById('projectSlug').value = p.project_slug;
      document.getElementById('purchasePrice').value = p.purchase_price || '';
      document.getElementById('lastSoldAt').value = p.last_sold_at || '';
    }
  }
  openModal('propertyModal');
}
function closePropertyModal() { closeModal('propertyModal'); }

function editProperty(id) { openPropertyModal(id); }

async function deleteProperty(id) {
  openConfirm('Delete Property', 'Permanently delete this property?', async () => {
    try {
      const r = await fetch(`/api/properties/${id}`, { method: 'DELETE' });
      if (!r.ok) throw new Error();
      await fetchProperties();
      showToast('Property deleted.');
    } catch { showToast('Failed to delete property.', 'error'); }
  });
}

async function submitPropertyForm() {
  const propertyId = document.getElementById('propertyId').value;
  const payload = {
    address: document.getElementById('address').value,
    current_value: parseInt(document.getElementById('currentValue').value),
    estimated_rent: parseInt(document.getElementById('estimatedRent').value) || 0,
    sqft: parseInt(document.getElementById('sqft').value),
    bedrooms: parseInt(document.getElementById('bedrooms').value),
    bathrooms: parseFloat(document.getElementById('bathrooms').value),
    lot_size: parseInt(document.getElementById('lotSize').value) || 0,
    property_type: document.getElementById('propertyType').value,
    year_built: parseInt(document.getElementById('yearBuilt').value),
    project_slug: document.getElementById('projectSlug').value,
    purchase_price: parseInt(document.getElementById('purchasePrice').value) || null,
    last_sold_at: document.getElementById('lastSoldAt').value || null
  };
  try {
    const url = propertyId ? `/api/properties/${propertyId}` : '/api/properties';
    const method = propertyId ? 'PATCH' : 'POST';
    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) throw new Error();
    closePropertyModal();
    await fetchProperties();
    showToast(propertyId ? 'Property updated.' : 'Property saved.');
  } catch { showToast('Failed to save property.', 'error'); }
}

// ══════════════════════════════════════════════
//  UNITS
// ══════════════════════════════════════════════
async function fetchUnits() {
  const loader = document.getElementById('unitsLoader');
  const table = document.getElementById('unitsTableContainer');
  loader.style.display = 'block';
  loader.innerHTML = '<span class="spinner"></span> Loading units…';
  table.style.display = 'none';
  try {
    const response = await fetch('/api/units');
    if (!response.ok) throw new Error(`Status ${response.status}`);
    unitsData = await response.json();
    renderUnits(unitsData);
    loader.style.display = 'none';
    table.style.display = 'block';
    updateStats();
  } catch (error) {
    loader.innerHTML = 'Failed to load units.';
    showToast('Failed to load units.', 'error');
  }
}

function renderUnits(units) {
  const body = document.getElementById('unitsTableBody');
  body.innerHTML = units.length ? units.map(unit => `
    <tr>
      <td><strong>${unit.unit}</strong></td>
      <td>${statusBadge(unit.status)}</td>
      <td>$${Number(unit.value).toLocaleString()}</td>
      <td>$${Number(unit.rent).toLocaleString()}/mo</td>
      <td>${unit.last_sold_at || '—'}</td>
      <td>
        <form class="inline-edit" data-id="${unit.id}" onsubmit="saveUnit(event, this)">
          <select name="status">
            <option value="occupied" ${unit.status==='occupied'?'selected':''}>Occupied</option>
            <option value="vacant" ${unit.status==='vacant'?'selected':''}>Vacant</option>
            <option value="listed" ${unit.status==='listed'?'selected':''}>Listed</option>
          </select>
          <input name="value" type="number" min="1" value="${unit.value}" required style="width:100px">
          <input name="rent" type="number" min="0" value="${unit.rent}" required style="width:90px">
          <button class="btn btn-primary btn-sm" type="submit">Save</button>
        </form>
      </td>
    </tr>`).join('')
    : `<tr><td colspan="6"><div class="empty-state">No units found.</div></td></tr>`;
}

async function saveUnit(event, form) {
  event.preventDefault();
  const id = form.dataset.id;
  const payload = { status: form.status.value, value: Number(form.value.value), rent: Number(form.rent.value) };
  try {
    const r = await fetch(`/api/units/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!r.ok) throw new Error();
    await fetchUnits();
    showToast('Unit updated.');
  } catch { showToast('Failed to update unit.', 'error'); }
}

// ══════════════════════════════════════════════
//  STATS & ACTIVITY
// ══════════════════════════════════════════════
function updateStats() {
  document.getElementById('totalLeads').textContent = currentLeads.length || '—';
  document.getElementById('totalProperties').textContent = propertiesData.length || '—';
  document.getElementById('totalUnits').textContent = unitsData.length || '—';
  const total = propertiesData.reduce((s,p) => s+(p.current_value||0),0) + unitsData.reduce((s,u) => s+(u.value||0),0);
  document.getElementById('portfolioValue').textContent = total > 0 ? '$'+(total/1e6).toFixed(1)+'M' : '—';
}

function renderRecentActivity() {
  const el = document.getElementById('recentActivityList');
  const items = [];
  if (currentLeads.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">📋 <strong>${currentLeads.length}</strong> registration${currentLeads.length>1?'s':''} on file</td></tr>`);
  if (propertiesData.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">🏠 <strong>${propertiesData.length}</strong> residential propert${propertiesData.length>1?'ies':'y'} tracked</td></tr>`);
  if (unitsData.length) {
    const vacant = unitsData.filter(u => u.status === 'vacant').length;
    items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">🏢 <strong>${unitsData.length}</strong> units — <strong>${vacant}</strong> vacant</td></tr>`);
  }
  if (leadsPortalRows.length) items.push(`<tr><td style="padding:14px 24px;border-bottom:1px solid var(--border);font-size:.82rem;">👥 <strong>${leadsPortalRows.length}</strong> pipeline lead${leadsPortalRows.length>1?'s':''}</td></tr>`);
  if (!items.length) { el.innerHTML = '<div class="empty-state">No recent activity data.</div>'; return; }
  el.outerHTML = `<div class="table-wrap"><table><tbody>${items.join('')}</tbody></table></div>`;
}

function refreshAll() {
  fetchLeads();
  fetchProperties();
  fetchUnits();
  showToast('Refreshing all data…');
}

// ══════════════════════════════════════════════
//  CLOSE MODALS ON OVERLAY CLICK
// ══════════════════════════════════════════════
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal(overlay.id);
  });
});

// ══════════════════════════════════════════════
//  KEYBOARD ESC CLOSE
// ══════════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active, .confirm-overlay.active').forEach(el => el.classList.remove('active'));
  }
});

// ══════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════
renderAdminPortal();
renderHomesPortal();
renderApartmentsPortal();
renderLeadsPortal();
renderOperationsPortal();
fetchLeads();
fetchProperties();
fetchUnits();
</script>
</body>
</html>
