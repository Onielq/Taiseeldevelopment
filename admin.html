<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Taiseel Development</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a3c22;
      --accent: #c5a059;
      --bg: #fcfcfc;
      --white: #ffffff;
      --text: #333;
      --muted: #999;
      --border: #eeeeee;
      --sidebar-w: 248px;
      --danger: #c0392b;
      --success: #2e7d32;
      --warn: #e67e22;
      --info: #1565c0;
      --card-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    [data-theme="dark"] {
      --bg: #111814;
      --white: #1a2620;
      --text: #e8e8e8;
      --muted: #666;
      --border: #2a3a2e;
      --card-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      display:flex;
      min-height:100vh;
      transition: background 0.3s, color 0.3s;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      width:var(--sidebar-w); min-height:100vh;
      background:var(--primary);
      display:flex; flex-direction:column;
      position:fixed; top:0; left:0; z-index:200;
      transition:transform 0.3s ease;
      overflow-y:auto;
    }
    .sidebar::-webkit-scrollbar { width:4px; }
    .sidebar::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1); border-radius:2px; }
    .sidebar-brand { padding:28px 24px 20px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .sidebar-brand h1 { font-size:0.78rem; font-weight:800; letter-spacing:4px; text-transform:uppercase; color:#fff; }
    .sidebar-brand span { font-size:0.62rem; color:rgba(255,255,255,0.35); letter-spacing:2px; }
    .sidebar-nav { flex:1; padding:12px 0; }
    .nav-section-label { padding:14px 24px 4px; font-size:0.58rem; letter-spacing:3px; text-transform:uppercase; color:rgba(255,255,255,0.28); }
    .nav-item {
      display:flex; align-items:center; gap:11px;
      padding:10px 24px; font-size:0.76rem; font-weight:600; letter-spacing:0.5px;
      color:rgba(255,255,255,0.58); cursor:pointer;
      transition:all 0.2s; border-left:3px solid transparent; text-decoration:none;
    }
    .nav-item:hover { color:#fff; background:rgba(255,255,255,0.05); }
    .nav-item.active { color:#fff; border-left-color:var(--accent); background:rgba(255,255,255,0.07); }
    .nav-item svg { opacity:0.7; flex-shrink:0; }
    .nav-item.active svg { opacity:1; }
    .nav-badge {
      margin-left:auto; background:var(--accent); color:#fff;
      font-size:0.58rem; font-weight:800; padding:2px 7px; border-radius:10px;
    }
    .sidebar-footer { padding:16px 24px; border-top:1px solid rgba(255,255,255,0.08); }
    .sidebar-footer a {
      display:flex; align-items:center; gap:10px;
      font-size:0.7rem; font-weight:600; letter-spacing:1px;
      color:rgba(255,255,255,0.45); text-decoration:none; transition:color 0.2s;
    }
    .sidebar-footer a:hover { color:#fff; }

    /* ── SIDEBAR TOGGLE ── */
    .sidebar-toggle {
      display:none; position:fixed; top:14px; left:14px; z-index:300;
      background:var(--primary); color:#fff; border:none; border-radius:8px;
      width:40px; height:40px; cursor:pointer; align-items:center; justify-content:center;
    }
    .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:199; }

    /* ── MAIN ── */
    .main { margin-left:var(--sidebar-w); flex:1; display:flex; flex-direction:column; min-height:100vh; }
    .topbar {
      background:var(--white); border-bottom:1px solid var(--border);
      padding:0 36px; height:62px;
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:100;
    }
    .topbar-left { display:flex; align-items:center; gap:14px; }
    .topbar-title { font-size:0.82rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--primary); }
    .topbar-right { display:flex; align-items:center; gap:10px; }
    .page-content { padding:36px; flex:1; }

    /* ── BUTTONS ── */
    .btn {
      padding:9px 18px; border:1px solid var(--border);
      background:var(--white); color:var(--text);
      font-size:0.7rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
      cursor:pointer; transition:all 0.22s; border-radius:8px;
      text-decoration:none; display:inline-flex; align-items:center; gap:6px;
      font-family:'Montserrat',sans-serif;
    }
    .btn:hover { border-color:var(--primary); color:var(--primary); }
    .btn-primary { background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn-primary:hover { background:#15311b; color:#fff; }
    .btn-accent { background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn-accent:hover { background:#b08f4a; color:#fff; }
    .btn-danger { background:transparent; color:var(--danger); border-color:var(--danger); }
    .btn-danger:hover { background:var(--danger); color:#fff; }
    .btn-warn { background:transparent; color:var(--warn); border-color:var(--warn); }
    .btn-warn:hover { background:var(--warn); color:#fff; }
    .btn-sm { padding:5px 11px; font-size:0.62rem; letter-spacing:1px; }
    .btn-xs { padding:3px 8px; font-size:0.58rem; letter-spacing:0.5px; }

    /* ── VIEWS ── */
    .view { display:none; }
    .view.active { display:block; animation:fadeIn 0.18s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }

    /* ── STATS GRID ── */
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:28px; }
    .stat-card {
      background:var(--white); padding:24px 28px; border-radius:14px;
      border:1px solid var(--border); box-shadow:var(--card-shadow);
      transition:transform 0.22s,box-shadow 0.22s; position:relative; overflow:hidden; cursor:default;
    }
    .stat-card:hover { transform:translateY(-3px); box-shadow:0 8px 28px rgba(0,0,0,0.08); }
    .stat-card::before { content:''; position:absolute; top:0; left:0; width:3px; height:100%; background:var(--accent); }
    .stat-label { font-size:0.62rem; color:var(--muted); text-transform:uppercase; letter-spacing:3px; margin-bottom:6px; display:block; }
    .stat-value { font-size:2rem; font-weight:300; color:var(--primary); }
    .stat-sub { font-size:0.68rem; color:var(--muted); margin-top:4px; }
    .stat-alert { font-size:0.68rem; color:var(--warn); margin-top:4px; font-weight:600; }

    /* ── KPI ROW ── */
    .kpi-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:24px; }
    .kpi-card {
      background:var(--white); padding:18px 20px; border-radius:12px;
      border:1px solid var(--border); box-shadow:var(--card-shadow);
    }
    .kpi-label { font-size:0.6rem; color:var(--muted); text-transform:uppercase; letter-spacing:2px; margin-bottom:4px; }
    .kpi-value { font-size:1.4rem; font-weight:600; color:var(--primary); }
    .kpi-unit { font-size:0.7rem; color:var(--muted); }

    /* ── SECTION CARD ── */
    .section-card {
      background:var(--white); border-radius:14px;
      border:1px solid var(--border); box-shadow:var(--card-shadow);
      margin-bottom:24px; overflow:hidden;
    }
    .section-header {
      padding:20px 28px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }
    .section-header h2 { font-size:0.82rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--primary); }
    .section-header-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* ── MINI CHART ── */
    .chart-wrap { padding:20px 28px; }
    .bar-chart { display:flex; align-items:flex-end; gap:8px; height:80px; }
    .bar-col { display:flex; flex-direction:column; align-items:center; gap:4px; flex:1; }
    .bar { background:var(--accent); border-radius:4px 4px 0 0; min-height:4px; transition:height 0.5s ease; opacity:0.85; }
    .bar:hover { opacity:1; }
    .bar-label { font-size:0.55rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
    .bar-val { font-size:0.6rem; color:var(--text); font-weight:600; }

    /* ── FUNNEL CHART ── */
    .funnel-wrap { padding:20px 28px; }
    .funnel-stage {
      display:flex; align-items:center; margin-bottom:10px; gap:14px;
    }
    .funnel-bar-wrap { flex:1; background:#f3f3f3; border-radius:4px; height:28px; overflow:hidden; }
    .funnel-bar { height:100%; background:var(--primary); border-radius:4px; transition:width 0.6s ease; display:flex; align-items:center; padding:0 10px; }
    .funnel-bar span { font-size:0.65rem; font-weight:700; color:#fff; white-space:nowrap; }
    .funnel-label { font-size:0.68rem; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--text); width:100px; flex-shrink:0; }
    .funnel-count { font-size:0.72rem; color:var(--muted); width:36px; text-align:right; }

    /* ── OCCUPANCY GAUGE ── */
    .gauge-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; padding:20px 28px; }
    .gauge-item { text-align:center; }
    .gauge-ring {
      width:80px; height:80px; margin:0 auto 8px;
      border-radius:50%; position:relative;
      background:conic-gradient(var(--accent) 0deg, var(--border) 0deg);
      display:flex; align-items:center; justify-content:center;
    }
    .gauge-inner { width:56px; height:56px; background:var(--white); border-radius:50%; display:flex; align-items:center; justify-content:center; }
    .gauge-pct { font-size:0.75rem; font-weight:700; color:var(--primary); }
    .gauge-label { font-size:0.62rem; text-transform:uppercase; letter-spacing:2px; color:var(--muted); }

    /* ── ALERT BANNER ── */
    .alert-list { padding:16px 28px; display:flex; flex-direction:column; gap:8px; }
    .alert-item {
      display:flex; align-items:flex-start; gap:10px; padding:12px 14px;
      border-radius:10px; border:1px solid;
    }
    .alert-item.warn { background:#fff8f0; border-color:#f0d9c0; }
    .alert-item.danger { background:#fdf0ef; border-color:#f0c4c0; }
    .alert-item.info { background:#eef4fc; border-color:#c0d4f0; }
    .alert-item.success { background:#edf7f0; border-color:#b8dfc4; }
    .alert-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:5px; }
    .warn .alert-dot { background:var(--warn); }
    .danger .alert-dot { background:var(--danger); }
    .info .alert-dot { background:var(--info); }
    .success .alert-dot { background:var(--success); }
    .alert-text { font-size:0.78rem; color:var(--text); line-height:1.4; }
    .alert-text strong { font-weight:700; }
    .alert-time { font-size:0.62rem; color:var(--muted); margin-top:2px; }

    /* ── TABLE ── */
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; text-align:left; }
    th {
      background:#f8f9f8; padding:13px 22px;
      font-size:0.65rem; font-weight:700; text-transform:uppercase;
      letter-spacing:2px; color:var(--muted); border-bottom:1px solid var(--border);
      white-space:nowrap; cursor:pointer; user-select:none;
    }
    th:hover { color:var(--primary); }
    th.sorted-asc::after { content:' ↑'; }
    th.sorted-desc::after { content:' ↓'; }
    td {
      padding:14px 22px; font-size:0.83rem;
      border-bottom:1px solid var(--border); color:#555; vertical-align:middle;
    }
    [data-theme="dark"] td { color:#aaa; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:rgba(26,60,34,0.03); }

    /* ── BADGES ── */
    .badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:0.62rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
    .badge-green { background:#e9f5ed; color:var(--success); }
    .badge-gold { background:#fef9ec; color:#b08f4a; }
    .badge-blue { background:#e8f4fd; color:var(--info); }
    .badge-gray { background:#f3f3f3; color:#777; }
    .badge-red { background:#fdecea; color:var(--danger); }
    .badge-orange { background:#fff3e0; color:var(--warn); }
    .priority-high { color:var(--danger); font-weight:700; font-size:0.7rem; }
    .priority-med { color:var(--warn); font-weight:700; font-size:0.7rem; }
    .priority-low { color:var(--success); font-weight:700; font-size:0.7rem; }

    /* ── FORMS ── */
    .form-grid-modal { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
    .form-group { display:flex; flex-direction:column; gap:5px; }
    .form-group.full { grid-column:1/-1; }
    .form-group.half { grid-column:span 1; }
    .form-group label { font-size:0.62rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
    .form-group input,.form-group select,.form-group textarea {
      border:1px solid var(--border); border-radius:8px; padding:10px 12px;
      font-family:'Montserrat',sans-serif; font-size:0.82rem;
      background:var(--white); color:var(--text); transition:border-color 0.2s;
    }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus { outline:none; border-color:var(--primary); }
    .form-group textarea { min-height:80px; resize:vertical; }
    .form-note { font-size:0.68rem; color:var(--muted); }

    /* ── SEARCH ── */
    .search-bar { position:relative; display:flex; align-items:center; }
    .search-bar input {
      border:1px solid var(--border); border-radius:8px;
      padding:7px 12px 7px 32px; font-family:'Montserrat',sans-serif;
      font-size:0.75rem; width:190px; background:var(--white); color:var(--text);
      transition:border-color 0.2s,width 0.3s;
    }
    .search-bar input:focus { outline:none; border-color:var(--primary); width:240px; }
    .search-bar svg { position:absolute; left:9px; pointer-events:none; }

    /* ── FILTER BAR ── */
    .filter-bar {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      padding:12px 28px; border-bottom:1px solid var(--border); background:#fafafa;
    }
    [data-theme="dark"] .filter-bar { background:rgba(255,255,255,0.02); }
    .filter-select {
      border:1px solid var(--border); border-radius:8px; padding:6px 10px;
      font-family:'Montserrat',sans-serif; font-size:0.7rem;
      background:var(--white); color:var(--text); cursor:pointer;
    }
    .filter-select:focus { outline:none; border-color:var(--primary); }
    .filter-label { font-size:0.62rem; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }

    /* ── MODAL ── */
    .modal-overlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.48); z-index:500;
      align-items:center; justify-content:center; padding:20px;
    }
    .modal-overlay.active { display:flex; }
    .modal-box {
      background:var(--white); border-radius:18px;
      width:100%; max-width:760px; max-height:92vh; overflow-y:auto;
      box-shadow:0 24px 80px rgba(0,0,0,0.25); animation:modalIn 0.22s ease;
    }
    .modal-box.narrow { max-width:500px; }
    @keyframes modalIn { from{transform:translateY(16px);opacity:0} to{transform:none;opacity:1} }
    .modal-head {
      padding:24px 32px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; background:var(--white); z-index:1;
    }
    .modal-head h2 { font-size:0.92rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--primary); }
    .modal-close { background:none; border:none; cursor:pointer; color:var(--muted); font-size:20px; padding:4px 8px; border-radius:6px; transition:background 0.2s; line-height:1; }
    .modal-close:hover { background:var(--border); color:var(--text); }
    .modal-body { padding:28px 32px; }
    .modal-footer { padding:18px 32px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; background:var(--white); position:sticky; bottom:0; }

    /* ── CONFIRM ── */
    .confirm-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:600; align-items:center; justify-content:center; }
    .confirm-overlay.active { display:flex; }
    .confirm-box {
      background:var(--white); border-radius:16px; padding:36px;
      max-width:380px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.2);
      text-align:center; animation:modalIn 0.2s ease;
    }
    .confirm-box h3 { font-size:1rem; font-weight:700; margin-bottom:10px; }
    .confirm-box p { color:var(--muted); font-size:0.8rem; margin-bottom:24px; }
    .confirm-actions { display:flex; gap:10px; justify-content:center; }

    /* ── TOAST ── */
    #toast {
      position:fixed; bottom:28px; right:28px;
      background:var(--primary); color:#fff;
      padding:13px 20px; border-radius:10px; font-size:0.76rem;
      font-weight:600; letter-spacing:1px; box-shadow:0 8px 28px rgba(0,0,0,0.2);
      transform:translateY(80px); opacity:0; transition:all 0.28s ease; z-index:999; max-width:320px;
    }
    #toast.show { transform:translateY(0); opacity:1; }
    #toast.error { background:var(--danger); }
    #toast.warn { background:var(--warn); }

    /* ── LOADER ── */
    .loader-row { padding:44px; text-align:center; color:var(--muted); letter-spacing:2px; text-transform:uppercase; font-size:0.7rem; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; margin-right:8px; }
    @keyframes spin { to{transform:rotate(360deg)} }

    /* ── EMPTY STATE ── */
    .empty-state { padding:44px; text-align:center; color:var(--muted); font-size:0.8rem; }

    /* ── INLINE EDIT ── */
    .inline-edit { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .inline-edit input,.inline-edit select {
      border:1px solid var(--border); border-radius:6px; padding:5px 8px;
      font-family:'Montserrat',sans-serif; font-size:0.72rem;
      background:var(--white); color:var(--text);
    }

    /* ── TABS ── */
    .tabs { display:flex; gap:0; border-bottom:1px solid var(--border); padding:0 28px; overflow-x:auto; }
    .tab-btn {
      padding:13px 18px; font-size:0.68rem; font-weight:700; letter-spacing:1px; text-transform:uppercase;
      background:none; border:none; cursor:pointer; color:var(--muted);
      border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.2s; white-space:nowrap;
      font-family:'Montserrat',sans-serif;
    }
    .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
    .tab-btn:hover:not(.active) { color:var(--text); }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    /* ── PORTAL OVERVIEW ── */
    .portal-overview { display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:14px; padding:20px 28px; }
    .portal-info-card {
      border:1px solid var(--border); border-radius:12px; padding:18px;
      background:var(--white); transition:box-shadow 0.2s,transform 0.2s;
      cursor:pointer;
    }
    .portal-info-card:hover { box-shadow:0 6px 20px rgba(0,0,0,0.07); transform:translateY(-2px); }
    .portal-info-card h3 { font-size:0.72rem; letter-spacing:1px; text-transform:uppercase; margin-bottom:5px; color:var(--primary); }
    .portal-info-card p { color:#777; font-size:0.75rem; margin-bottom:8px; line-height:1.5; }
    .portal-info-card ul { margin-left:14px; color:#666; font-size:0.72rem; }
    .portal-info-card li { margin-bottom:3px; }

    /* ── KANBAN-STYLE LEAD PIPELINE ── */
    .pipeline-board { display:flex; gap:14px; padding:20px 28px; overflow-x:auto; }
    .pipeline-col { flex:0 0 200px; background:#f8f9f8; border-radius:12px; padding:14px; }
    [data-theme="dark"] .pipeline-col { background:rgba(255,255,255,0.03); }
    .pipeline-col-head { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .pipeline-col-head span { background:var(--border); border-radius:10px; padding:1px 8px; font-size:0.6rem; color:var(--muted); }
    .pipeline-card {
      background:var(--white); border:1px solid var(--border); border-radius:10px;
      padding:12px; margin-bottom:8px; cursor:pointer;
      transition:box-shadow 0.2s, transform 0.15s;
    }
    .pipeline-card:hover { box-shadow:0 4px 16px rgba(0,0,0,0.08); transform:translateY(-1px); }
    .pipeline-card-name { font-size:0.78rem; font-weight:600; color:var(--text); margin-bottom:3px; }
    .pipeline-card-sub { font-size:0.66rem; color:var(--muted); }

    /* ── ROI CALCULATOR ── */
    .roi-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    .roi-result { background:#f8faf8; border:1px solid var(--border); border-radius:12px; padding:20px; }
    .roi-result-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:0.8rem; }
    .roi-result-row:last-child { border-bottom:none; font-weight:700; color:var(--primary); font-size:0.9rem; }
    .roi-result-label { color:var(--muted); font-size:0.72rem; text-transform:uppercase; letter-spacing:1px; }

    /* ── NOTES LOG ── */
    .notes-log { padding:20px 28px; display:flex; flex-direction:column; gap:10px; }
    .note-entry { background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:14px 16px; }
    [data-theme="dark"] .note-entry { background:rgba(255,255,255,0.03); }
    .note-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .note-author { font-size:0.65rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--primary); }
    .note-time { font-size:0.62rem; color:var(--muted); }
    .note-text { font-size:0.8rem; color:var(--text); line-height:1.5; }
    .note-input-row { display:flex; gap:10px; }
    .note-input-row textarea {
      flex:1; border:1px solid var(--border); border-radius:8px; padding:10px;
      font-family:'Montserrat',sans-serif; font-size:0.8rem; min-height:64px;
      background:var(--white); color:var(--text); resize:none;
    }
    .note-input-row textarea:focus { outline:none; border-color:var(--primary); }

    /* ── MAINTENANCE PRIORITY INDICATOR ── */
    .maint-row { display:flex; align-items:center; gap:8px; }
    .maint-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

    /* ── CALENDAR STRIP ── */
    .calendar-strip { display:flex; gap:10px; overflow-x:auto; padding:16px 28px; }
    .cal-day {
      flex:0 0 52px; text-align:center; border-radius:12px;
      padding:10px 6px; border:1px solid var(--border);
      background:var(--white); cursor:pointer; transition:all 0.2s;
    }
    .cal-day:hover { border-color:var(--primary); }
    .cal-day.has-event { border-color:var(--accent); background:#fef9ec; }
    .cal-day.today { background:var(--primary); border-color:var(--primary); }
    .cal-day .day-num { font-size:0.9rem; font-weight:700; color:var(--text); }
    .cal-day.today .day-num { color:#fff; }
    .cal-day .day-name { font-size:0.58rem; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
    .cal-day.today .day-name { color:rgba(255,255,255,0.7); }
    .cal-day .day-dot { width:5px; height:5px; background:var(--accent); border-radius:50%; margin:3px auto 0; }

    /* ── DARK MODE TOGGLE ── */
    .dark-toggle { background:none; border:1px solid var(--border); border-radius:8px; padding:7px 10px; cursor:pointer; color:var(--muted); transition:all 0.2s; display:flex; align-items:center; gap:6px; font-family:'Montserrat',sans-serif; font-size:0.68rem; font-weight:600; }
    .dark-toggle:hover { border-color:var(--primary); color:var(--primary); }

    /* ── PRINT ── */
    @media print {
      .sidebar,.topbar,.btn,.filter-bar,.section-header-actions { display:none !important; }
      .main { margin-left:0; }
      .page-content { padding:0; }
      .view { display:block !important; }
    }

    /* ── RESPONSIVE ── */
    @media (max-width:900px) {
      .sidebar { transform:translateX(-100%); }
      .sidebar.open { transform:translateX(0); }
      .sidebar-overlay.open { display:block; }
      .sidebar-toggle { display:flex; }
      .main { margin-left:0; }
      .topbar { padding:0 16px 0 58px; }
      .page-content { padding:20px 16px; }
      .section-header { padding:16px 18px; }
      th,td { padding:11px 14px; }
      .modal-body { padding:20px; }
      .modal-head,.modal-footer { padding:18px 20px; }
      .stats-grid { gap:10px; }
      .roi-grid { grid-template-columns:1fr; }
    }
    @media (max-width:600px) {
      .stats-grid { grid-template-columns:1fr 1fr; }
      .topbar-title { display:none; }
      .kpi-row { grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>

<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Menu">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h1>Taiseel</h1>
    <span>Management Portal</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Overview</div>
    <a class="nav-item active" data-view="overview" href="#" onclick="showView('overview',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>
    <a class="nav-item" data-view="analytics" href="#" onclick="showView('analytics',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Analytics
    </a>

    <div class="nav-section-label">Portals</div>
    <a class="nav-item" data-view="admin-portal" href="#" onclick="showView('admin-portal',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg>
      Admin Portal
    </a>
    <a class="nav-item" data-view="homes-portal" href="#" onclick="showView('homes-portal',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>
      Individual Homes
    </a>
    <a class="nav-item" data-view="apartments-portal" href="#" onclick="showView('apartments-portal',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h2v2H9zm4 0h2v2h-2zm-4 4h2v2H9zm4 0h2v2h-2z"/></svg>
      Apartments
    </a>
    <a class="nav-item" data-view="leads-portal" href="#" onclick="showView('leads-portal',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Leads
      <span class="nav-badge" id="leadsBadge" style="display:none">0</span>
    </a>
    <a class="nav-item" data-view="operations-portal" href="#" onclick="showView('operations-portal',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
      Maintenance
      <span class="nav-badge" id="maintBadge" style="display:none">0</span>
    </a>

    <div class="nav-section-label">Data</div>
    <a class="nav-item" data-view="tenants-view" href="#" onclick="showView('tenants-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Tenants
    </a>
    <a class="nav-item" data-view="properties-view" href="#" onclick="showView('properties-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Properties
    </a>
    <a class="nav-item" data-view="units-view" href="#" onclick="showView('units-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
      Building Units
    </a>
    <a class="nav-item" data-view="registrations-view" href="#" onclick="showView('registrations-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Registrations
    </a>

    <div class="nav-section-label">Tools</div>
    <a class="nav-item" data-view="roi-view" href="#" onclick="showView('roi-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      ROI Calculator
    </a>
    <a class="nav-item" data-view="notes-view" href="#" onclick="showView('notes-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Notes Log
    </a>
    <a class="nav-item" data-view="vacancy-view" href="#" onclick="showView('vacancy-view',this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Vacancy Pipeline
    </a>
  </nav>
  <div class="sidebar-footer">
    <a href="index.html">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      View Public Site
    </a>
  </div>
</aside>

<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <span class="topbar-title" id="topbarTitle">Dashboard</span>
    </div>
    <div class="topbar-right">
      <button class="dark-toggle" onclick="toggleDark()" id="darkBtn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <span id="darkLabel">Light</span>
      </button>
      <button onclick="window.print()" class="btn btn-sm">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Print
      </button>
      <button onclick="refreshAll()" class="btn btn-primary btn-sm">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
        Refresh
      </button>
    </div>
  </header>

  <div class="page-content">

  <!-- ══════════════════ DASHBOARD ══════════════════ -->
  <div class="view active" id="view-overview">
    <!-- Alerts -->
    <div id="alertBanner"></div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-label">Total Leads</span>
        <div class="stat-value" id="totalLeads">—</div>
        <div class="stat-sub" id="leadsHot"></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Total Properties</span>
        <div class="stat-value" id="totalProperties">—</div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Total Units</span>
        <div class="stat-value" id="totalUnits">—</div>
        <div class="stat-sub" id="unitsVacant"></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Portfolio Value</span>
        <div class="stat-value" id="portfolioValue">—</div>
        <div class="stat-sub" id="avgRent"></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Occupancy Rate</span>
        <div class="stat-value" id="occupancyRate">—</div>
        <div id="occupancyAlert"></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Monthly Rev. (Est.)</span>
        <div class="stat-value" id="monthlyRevenue">—</div>
        <div class="stat-sub">from occupied units</div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Open Work Orders</span>
        <div class="stat-value" id="openWorkOrders">—</div>
        <div id="maintAlert"></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Active Tenants</span>
        <div class="stat-value" id="activeTenants">—</div>
        <div class="stat-sub" id="expiringLeases"></div>
      </div>
    </div>

    <!-- KPI Row -->
    <div class="kpi-row">
      <div class="kpi-card"><div class="kpi-label">Avg. Unit Value</div><div class="kpi-value" id="avgUnitValue">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Avg. Unit Rent</div><div class="kpi-value" id="avgUnitRent">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Gross Yield</div><div class="kpi-value" id="grossYield">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Vacant Units</div><div class="kpi-value" id="vacantCount">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Homes Listed</div><div class="kpi-value" id="homesListed">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Pipeline Leads</div><div class="kpi-value" id="pipelineLeads">—</div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
      <!-- Revenue Chart -->
      <div class="section-card">
        <div class="section-header"><h2>Estimated Monthly Revenue</h2></div>
        <div class="chart-wrap">
          <div class="bar-chart" id="revChart"></div>
        </div>
      </div>
      <!-- Occupancy Gauges -->
      <div class="section-card">
        <div class="section-header"><h2>Occupancy by Type</h2></div>
        <div class="gauge-row" id="occupancyGauges"></div>
      </div>
    </div>

    <!-- Portals Quick Nav -->
    <div class="section-card">
      <div class="section-header"><h2>Property Management Portals</h2></div>
      <div class="portal-overview">
        <div class="portal-info-card" onclick="showView('admin-portal',null)">
          <h3>1. Admin Portal</h3><p>Portfolio command center.</p>
          <ul><li>Portfolio-level reports</li><li>Workflow management</li><li>Cross-portal monitoring</li></ul>
        </div>
        <div class="portal-info-card" onclick="showView('homes-portal',null)">
          <h3>2. Individual Homes</h3><p>Single-home operations.</p>
          <ul><li>Lease/rent or sold status</li><li>Maintenance & notices</li></ul>
        </div>
        <div class="portal-info-card" onclick="showView('apartments-portal',null)">
          <h3>3. Apartment Portal</h3><p>Multi-unit inventory.</p>
          <ul><li>Unit with address/type/price</li><li>Vacant/listed/occupied</li></ul>
        </div>
        <div class="portal-info-card" onclick="showView('leads-portal',null)">
          <h3>4. Leads Portal</h3><p>Lead tracking pipeline.</p>
          <ul><li>Source + qualification</li><li>Follow-up pipeline</li></ul>
        </div>
        <div class="portal-info-card" onclick="showView('operations-portal',null)">
          <h3>5. Maintenance</h3><p>Service & preventive mgmt.</p>
          <ul><li>Work order assignment</li><li>Service-level tracking</li></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ══════════════════ ANALYTICS ══════════════════ -->
  <div class="view" id="view-analytics">
    <div class="kpi-row" style="margin-bottom:24px;">
      <div class="kpi-card"><div class="kpi-label">NOI (Est.)</div><div class="kpi-value" id="a_noi">—</div><div style="font-size:0.62rem;color:var(--muted)">Net Operating Income</div></div>
      <div class="kpi-card"><div class="kpi-label">Cap Rate</div><div class="kpi-value" id="a_cap">—</div><div style="font-size:0.62rem;color:var(--muted)">NOI / Portfolio Value</div></div>
      <div class="kpi-card"><div class="kpi-label">Gross Yield</div><div class="kpi-value" id="a_yield">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Occupancy</div><div class="kpi-value" id="a_occ">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Avg Days Vacant</div><div class="kpi-value" id="a_days">12<span class="kpi-unit"> d</span></div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
      <div class="section-card">
        <div class="section-header"><h2>Lead Conversion Funnel</h2></div>
        <div class="funnel-wrap" id="leadFunnel"></div>
      </div>
      <div class="section-card">
        <div class="section-header"><h2>Unit Status Breakdown</h2></div>
        <div class="chart-wrap" id="statusBreakdown" style="padding-top:24px;"></div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header"><h2>Rent Roll Summary</h2></div>
      <div class="filter-bar">
        <span class="filter-label">Filter:</span>
        <select class="filter-select" id="rentRollFilter" onchange="renderRentRoll()">
          <option value="all">All Units</option>
          <option value="occupied">Occupied</option>
          <option value="vacant">Vacant</option>
          <option value="listed">Listed</option>
        </select>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Unit</th><th>Status</th><th>Current Value</th><th>Monthly Rent</th><th>Annual Rent</th><th>Yield %</th></tr></thead>
        <tbody id="rentRollBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ══════════════════ ADMIN PORTAL ══════════════════ -->
  <div class="view" id="view-admin-portal">
    <div class="section-card">
      <div class="section-header">
        <h2>Admin Portal — Portfolio Reports</h2>
        <button class="btn btn-accent btn-sm" onclick="openAdminModal()">+ Add Report</button>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('adminPortalTableBody',0,this)">Portfolio Report</th><th onclick="sortTable('adminPortalTableBody',1,this)">Workflow</th><th>Cross-Portal Monitoring</th><th>Actions</th></tr></thead>
        <tbody id="adminPortalTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ HOMES PORTAL ══════════════════ -->
  <div class="view" id="view-homes-portal">
    <div class="section-card">
      <div class="section-header">
        <h2>Individual Homes Portal</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="homesSearch" placeholder="Search homes…" oninput="renderHomesPortal()"></div>
          <select class="filter-select" id="homesStatusFilter" onchange="renderHomesPortal()">
            <option value="all">All Statuses</option>
            <option value="occupied">Occupied</option>
            <option value="vacancy">Vacancy</option>
            <option value="listed">Listed</option>
            <option value="sold">Sold</option>
          </select>
          <button class="btn btn-accent btn-sm" onclick="openHomeModal()">+ Add Listing</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('homePortalTableBody',0,this)">Address</th><th>Status</th><th>Lease / Rent</th><th>Maintenance</th><th>Notice</th><th>Tenant</th><th>Actions</th></tr></thead>
        <tbody id="homePortalTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ APARTMENTS PORTAL ══════════════════ -->
  <div class="view" id="view-apartments-portal">
    <div class="section-card">
      <div class="section-header">
        <h2>Apartment Portal</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="aptsSearch" placeholder="Search units…" oninput="renderApartmentsPortal()"></div>
          <select class="filter-select" id="aptsStatusFilter" onchange="renderApartmentsPortal()">
            <option value="all">All Statuses</option>
            <option value="occupied">Occupied</option>
            <option value="vacant">Vacant</option>
            <option value="listed">Listed</option>
          </select>
          <button class="btn btn-accent btn-sm" onclick="openUnitModal()">+ Add Unit</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('apartmentPortalTableBody',0,this)">Unit / Address / Type</th><th>Price</th><th>Rent</th><th>Status</th><th>Announcement</th><th>Turnover</th><th>Actions</th></tr></thead>
        <tbody id="apartmentPortalTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ LEADS PORTAL ══════════════════ -->
  <div class="view" id="view-leads-portal">
    <!-- Pipeline Board -->
    <div class="section-card">
      <div class="section-header">
        <h2>Lead Pipeline</h2>
        <div class="section-header-actions">
          <button class="btn btn-sm" onclick="toggleLeadsView()">Toggle View</button>
          <button class="btn btn-accent btn-sm" onclick="openLeadModal()">+ Add Lead</button>
        </div>
      </div>
      <div id="leadsPipelineBoard" class="pipeline-board"></div>
    </div>

    <!-- Leads Table -->
    <div class="section-card" id="leadsTableCard">
      <div class="section-header">
        <h2>All Leads</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="leadsSearch" placeholder="Search leads…" oninput="renderLeadsPortal()"></div>
          <select class="filter-select" id="leadsTimelineFilter" onchange="renderLeadsPortal()">
            <option value="all">All Timelines</option>
            <option value="immediately">Immediately</option>
            <option value="in 3 months">3 Months</option>
            <option value="in 6 months">6 Months</option>
            <option value="later">Later</option>
          </select>
          <button class="btn btn-sm" onclick="exportLeadsCSV()">Export CSV</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('leadPortalTableBody',0,this)">Lead</th><th>Contact</th><th>Source</th><th>Timeline</th><th>Preferences</th><th>Follow-up</th><th>Actions</th></tr></thead>
        <tbody id="leadPortalTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ MAINTENANCE / OPERATIONS ══════════════════ -->
  <div class="view" id="view-operations-portal">
    <div class="section-card">
      <div class="section-header">
        <h2>Maintenance & Work Orders</h2>
        <div class="section-header-actions">
          <select class="filter-select" id="maintStatusFilter" onchange="renderOperationsPortal()">
            <option value="all">All Statuses</option>
            <option value="open">Open</option>
            <option value="in-progress">In Progress</option>
            <option value="closed">Closed</option>
          </select>
          <select class="filter-select" id="maintPriorityFilter" onchange="renderOperationsPortal()">
            <option value="all">All Priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <button class="btn btn-accent btn-sm" onclick="openOpsModal()">+ Add Work Order</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('operationsPortalTableBody',0,this)">Work Order</th><th>Priority</th><th>Status</th><th>Service Tracking</th><th>Maintenance Log</th><th>Cost ($)</th><th>Assigned To</th><th>Due Date</th><th>Actions</th></tr></thead>
        <tbody id="operationsPortalTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ TENANTS ══════════════════ -->
  <div class="view" id="view-tenants-view">
    <div class="section-card">
      <div class="section-header">
        <h2>Tenant Management</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="tenantsSearch" placeholder="Search tenants…" oninput="renderTenants()"></div>
          <button class="btn btn-accent btn-sm" onclick="openTenantModal()">+ Add Tenant</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th onclick="sortTable('tenantsTableBody',0,this)">Name</th><th>Unit / Property</th><th>Email</th><th>Phone</th><th>Lease Start</th><th>Lease End</th><th>Rent/mo</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="tenantsTableBody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ══════════════════ PROPERTIES ══════════════════ -->
  <div class="view" id="view-properties-view">
    <div class="section-card">
      <div class="section-header">
        <h2>Residential Properties</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="propertiesSearch" placeholder="Search…" oninput="filterProperties()"></div>
          <select class="filter-select" id="propTypeFilter" onchange="filterProperties()">
            <option value="all">All Types</option>
            <option value="Single Family">Single Family</option>
            <option value="Condo">Condo</option>
            <option value="Townhouse">Townhouse</option>
            <option value="Multi-Family">Multi-Family</option>
          </select>
          <button onclick="openPropertyModal()" class="btn btn-accent btn-sm">+ Add Property</button>
          <button onclick="fetchProperties()" class="btn btn-sm">Refresh</button>
        </div>
      </div>
      <div id="propertiesLoader" class="loader-row"><span class="spinner"></span> Loading properties…</div>
      <div class="table-wrap" id="propertiesTableContainer" style="display:none;">
        <table><thead><tr><th onclick="sortTable('propertiesTableBody',0,this)">Address</th><th>Type</th><th>Beds/Baths</th><th>Sqft</th><th>Current Value</th><th>Est. Rent</th><th>Year Built</th><th>Actions</th></tr></thead>
        <tbody id="propertiesTableBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ══════════════════ UNITS ══════════════════ -->
  <div class="view" id="view-units-view">
    <div class="section-card">
      <div class="section-header">
        <h2>Building Units</h2>
        <div class="section-header-actions">
          <a href="palm-central-private-residences.html#valuation" class="btn btn-sm">Open Listing</a>
          <button onclick="fetchUnits()" class="btn btn-sm">Refresh</button>
        </div>
      </div>
      <div id="unitsLoader" class="loader-row"><span class="spinner"></span> Loading units…</div>
      <div class="table-wrap" id="unitsTableContainer" style="display:none;">
        <table><thead><tr><th>Unit</th><th>Status</th><th>Value</th><th>Rent</th><th>Last Sold</th><th>Update</th></tr></thead>
        <tbody id="unitsTableBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ══════════════════ REGISTRATIONS ══════════════════ -->
  <div class="view" id="view-registrations-view">
    <div class="section-card">
      <div class="section-header">
        <h2>Registrations</h2>
        <div class="section-header-actions">
          <div class="search-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="regSearch" placeholder="Search…" oninput="filterRegistrations()"></div>
          <button onclick="exportCSV()" class="btn btn-sm">Export CSV</button>
          <button onclick="fetchLeads()" class="btn btn-sm">Refresh</button>
        </div>
      </div>
      <div id="loader" class="loader-row"><span class="spinner"></span> Fetching registrations…</div>
      <div class="table-wrap" id="tableContainer" style="display:none;">
        <table><thead><tr id="tableHead"></tr></thead><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ══════════════════ ROI CALCULATOR ══════════════════ -->
  <div class="view" id="view-roi-view">
    <div class="section-card">
      <div class="section-header"><h2>ROI & Cash Flow Calculator</h2></div>
      <div class="modal-body">
        <div class="roi-grid">
          <div>
            <div class="form-grid-modal" style="margin-bottom:20px;">
              <div class="form-group"><label>Purchase Price ($)</label><input type="number" id="roi_purchase" value="250000" oninput="calcROI()"></div>
              <div class="form-group"><label>Current Value ($)</label><input type="number" id="roi_value" value="310000" oninput="calcROI()"></div>
              <div class="form-group"><label>Monthly Rent ($)</label><input type="number" id="roi_rent" value="2200" oninput="calcROI()"></div>
              <div class="form-group"><label>Monthly Expenses ($)</label><input type="number" id="roi_expenses" value="400" oninput="calcROI()"></div>
              <div class="form-group"><label>Mortgage Payment ($/mo)</label><input type="number" id="roi_mortgage" value="1100" oninput="calcROI()"></div>
              <div class="form-group"><label>Vacancy Rate (%)</label><input type="number" id="roi_vacancy" value="5" min="0" max="100" oninput="calcROI()"></div>
              <div class="form-group"><label>Property Tax ($/yr)</label><input type="number" id="roi_tax" value="3600" oninput="calcROI()"></div>
              <div class="form-group"><label>Insurance ($/yr)</label><input type="number" id="roi_insurance" value="1200" oninput="calcROI()"></div>
            </div>
          </div>
          <div class="roi-result">
            <div style="font-size:0.7rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Results</div>
            <div class="roi-result-row"><span class="roi-result-label">Effective Monthly Rent</span><span id="roi_eff_rent">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Annual Gross Income</span><span id="roi_gross">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Annual Expenses</span><span id="roi_annual_exp">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">NOI (Net Operating Income)</span><span id="roi_noi">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Annual Cash Flow</span><span id="roi_cf">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Cash-on-Cash Return</span><span id="roi_coc">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Cap Rate</span><span id="roi_caprate">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Gross Rental Yield</span><span id="roi_gryrld">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label">Value Appreciation</span><span id="roi_apprc">—</span></div>
            <div class="roi-result-row"><span class="roi-result-label" style="font-weight:700;font-size:0.8rem;">Total ROI (excl. leverage)</span><span id="roi_total" style="color:var(--success);font-size:1.1rem;">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ══════════════════ NOTES LOG ══════════════════ -->
  <div class="view" id="view-notes-view">
    <div class="section-card">
      <div class="section-header">
        <h2>Property Notes Log</h2>
        <div class="section-header-actions">
          <select class="filter-select" id="notesPropertyFilter" onchange="renderNotes()">
            <option value="all">All Properties</option>
          </select>
        </div>
      </div>
      <div style="padding:20px 28px 10px;">
        <div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:10px;">Add Note</div>
        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;margin-bottom:16px;align-items:start;">
          <select class="filter-select" id="noteProperty" style="padding:10px 12px;font-size:0.8rem;height:42px;">
            <option value="">Select property/unit…</option>
          </select>
          <span></span>
          <div></div>
        </div>
        <div class="note-input-row">
          <textarea id="noteText" placeholder="Write a note about any property, unit, tenant, or general portfolio item…"></textarea>
          <button class="btn btn-primary" onclick="addNote()" style="align-self:flex-end;">Add Note</button>
        </div>
      </div>
      <div class="notes-log" id="notesList"></div>
    </div>
  </div>

  <!-- ══════════════════ VACANCY PIPELINE ══════════════════ -->
  <div class="view" id="view-vacancy-view">
    <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-bottom:24px;">
      <div class="stat-card"><span class="stat-label">Vacant Units</span><div class="stat-value" id="vac_vacant">—</div></div>
      <div class="stat-card"><span class="stat-label">Listed / Marketing</span><div class="stat-value" id="vac_listed">—</div></div>
      <div class="stat-card"><span class="stat-label">Applications</span><div class="stat-value" id="vac_apps">—</div></div>
      <div class="stat-card"><span class="stat-label">Avg Days on Market</span><div class="stat-value" id="vac_dom">—</div></div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <h2>Vacancy Funnel</h2>
        <button class="btn btn-accent btn-sm" onclick="openVacancyModal()">+ Add Vacancy Record</button>
      </div>
      <div class="funnel-wrap" id="vacancyFunnel"></div>
    </div>

    <div class="section-card">
      <div class="section-header"><h2>Vacancy Records</h2></div>
      <div class="table-wrap"><table>
        <thead><tr><th>Unit / Property</th><th>Vacant Since</th><th>Days on Market</th><th>Stage</th><th>Asking Rent</th><th>Showings</th><th>Applications</th><th>Actions</th></tr></thead>
        <tbody id="vacancyTableBody"></tbody>
      </table></div>
    </div>
  </div>

  </div><!-- /page-content -->
</div><!-- /main -->

<!-- Toast -->
<div id="toast"></div>

<!-- Confirm -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmMsg">This action cannot be undone.</p>
    <div class="confirm-actions">
      <button class="btn" onclick="closeConfirm(false)">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn" onclick="closeConfirm(true)">Delete</button>
    </div>
  </div>
</div>

<!-- Detail overlay -->
<div class="modal-overlay" id="detailOverlay">
  <div class="modal-box narrow">
    <div class="modal-head"><h2 id="detailTitle">Detail</h2><button class="modal-close" onclick="closeModal('detailOverlay')">&times;</button></div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('detailOverlay')">Close</button></div>
  </div>
</div>

<!-- Property Modal -->
<div class="modal-overlay" id="propertyModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="propertyModalTitle">Add Property</h2><button class="modal-close" onclick="closeModal('propertyModal')">&times;</button></div>
    <div class="modal-body">
      <input type="hidden" id="propertyId">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Address *</label><input type="text" id="address" required></div>
        <div class="form-group"><label>Current Value ($) *</label><input type="number" id="currentValue" min="1" required></div>
        <div class="form-group"><label>Est. Rent ($/mo)</label><input type="number" id="estimatedRent" min="0"></div>
        <div class="form-group"><label>Sqft *</label><input type="number" id="sqft" min="1" required></div>
        <div class="form-group"><label>Bedrooms *</label><input type="number" id="bedrooms" min="0" required></div>
        <div class="form-group"><label>Bathrooms *</label><input type="number" id="bathrooms" min="0" step="0.5" required></div>
        <div class="form-group"><label>Lot Size (sqft)</label><input type="number" id="lotSize" min="0"></div>
        <div class="form-group"><label>Property Type *</label>
          <select id="propertyType" required>
            <option value="">Select Type</option>
            <option value="Single Family">Single Family</option>
            <option value="Condo">Condo</option>
            <option value="Townhouse">Townhouse</option>
            <option value="Multi-Family">Multi-Family</option>
            <option value="Land">Land</option>
          </select>
        </div>
        <div class="form-group"><label>Year Built *</label><input type="number" id="yearBuilt" min="1800" max="2030" required></div>
        <div class="form-group"><label>Project Slug *</label>
          <select id="projectSlug" required>
            <option value="">Select Project</option>
            <option value="palm-central-private-residences">Palm Central</option>
            <option value="the-heights-residences">The Heights</option>
            <option value="brilliant-tower">Brilliant Tower</option>
            <option value="inzovu-mall">Inzovu Mall</option>
            <option value="kigali-heights">Kigali Heights</option>
          </select>
        </div>
        <div class="form-group"><label>Purchase Price ($)</label><input type="number" id="purchasePrice" min="0"></div>
        <div class="form-group"><label>Last Sold Date</label><input type="date" id="lastSoldAt"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('propertyModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitPropertyForm()">Save Property</button>
    </div>
  </div>
</div>

<!-- Home Modal -->
<div class="modal-overlay" id="homeModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="homeModalTitle">Create Home Listing</h2><button class="modal-close" onclick="closeModal('homeModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Home Address *</label><input type="text" id="homeAddress"></div>
        <div class="form-group"><label>Status</label><select id="homeStatus"><option value="occupied">Occupied</option><option value="vacancy">Vacancy</option><option value="listed">Listed</option><option value="sold">Sold</option></select></div>
        <div class="form-group"><label>Lease Details *</label><input type="text" id="homeLease"></div>
        <div class="form-group"><label>Rent/mo ($)</label><input type="number" id="homeRent" min="0"></div>
        <div class="form-group"><label>Lease Start</label><input type="date" id="homeLeaseStart"></div>
        <div class="form-group"><label>Lease End</label><input type="date" id="homeLeaseEnd"></div>
        <div class="form-group"><label>Tenant Name</label><input type="text" id="homeTenant"></div>
        <div class="form-group"><label>Tenant Phone</label><input type="tel" id="homeTenantPhone"></div>
        <div class="form-group full"><label>Maintenance Request</label><input type="text" id="homeMaintenance"></div>
        <div class="form-group full"><label>Notice</label><input type="text" id="homeNotice"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('homeModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitHomeForm()">Save Listing</button>
    </div>
  </div>
</div>

<!-- Apartment Unit Modal -->
<div class="modal-overlay" id="unitModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="unitModalTitle">Add Unit</h2><button class="modal-close" onclick="closeModal('unitModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group"><label>Unit *</label><input type="text" id="unitName"></div>
        <div class="form-group"><label>Address *</label><input type="text" id="unitAddress"></div>
        <div class="form-group"><label>Type *</label><input type="text" id="unitType"></div>
        <div class="form-group"><label>Price ($) *</label><input type="number" id="unitPrice" min="0"></div>
        <div class="form-group"><label>Rent/mo ($) *</label><input type="number" id="unitRent" min="0"></div>
        <div class="form-group"><label>Status</label><select id="unitStatus"><option value="vacant">Vacant</option><option value="listed">Listed</option><option value="occupied">Occupied</option></select></div>
        <div class="form-group full"><label>Building Announcement</label><input type="text" id="unitAnnouncement"></div>
        <div class="form-group full"><label>Turnover Tracking</label><input type="text" id="unitTurnover"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitUnitForm()">Save Unit</button>
    </div>
  </div>
</div>

<!-- Lead Modal -->
<div class="modal-overlay" id="leadModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="leadModalTitle">Add Lead</h2><button class="modal-close" onclick="closeModal('leadModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Lead Name *</label><input type="text" id="portalLeadName"></div>
        <div class="form-group"><label>Email</label><input type="email" id="portalLeadEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="portalLeadPhone"></div>
        <div class="form-group full"><label>Source / Qualification *</label><input type="text" id="portalLeadSource"></div>
        <div class="form-group"><label>Pipeline Stage</label>
          <select id="portalLeadStage">
            <option value="inquiry">Inquiry</option>
            <option value="qualified">Qualified</option>
            <option value="showing">Showing</option>
            <option value="offer">Offer</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="form-group"><label>Timeline</label>
          <select id="portalLeadTimeline">
            <option value="immediately">Immediately</option>
            <option value="in 3 months">In 3 months</option>
            <option value="in 6 months">In 6 months</option>
            <option value="later">Later</option>
          </select>
        </div>
        <div class="form-group full"><label>Preferences & Priorities *</label><input type="text" id="portalLeadPrefs"></div>
        <div class="form-group full"><label>Follow-up Pipeline Step *</label><input type="text" id="portalLeadFollowup"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('leadModal')">Cancel</button>
      <button class="btn btn-accent" onclick="submitLeadForm()">Save Lead</button>
    </div>
  </div>
</div>

<!-- Admin Report Modal -->
<div class="modal-overlay" id="adminModal">
  <div class="modal-box narrow">
    <div class="modal-head"><h2>Portfolio Report</h2><button class="modal-close" onclick="closeModal('adminModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Portfolio-Level Report *</label><input type="text" id="adminReport"></div>
        <div class="form-group full"><label>Workflow</label><input type="text" id="adminWorkflow"></div>
        <div class="form-group full"><label>Cross-Portal Monitoring</label><input type="text" id="adminMonitoring"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('adminModal')">Cancel</button><button class="btn btn-primary" onclick="submitAdminForm()">Save</button></div>
  </div>
</div>

<!-- Operations Modal -->
<div class="modal-overlay" id="opsModal">
  <div class="modal-box">
    <div class="modal-head"><h2>Work Order</h2><button class="modal-close" onclick="closeModal('opsModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Work Order Description *</label><input type="text" id="opsWorkOrder"></div>
        <div class="form-group"><label>Priority</label>
          <select id="opsPriority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
        </div>
        <div class="form-group"><label>Status</label>
          <select id="opsStatus"><option value="open">Open</option><option value="in-progress">In Progress</option><option value="closed">Closed</option></select>
        </div>
        <div class="form-group"><label>Assigned To</label><input type="text" id="opsAssigned"></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="opsDue"></div>
        <div class="form-group"><label>Estimated Cost ($)</label><input type="number" id="opsCost" min="0"></div>
        <div class="form-group full"><label>Service-Level Tracking</label><input type="text" id="opsServiceLevel"></div>
        <div class="form-group full"><label>Preventive Maintenance Log</label><input type="text" id="opsPreventive"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('opsModal')">Cancel</button><button class="btn btn-primary" onclick="submitOpsForm()">Save Work Order</button></div>
  </div>
</div>

<!-- Tenant Modal -->
<div class="modal-overlay" id="tenantModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="tenantModalTitle">Add Tenant</h2><button class="modal-close" onclick="closeModal('tenantModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group"><label>First Name *</label><input type="text" id="tenantFirst"></div>
        <div class="form-group"><label>Last Name *</label><input type="text" id="tenantLast"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="tenantEmail"></div>
        <div class="form-group"><label>Phone *</label><input type="tel" id="tenantPhone"></div>
        <div class="form-group"><label>Unit / Property</label><input type="text" id="tenantUnit"></div>
        <div class="form-group"><label>Monthly Rent ($)</label><input type="number" id="tenantRent" min="0"></div>
        <div class="form-group"><label>Lease Start</label><input type="date" id="tenantLeaseStart"></div>
        <div class="form-group"><label>Lease End</label><input type="date" id="tenantLeaseEnd"></div>
        <div class="form-group"><label>Emergency Contact</label><input type="text" id="tenantEmergency"></div>
        <div class="form-group"><label>Status</label>
          <select id="tenantStatus"><option value="active">Active</option><option value="notice">Notice Period</option><option value="past">Past</option></select>
        </div>
        <div class="form-group full"><label>Notes</label><textarea id="tenantNotes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('tenantModal')">Cancel</button><button class="btn btn-primary" onclick="submitTenantForm()">Save Tenant</button></div>
  </div>
</div>

<!-- Vacancy Modal -->
<div class="modal-overlay" id="vacancyModal">
  <div class="modal-box narrow">
    <div class="modal-head"><h2>Add Vacancy Record</h2><button class="modal-close" onclick="closeModal('vacancyModal')">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid-modal">
        <div class="form-group full"><label>Unit / Property *</label><input type="text" id="vacUnit"></div>
        <div class="form-group"><label>Vacant Since</label><input type="date" id="vacSince"></div>
        <div class="form-group"><label>Asking Rent ($/mo)</label><input type="number" id="vacRent" min="0"></div>
        <div class="form-group"><label>Stage</label>
          <select id="vacStage">
            <option value="vacant">Vacant</option>
            <option value="marketing">Marketing</option>
            <option value="showing">Showing</option>
            <option value="application">Application</option>
            <option value="approved">Approved</option>
          </select>
        </div>
        <div class="form-group"><label>Showings Scheduled</label><input type="number" id="vacShowings" min="0" value="0"></div>
        <div class="form-group"><label>Applications Received</label><input type="number" id="vacApps" min="0" value="0"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal('vacancyModal')">Cancel</button><button class="btn btn-primary" onclick="submitVacancyForm()">Save</button></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
//  GLOBAL STATE
// ═══════════════════════════════════════════════
let currentLeads = [], propertiesData = [], unitsData = [];
let confirmCallback = null;
let leadsTableVisible = true;

const adminPortalRows = [{id:1,report:'Monthly valuation + occupancy',workflow:'Budget approval pending CFO',monitoring:'Homes, apartments, leads all synced'}];
const homesPortalRows = [];
const apartmentPortalRows = [];
const leadsPortalRows = [];
const operationsPortalRows = [{id:1,workOrder:'Inspect roof — Unit 4B',priority:'high',status:'open',serviceLevel:'Target response < 24h',preventive:'Quarterly HVAC check logged',cost:0,assigned:'Vendor A',due:'2026-03-10'}];
const tenantsRows = [];
const notesRows = [];
const vacancyRows = [];

let nextId = {admin:2,home:1,apt:1,lead:1,ops:2,tenant:1,note:1,vac:1};

const viewTitles = {
  'overview':'Dashboard','analytics':'Analytics','admin-portal':'Admin Portal',
  'homes-portal':'Individual Homes','apartments-portal':'Apartments',
  'leads-portal':'Leads','operations-portal':'Maintenance',
  'tenants-view':'Tenants','properties-view':'Properties',
  'units-view':'Building Units','registrations-view':'Registrations',
  'roi-view':'ROI Calculator','notes-view':'Notes Log','vacancy-view':'Vacancy Pipeline'
};

// ═══════════════════════════════════════════════
//  NAVIGATION
// ═══════════════════════════════════════════════
function showView(id, el) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const viewEl = document.getElementById('view-'+id);
  if (viewEl) viewEl.classList.add('active');
  if (el) el.classList.add('active');
  else {
    const match = document.querySelector(`[data-view="${id}"]`);
    if (match) match.classList.add('active');
  }
  document.getElementById('topbarTitle').textContent = viewTitles[id]||id;
  if (window.innerWidth<900) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('open'); }
  if (id==='analytics') { renderAnalytics(); }
  if (id==='roi-view') calcROI();
  if (id==='vacancy-view') renderVacancyView();
  if (id==='notes-view') renderNotes();
  return false;
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

// ═══════════════════════════════════════════════
//  DARK MODE
// ═══════════════════════════════════════════════
function toggleDark() {
  const isDark = document.body.getAttribute('data-theme')==='dark';
  document.body.setAttribute('data-theme', isDark?'':'dark');
  document.getElementById('darkLabel').textContent = isDark?'Light':'Dark';
}

// ═══════════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════════
function showToast(msg,type='success') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=type==='error'?'show error':type==='warn'?'show warn':'show';
  clearTimeout(t._t); t._t=setTimeout(()=>{t.className='';},3000);
}

// ═══════════════════════════════════════════════
//  CONFIRM
// ═══════════════════════════════════════════════
function openConfirm(title,msg,cb) {
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  confirmCallback=cb;
  document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm(r) {
  document.getElementById('confirmOverlay').classList.remove('active');
  if(r&&confirmCallback) confirmCallback(); confirmCallback=null;
}

function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}

// ═══════════════════════════════════════════════
//  BADGES
// ═══════════════════════════════════════════════
function statusBadge(s){
  const m={occupied:'badge-green',listed:'badge-blue',vacant:'badge-gold',vacancy:'badge-gold',sold:'badge-gray',active:'badge-green',notice:'badge-orange',past:'badge-gray','in-progress':'badge-blue',open:'badge-red',closed:'badge-gray',approved:'badge-green',marketing:'badge-blue',showing:'badge-gold',application:'badge-orange'};
  return `<span class="badge ${m[s]||'badge-gray'}">${s}</span>`;
}
function priorityBadge(p){
  const m={high:'priority-high',medium:'priority-med',low:'priority-low'};
  return `<span class="${m[p]||''}">▲ ${p}</span>`;
}
function timelineBadge(t){
  const m={'immediately':'badge-red','in 3 months':'badge-orange','in 6 months':'badge-gold','later':'badge-gray'};
  return `<span class="badge ${m[t]||'badge-gray'}">${t}</span>`;
}

// ═══════════════════════════════════════════════
//  TABLE SORT
// ═══════════════════════════════════════════════
let sortState = {};
function sortTable(tbodyId, colIdx, thEl) {
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const key = tbodyId+colIdx;
  const asc = sortState[key] !== true;
  sortState[key] = asc;
  document.querySelectorAll('th.sorted-asc,th.sorted-desc').forEach(t=>{t.classList.remove('sorted-asc','sorted-desc');});
  if(thEl) thEl.classList.add(asc?'sorted-asc':'sorted-desc');
  rows.sort((a,b)=>{
    const ta=(a.cells[colIdx]?.textContent||'').trim();
    const tb=(b.cells[colIdx]?.textContent||'').trim();
    const na=parseFloat(ta.replace(/[^0-9.-]/g,'')), nb=parseFloat(tb.replace(/[^0-9.-]/g,''));
    if(!isNaN(na)&&!isNaN(nb)) return asc?na-nb:nb-na;
    return asc?ta.localeCompare(tb):tb.localeCompare(ta);
  });
  rows.forEach(r=>tbody.appendChild(r));
}

// ═══════════════════════════════════════════════
//  ALERTS / SMART NOTIFICATIONS
// ═══════════════════════════════════════════════
function renderAlerts() {
  const alerts = [];
  const today = new Date();

  // Expiring leases
  tenantsRows.forEach(t => {
    if (t.leaseEnd) {
      const end = new Date(t.leaseEnd);
      const days = Math.round((end-today)/(1000*60*60*24));
      if (days >= 0 && days <= 30) alerts.push({type:'warn',msg:`<strong>${t.first} ${t.last}</strong>'s lease expires in <strong>${days} days</strong> (${t.unit})`});
    }
  });
  homesPortalRows.forEach(h => {
    if (h.leaseEnd) {
      const end = new Date(h.leaseEnd);
      const days = Math.round((end-today)/(1000*60*60*24));
      if (days >= 0 && days <= 30) alerts.push({type:'warn',msg:`<strong>${h.address}</strong> lease expires in <strong>${days} days</strong>`});
    }
  });

  // High priority open work orders
  const highOpen = operationsPortalRows.filter(o=>o.priority==='high'&&o.status==='open');
  if (highOpen.length) alerts.push({type:'danger',msg:`<strong>${highOpen.length} high-priority</strong> work order${highOpen.length>1?'s':''} still open`});

  // Overdue work orders
  operationsPortalRows.filter(o=>o.due&&o.status!=='closed').forEach(o=>{
    const due=new Date(o.due);
    if(due<today) alerts.push({type:'danger',msg:`Work order overdue: <strong>${o.workOrder}</strong>`});
  });

  // Vacant units
  const vacant = [...apartmentPortalRows.filter(a=>a.status==='vacant'), ...homesPortalRows.filter(h=>h.status==='vacancy')];
  if (vacant.length) alerts.push({type:'info',msg:`<strong>${vacant.length}</strong> unit${vacant.length>1?'s':''} currently vacant — consider listing`});

  // Success: all occupied
  const totalLocal = apartmentPortalRows.length + homesPortalRows.length;
  if (totalLocal > 0 && vacant.length === 0) alerts.push({type:'success',msg:'All tracked units are occupied. Full occupancy! 🎉'});

  const el = document.getElementById('alertBanner');
  if (!alerts.length) { el.innerHTML=''; return; }
  el.innerHTML = `<div class="section-card" style="margin-bottom:20px;"><div class="section-header"><h2>Notifications</h2><button class="btn btn-sm" onclick="document.getElementById('alertBanner').innerHTML=''">Dismiss All</button></div><div class="alert-list">${
    alerts.map(a=>`<div class="alert-item ${a.type}"><div class="alert-dot"></div><div class="alert-text">${a.msg}</div></div>`).join('')
  }</div></div>`;
}

// ═══════════════════════════════════════════════
//  STATS
// ═══════════════════════════════════════════════
function updateStats() {
  document.getElementById('totalLeads').textContent = currentLeads.length||'—';
  document.getElementById('totalProperties').textContent = propertiesData.length||'—';
  document.getElementById('totalUnits').textContent = unitsData.length||'—';

  const propVal = propertiesData.reduce((s,p)=>s+(p.current_value||0),0);
  const unitVal = unitsData.reduce((s,u)=>s+(u.value||0),0);
  const total = propVal+unitVal;
  document.getElementById('portfolioValue').textContent = total>0?'$'+(total/1e6).toFixed(1)+'M':'—';

  const occupied = unitsData.filter(u=>u.status==='occupied');
  const occ = unitsData.length?Math.round(occupied.length/unitsData.length*100):0;
  document.getElementById('occupancyRate').textContent = unitsData.length?occ+'%':'—';
  const occAlert = document.getElementById('occupancyAlert');
  if (occ>0&&occ<70) occAlert.innerHTML='<div class="stat-alert">Below target — consider pricing</div>';
  else occAlert.innerHTML='';

  const monthlyRev = occupied.reduce((s,u)=>s+(u.rent||0),0);
  document.getElementById('monthlyRevenue').textContent = monthlyRev>0?'$'+monthlyRev.toLocaleString():'—';
  document.getElementById('avgRent').textContent = occupied.length?'Avg $'+(monthlyRev/occupied.length).toFixed(0)+'/mo':'';

  const vacantUnits = unitsData.filter(u=>u.status==='vacant').length;
  document.getElementById('vacantCount').textContent = vacantUnits||'—';
  document.getElementById('unitsVacant').textContent = vacantUnits>0?vacantUnits+' vacant':'All occupied';

  const activeTenants = tenantsRows.filter(t=>t.status==='active').length;
  document.getElementById('activeTenants').textContent = activeTenants||'—';
  const expiring = tenantsRows.filter(t=>{
    if(!t.leaseEnd)return false;
    const d=Math.round((new Date(t.leaseEnd)-new Date())/(1000*60*60*24));
    return d>=0&&d<=30;
  }).length;
  document.getElementById('expiringLeases').textContent = expiring>0?expiring+' lease(s) expiring soon':'';

  const openOrders = operationsPortalRows.filter(o=>o.status==='open'||o.status==='in-progress').length;
  document.getElementById('openWorkOrders').textContent = openOrders||'—';
  const maintAlertEl = document.getElementById('maintAlert');
  const highPrio = operationsPortalRows.filter(o=>o.priority==='high'&&o.status!=='closed').length;
  if(highPrio>0) maintAlertEl.innerHTML=`<div class="stat-alert">${highPrio} high priority open</div>`;
  else maintAlertEl.innerHTML='';

  // KPI
  const avgUnitVal = unitsData.length?total/unitsData.length:0;
  document.getElementById('avgUnitValue').textContent = avgUnitVal>0?'$'+(avgUnitVal/1000).toFixed(0)+'K':'—';
  const avgUnitRent = unitsData.length?unitsData.reduce((s,u)=>s+(u.rent||0),0)/unitsData.length:0;
  document.getElementById('avgUnitRent').textContent = avgUnitRent>0?'$'+avgUnitRent.toFixed(0):leadsPortalRows.length||'—';
  document.getElementById('avgUnitRent').textContent = avgUnitRent>0?'$'+avgUnitRent.toFixed(0)+'/mo':'—';
  const annualRent = monthlyRev*12;
  const gy = total>0?((annualRent/total)*100).toFixed(1)+'%':'—';
  document.getElementById('grossYield').textContent = gy;
  document.getElementById('homesListed').textContent = homesPortalRows.filter(h=>h.status==='listed').length||'—';
  document.getElementById('pipelineLeads').textContent = leadsPortalRows.length||'—';

  // Badges
  const lbEl = document.getElementById('leadsBadge');
  if(leadsPortalRows.length>0){lbEl.textContent=leadsPortalRows.length;lbEl.style.display='';}else lbEl.style.display='none';
  const mbEl = document.getElementById('maintBadge');
  if(openOrders>0){mbEl.textContent=openOrders;mbEl.style.display='';}else mbEl.style.display='none';

  renderRevChart();
  renderOccupancyGauges();
  renderAlerts();
}

// ═══════════════════════════════════════════════
//  REVENUE BAR CHART (simulated 6-month)
// ═══════════════════════════════════════════════
function renderRevChart() {
  const el = document.getElementById('revChart');
  if (!el) return;
  const base = unitsData.filter(u=>u.status==='occupied').reduce((s,u)=>s+(u.rent||0),0);
  if (!base) { el.innerHTML='<div style="font-size:0.72rem;color:var(--muted);padding:20px">No revenue data yet.</div>'; return; }
  const months = ['Sep','Oct','Nov','Dec','Jan','Feb'];
  const vals = months.map((_,i)=>Math.round(base*(0.88+i*0.024+Math.random()*0.04)));
  const max = Math.max(...vals);
  el.innerHTML = months.map((m,i)=>`
    <div class="bar-col">
      <div class="bar-val">$${(vals[i]/1000).toFixed(1)}K</div>
      <div class="bar" style="height:${Math.round(vals[i]/max*70)}px" title="${m}: $${vals[i].toLocaleString()}"></div>
      <div class="bar-label">${m}</div>
    </div>`).join('');
}

// ═══════════════════════════════════════════════
//  OCCUPANCY GAUGE
// ═══════════════════════════════════════════════
function renderOccupancyGauges() {
  const el = document.getElementById('occupancyGauges');
  if (!el) return;
  const apts = apartmentPortalRows.length;
  const aptOcc = apts ? apartmentPortalRows.filter(a=>a.status==='occupied').length : 0;
  const homes = homesPortalRows.length;
  const homeOcc = homes ? homesPortalRows.filter(h=>h.status==='occupied').length : 0;
  const units = unitsData.length;
  const unitOcc = units ? unitsData.filter(u=>u.status==='occupied').length : 0;

  const gauges = [
    {label:'Apartments', occ:aptOcc, total:apts},
    {label:'Homes', occ:homeOcc, total:homes},
    {label:'All Units', occ:unitOcc, total:units},
  ];
  el.innerHTML = gauges.map(g=>{
    const pct = g.total?Math.round(g.occ/g.total*100):0;
    const deg = Math.round(pct/100*360);
    return `<div class="gauge-item">
      <div class="gauge-ring" style="background:conic-gradient(var(--accent) ${deg}deg, var(--border) 0deg);">
        <div class="gauge-inner"><span class="gauge-pct">${g.total?pct+'%':'—'}</span></div>
      </div>
      <div class="gauge-label">${g.label}</div>
    </div>`;
  }).join('');
}

// ═══════════════════════════════════════════════
//  ANALYTICS VIEW
// ═══════════════════════════════════════════════
function renderAnalytics() {
  const propVal = propertiesData.reduce((s,p)=>s+(p.current_value||0),0);
  const unitVal = unitsData.reduce((s,u)=>s+(u.value||0),0);
  const total = propVal+unitVal;
  const occupied = unitsData.filter(u=>u.status==='occupied');
  const monthlyRev = occupied.reduce((s,u)=>s+(u.rent||0),0);
  const annualRev = monthlyRev*12;
  const expenses = annualRev*0.35; // estimated
  const noi = annualRev-expenses;
  const capRate = total>0?((noi/total)*100).toFixed(2):0;
  const gy = total>0?((annualRev/total)*100).toFixed(2):0;
  const occ = unitsData.length?Math.round(occupied.length/unitsData.length*100):0;

  document.getElementById('a_noi').textContent = noi>0?'$'+(noi/1000).toFixed(0)+'K':'—';
  document.getElementById('a_cap').textContent = capRate>0?capRate+'%':'—';
  document.getElementById('a_yield').textContent = gy>0?gy+'%':'—';
  document.getElementById('a_occ').textContent = unitsData.length?occ+'%':'—';

  // Funnel
  const allLeads = leadsPortalRows.length + currentLeads.length;
  const stages = [
    {label:'Total Leads', count:allLeads||12},
    {label:'Qualified', count:Math.round((allLeads||12)*0.7)},
    {label:'Showing', count:Math.round((allLeads||12)*0.45)},
    {label:'Offer', count:Math.round((allLeads||12)*0.2)},
    {label:'Closed', count:Math.round((allLeads||12)*0.1)},
  ];
  const maxC = stages[0].count||1;
  document.getElementById('leadFunnel').innerHTML = stages.map((s,i)=>{
    const pct = Math.round(s.count/maxC*100);
    const colors = ['var(--primary)','#2d5e38','#4a8a5b','var(--accent)','#b08f4a'];
    return `<div class="funnel-stage">
      <div class="funnel-label">${s.label}</div>
      <div class="funnel-bar-wrap">
        <div class="funnel-bar" style="width:${pct}%;background:${colors[i]};"><span>${s.count}</span></div>
      </div>
      <div class="funnel-count">${pct}%</div>
    </div>`;
  }).join('');

  // Status breakdown
  const statusGroups = {};
  [...apartmentPortalRows,...unitsData,...homesPortalRows].forEach(u=>{
    const s=u.status||'unknown';
    statusGroups[s]=(statusGroups[s]||0)+1;
  });
  const colors={occupied:'var(--success)',listed:'var(--info)',vacant:'var(--warn)',vacancy:'var(--warn)',sold:'var(--muted)'};
  const totalItems = Object.values(statusGroups).reduce((a,b)=>a+b,0)||1;
  document.getElementById('statusBreakdown').innerHTML = Object.entries(statusGroups).map(([k,v])=>`
    <div class="funnel-stage">
      <div class="funnel-label">${k}</div>
      <div class="funnel-bar-wrap">
        <div class="funnel-bar" style="width:${Math.round(v/totalItems*100)}%;background:${'occupied'===k?'var(--success)':'listed'===k?'var(--info)':'vacant'===k||'vacancy'===k?'var(--warn)':'var(--muted)'};">
          <span>${v}</span>
        </div>
      </div>
      <div class="funnel-count">${Math.round(v/totalItems*100)}%</div>
    </div>`).join('') || '<div class="empty-state">No unit data yet.</div>';

  renderRentRoll();
}

function renderRentRoll() {
  const filter = document.getElementById('rentRollFilter')?.value||'all';
  const data = unitsData.filter(u=>filter==='all'||u.status===filter);
  document.getElementById('rentRollBody').innerHTML = data.length ? data.map(u=>{
    const annual = (u.rent||0)*12;
    const yld = u.value>0?((annual/u.value)*100).toFixed(2)+'%':'—';
    return `<tr><td><strong>${u.unit}</strong></td><td>${statusBadge(u.status)}</td><td>$${Number(u.value).toLocaleString()}</td><td>$${Number(u.rent).toLocaleString()}/mo</td><td>$${annual.toLocaleString()}</td><td><strong>${yld}</strong></td></tr>`;
  }).join('') : '<tr><td colspan="6"><div class="empty-state">No unit data.</div></td></tr>';
}

// ═══════════════════════════════════════════════
//  ADMIN PORTAL
// ═══════════════════════════════════════════════
function renderAdminPortal() {
  const q=''; const tbody=document.getElementById('adminPortalTableBody');
  tbody.innerHTML = adminPortalRows.length ? adminPortalRows.map(r=>`<tr>
    <td>${r.report}</td><td>${r.workflow}</td><td>${r.monitoring}</td>
    <td><button class="btn btn-sm" onclick="editAdminRow(${r.id})">Edit</button>
    <button class="btn btn-sm btn-danger" onclick="delAdminRow(${r.id})">Delete</button></td>
  </tr>`).join('') : '<tr><td colspan="4"><div class="empty-state">No reports yet.</div></td></tr>';
}
function openAdminModal(id=null){
  const e=id?adminPortalRows.find(r=>r.id===id):null;
  document.getElementById('adminReport').value=e?.report||'';
  document.getElementById('adminWorkflow').value=e?.workflow||'';
  document.getElementById('adminMonitoring').value=e?.monitoring||'';
  document.getElementById('adminModal').dataset.editId=id||'';
  openModal('adminModal');
}
function submitAdminForm(){
  const r=document.getElementById('adminReport').value.trim();
  if(!r)return showToast('Report required.','error');
  const eid=parseInt(document.getElementById('adminModal').dataset.editId);
  const d={report:r,workflow:document.getElementById('adminWorkflow').value.trim(),monitoring:document.getElementById('adminMonitoring').value.trim()};
  if(eid){Object.assign(adminPortalRows.find(x=>x.id===eid)||{},d);}
  else adminPortalRows.push({id:nextId.admin++,...d});
  closeModal('adminModal'); renderAdminPortal(); showToast('Report saved.');
}
function editAdminRow(id){openAdminModal(id);}
function delAdminRow(id){openConfirm('Delete Report','Remove this portfolio report?',()=>{const i=adminPortalRows.findIndex(r=>r.id===id);if(i>-1)adminPortalRows.splice(i,1);renderAdminPortal();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  HOMES PORTAL
// ═══════════════════════════════════════════════
function renderHomesPortal(){
  const q=(document.getElementById('homesSearch')?.value||'').toLowerCase();
  const sf=(document.getElementById('homesStatusFilter')?.value)||'all';
  let rows=homesPortalRows.filter(r=>(sf==='all'||r.status===sf)&&(!q||JSON.stringify(r).toLowerCase().includes(q)));
  document.getElementById('homePortalTableBody').innerHTML=rows.length?rows.map(r=>`<tr>
    <td><strong>${r.address}</strong></td>
    <td>${statusBadge(r.status)}</td>
    <td>${r.lease}${r.rent?` — $${Number(r.rent).toLocaleString()}/mo`:''}</td>
    <td>${r.maintenance||'<span style="color:var(--muted)">—</span>'}</td>
    <td>${r.notice||'<span style="color:var(--muted)">—</span>'}</td>
    <td>${r.tenant||'<span style="color:var(--muted)">—</span>'}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="viewDetail('home',${r.id})">View</button>
      <button class="btn btn-sm" onclick="editHomeRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delHomeRow(${r.id})">Del</button>
    </td>
  </tr>`).join(''):`<tr><td colspan="7"><div class="empty-state">No home listings yet.</div></td></tr>`;
  updateStats();
}
function openHomeModal(id=null){
  const e=id?homesPortalRows.find(r=>r.id===id):null;
  document.getElementById('homeAddress').value=e?.address||'';
  document.getElementById('homeStatus').value=e?.status||'occupied';
  document.getElementById('homeLease').value=e?.lease||'';
  document.getElementById('homeRent').value=e?.rent||'';
  document.getElementById('homeLeaseStart').value=e?.leaseStart||'';
  document.getElementById('homeLeaseEnd').value=e?.leaseEnd||'';
  document.getElementById('homeTenant').value=e?.tenant||'';
  document.getElementById('homeTenantPhone').value=e?.tenantPhone||'';
  document.getElementById('homeMaintenance').value=e?.maintenance||'';
  document.getElementById('homeNotice').value=e?.notice||'';
  document.getElementById('homeModalTitle').textContent=id?'Edit Listing':'Create Home Listing';
  document.getElementById('homeModal').dataset.editId=id||'';
  openModal('homeModal');
}
function submitHomeForm(){
  const address=document.getElementById('homeAddress').value.trim();
  if(!address)return showToast('Address required.','error');
  const eid=parseInt(document.getElementById('homeModal').dataset.editId);
  const d={address,status:document.getElementById('homeStatus').value,lease:document.getElementById('homeLease').value.trim(),
    rent:document.getElementById('homeRent').value,leaseStart:document.getElementById('homeLeaseStart').value,
    leaseEnd:document.getElementById('homeLeaseEnd').value,tenant:document.getElementById('homeTenant').value.trim(),
    tenantPhone:document.getElementById('homeTenantPhone').value.trim(),
    maintenance:document.getElementById('homeMaintenance').value.trim(),notice:document.getElementById('homeNotice').value.trim()};
  if(eid){Object.assign(homesPortalRows.find(x=>x.id===eid)||{},d);}
  else homesPortalRows.unshift({id:nextId.home++,...d});
  closeModal('homeModal'); renderHomesPortal(); updateStats(); showToast(eid?'Listing updated.':'Listing created.');
}
function editHomeRow(id){openHomeModal(id);}
function delHomeRow(id){openConfirm('Delete Listing','Remove this home listing?',()=>{const i=homesPortalRows.findIndex(r=>r.id===id);if(i>-1)homesPortalRows.splice(i,1);renderHomesPortal();updateStats();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  APARTMENTS PORTAL
// ═══════════════════════════════════════════════
function renderApartmentsPortal(){
  const q=(document.getElementById('aptsSearch')?.value||'').toLowerCase();
  const sf=(document.getElementById('aptsStatusFilter')?.value)||'all';
  let rows=apartmentPortalRows.filter(r=>(sf==='all'||r.status===sf)&&(!q||JSON.stringify(r).toLowerCase().includes(q)));
  document.getElementById('apartmentPortalTableBody').innerHTML=rows.length?rows.map(r=>`<tr>
    <td><strong>${r.unit}</strong><br><small style="color:var(--muted)">${r.address}</small><br><small>${r.type}</small></td>
    <td>$${Number(r.price).toLocaleString()}</td>
    <td>$${Number(r.rent).toLocaleString()}/mo</td>
    <td>${statusBadge(r.status)}</td>
    <td>${r.announcement||'—'}</td>
    <td>${r.turnover||'—'}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editAptRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delAptRow(${r.id})">Del</button>
    </td>
  </tr>`).join(''):`<tr><td colspan="7"><div class="empty-state">No apartment units yet.</div></td></tr>`;
  updateStats();
}
function openUnitModal(id=null){
  const e=id?apartmentPortalRows.find(r=>r.id===id):null;
  document.getElementById('unitName').value=e?.unit||'';
  document.getElementById('unitAddress').value=e?.address||'';
  document.getElementById('unitType').value=e?.type||'';
  document.getElementById('unitPrice').value=e?.price||'';
  document.getElementById('unitRent').value=e?.rent||'';
  document.getElementById('unitStatus').value=e?.status||'vacant';
  document.getElementById('unitAnnouncement').value=e?.announcement||'';
  document.getElementById('unitTurnover').value=e?.turnover||'';
  document.getElementById('unitModalTitle').textContent=id?'Edit Unit':'Add Apartment Unit';
  document.getElementById('unitModal').dataset.editId=id||'';
  openModal('unitModal');
}
function submitUnitForm(){
  const unit=document.getElementById('unitName').value.trim();
  if(!unit)return showToast('Unit name required.','error');
  const eid=parseInt(document.getElementById('unitModal').dataset.editId);
  const d={unit,address:document.getElementById('unitAddress').value.trim(),type:document.getElementById('unitType').value.trim(),
    price:Number(document.getElementById('unitPrice').value),rent:Number(document.getElementById('unitRent').value),
    status:document.getElementById('unitStatus').value,announcement:document.getElementById('unitAnnouncement').value.trim(),
    turnover:document.getElementById('unitTurnover').value.trim()};
  if(eid){Object.assign(apartmentPortalRows.find(x=>x.id===eid)||{},d);}
  else apartmentPortalRows.unshift({id:nextId.apt++,...d});
  closeModal('unitModal'); renderApartmentsPortal(); updateStats(); showToast(eid?'Unit updated.':'Unit created.');
}
function editAptRow(id){openUnitModal(id);}
function delAptRow(id){openConfirm('Delete Unit','Remove this apartment unit?',()=>{const i=apartmentPortalRows.findIndex(r=>r.id===id);if(i>-1)apartmentPortalRows.splice(i,1);renderApartmentsPortal();updateStats();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  LEADS PORTAL
// ═══════════════════════════════════════════════
const PIPELINE_STAGES = ['inquiry','qualified','showing','offer','closed'];
function renderLeadsPipeline(){
  const board=document.getElementById('leadsPipelineBoard');
  board.innerHTML = PIPELINE_STAGES.map(stage=>{
    const cards=leadsPortalRows.filter(r=>r.stage===stage);
    return `<div class="pipeline-col">
      <div class="pipeline-col-head">${stage.charAt(0).toUpperCase()+stage.slice(1)}<span>${cards.length}</span></div>
      ${cards.map(c=>`<div class="pipeline-card" onclick="viewDetail('lead',${c.id})">
        <div class="pipeline-card-name">${c.name}</div>
        <div class="pipeline-card-sub">${c.source}</div>
        <div style="margin-top:6px;">${timelineBadge(c.timeline)}</div>
      </div>`).join('')||'<div style="font-size:0.7rem;color:var(--muted);text-align:center;padding:12px;">Empty</div>'}
    </div>`;
  }).join('');
}
function toggleLeadsView(){
  leadsTableVisible=!leadsTableVisible;
  document.getElementById('leadsTableCard').style.display=leadsTableVisible?'':'none';
}
function renderLeadsPortal(){
  const q=(document.getElementById('leadsSearch')?.value||'').toLowerCase();
  const tf=(document.getElementById('leadsTimelineFilter')?.value)||'all';
  let rows=leadsPortalRows.filter(r=>(tf==='all'||r.timeline===tf)&&(!q||JSON.stringify(r).toLowerCase().includes(q)));
  document.getElementById('leadPortalTableBody').innerHTML=rows.length?rows.map(r=>`<tr>
    <td><strong>${r.name}</strong></td>
    <td>${r.email?`<a href="mailto:${r.email}" style="color:var(--primary)">${r.email}</a>`:'—'}</td>
    <td>${r.source}</td>
    <td>${timelineBadge(r.timeline)}</td>
    <td>${r.preferences}</td>
    <td>${r.followup}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editLeadRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delLeadRow(${r.id})">Del</button>
    </td>
  </tr>`).join(''):`<tr><td colspan="7"><div class="empty-state">No leads yet. Add one above.</div></td></tr>`;
  renderLeadsPipeline();
  updateStats();
}
function openLeadModal(id=null){
  const e=id?leadsPortalRows.find(r=>r.id===id):null;
  document.getElementById('portalLeadName').value=e?.name||'';
  document.getElementById('portalLeadEmail').value=e?.email||'';
  document.getElementById('portalLeadPhone').value=e?.phone||'';
  document.getElementById('portalLeadSource').value=e?.source||'';
  document.getElementById('portalLeadStage').value=e?.stage||'inquiry';
  document.getElementById('portalLeadTimeline').value=e?.timeline||'immediately';
  document.getElementById('portalLeadPrefs').value=e?.preferences||'';
  document.getElementById('portalLeadFollowup').value=e?.followup||'';
  document.getElementById('leadModalTitle').textContent=id?'Edit Lead':'Add Lead';
  document.getElementById('leadModal').dataset.editId=id||'';
  openModal('leadModal');
}
function submitLeadForm(){
  const name=document.getElementById('portalLeadName').value.trim();
  if(!name)return showToast('Name required.','error');
  const eid=parseInt(document.getElementById('leadModal').dataset.editId);
  const d={name,email:document.getElementById('portalLeadEmail').value.trim(),phone:document.getElementById('portalLeadPhone').value.trim(),
    source:document.getElementById('portalLeadSource').value.trim(),stage:document.getElementById('portalLeadStage').value,
    timeline:document.getElementById('portalLeadTimeline').value,preferences:document.getElementById('portalLeadPrefs').value.trim(),
    followup:document.getElementById('portalLeadFollowup').value.trim()};
  if(eid){Object.assign(leadsPortalRows.find(x=>x.id===eid)||{},d);}
  else leadsPortalRows.unshift({id:nextId.lead++,...d});
  closeModal('leadModal'); renderLeadsPortal(); showToast(eid?'Lead updated.':'Lead added.');
}
function editLeadRow(id){openLeadModal(id);}
function delLeadRow(id){openConfirm('Delete Lead','Remove this lead?',()=>{const i=leadsPortalRows.findIndex(r=>r.id===id);if(i>-1)leadsPortalRows.splice(i,1);renderLeadsPortal();showToast('Deleted.');})}
function exportLeadsCSV(){
  const data=leadsPortalRows;
  if(!data.length)return showToast('No leads to export.','error');
  const k=['name','email','phone','source','stage','timeline','preferences','followup'];
  const csv=[k.join(','),...data.map(r=>k.map(k=>`"${r[k]||''}"`).join(','))].join('\n');
  const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);
  const a=document.createElement('a');a.href=u;a.download=`leads_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(u);
  showToast('Leads exported.');
}

// ═══════════════════════════════════════════════
//  OPERATIONS / MAINTENANCE
// ═══════════════════════════════════════════════
function renderOperationsPortal(){
  const sf=(document.getElementById('maintStatusFilter')?.value)||'all';
  const pf=(document.getElementById('maintPriorityFilter')?.value)||'all';
  let rows=operationsPortalRows.filter(r=>(sf==='all'||r.status===sf)&&(pf==='all'||r.priority===pf));
  const today=new Date();
  document.getElementById('operationsPortalTableBody').innerHTML=rows.length?rows.map(r=>{
    const overdue=r.due&&new Date(r.due)<today&&r.status!=='closed';
    return`<tr${overdue?' style="background:#fef8f8"':''}>
    <td><strong>${r.workOrder}</strong>${overdue?'<br><span style="font-size:0.62rem;color:var(--danger);font-weight:700">OVERDUE</span>':''}</td>
    <td>${priorityBadge(r.priority)}</td>
    <td>${statusBadge(r.status)}</td>
    <td>${r.serviceLevel||'—'}</td>
    <td>${r.preventive||'—'}</td>
    <td>${r.cost>0?'$'+Number(r.cost).toLocaleString():'—'}</td>
    <td>${r.assigned||'—'}</td>
    <td class="${overdue?'priority-high':''}">${r.due||'—'}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editOpsRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delOpsRow(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state">No work orders.</div></td></tr>`;
  updateStats();
}
function openOpsModal(id=null){
  const e=id?operationsPortalRows.find(r=>r.id===id):null;
  document.getElementById('opsWorkOrder').value=e?.workOrder||'';
  document.getElementById('opsPriority').value=e?.priority||'high';
  document.getElementById('opsStatus').value=e?.status||'open';
  document.getElementById('opsAssigned').value=e?.assigned||'';
  document.getElementById('opsDue').value=e?.due||'';
  document.getElementById('opsCost').value=e?.cost||'';
  document.getElementById('opsServiceLevel').value=e?.serviceLevel||'';
  document.getElementById('opsPreventive').value=e?.preventive||'';
  document.getElementById('opsModal').dataset.editId=id||'';
  openModal('opsModal');
}
function submitOpsForm(){
  const wo=document.getElementById('opsWorkOrder').value.trim();
  if(!wo)return showToast('Work order required.','error');
  const eid=parseInt(document.getElementById('opsModal').dataset.editId);
  const d={workOrder:wo,priority:document.getElementById('opsPriority').value,status:document.getElementById('opsStatus').value,
    assigned:document.getElementById('opsAssigned').value.trim(),due:document.getElementById('opsDue').value,
    cost:Number(document.getElementById('opsCost').value)||0,serviceLevel:document.getElementById('opsServiceLevel').value.trim(),
    preventive:document.getElementById('opsPreventive').value.trim()};
  if(eid){Object.assign(operationsPortalRows.find(x=>x.id===eid)||{},d);}
  else operationsPortalRows.push({id:nextId.ops++,...d});
  closeModal('opsModal'); renderOperationsPortal(); showToast(eid?'Work order updated.':'Work order added.');
}
function editOpsRow(id){openOpsModal(id);}
function delOpsRow(id){openConfirm('Delete Work Order','Remove this work order?',()=>{const i=operationsPortalRows.findIndex(r=>r.id===id);if(i>-1)operationsPortalRows.splice(i,1);renderOperationsPortal();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  TENANTS
// ═══════════════════════════════════════════════
function renderTenants(){
  const q=(document.getElementById('tenantsSearch')?.value||'').toLowerCase();
  let rows=tenantsRows.filter(r=>!q||JSON.stringify(r).toLowerCase().includes(q));
  const today=new Date();
  document.getElementById('tenantsTableBody').innerHTML=rows.length?rows.map(r=>{
    const expiring=r.leaseEnd&&Math.round((new Date(r.leaseEnd)-today)/(1000*60*60*24))<=30;
    return`<tr${expiring?' style="background:#fffbf0"':''}>
    <td><strong>${r.first} ${r.last}</strong>${expiring?'<br><span style="font-size:0.62rem;color:var(--warn);font-weight:700">LEASE EXPIRING SOON</span>':''}</td>
    <td>${r.unit||'—'}</td>
    <td>${r.email?`<a href="mailto:${r.email}" style="color:var(--primary)">${r.email}</a>`:'—'}</td>
    <td>${r.phone||'—'}</td>
    <td>${r.leaseStart||'—'}</td>
    <td class="${expiring?'priority-med':''}">${r.leaseEnd||'—'}</td>
    <td>$${Number(r.rent||0).toLocaleString()}/mo</td>
    <td>${statusBadge(r.status)}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editTenantRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delTenantRow(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state">No tenants yet. Add one above.</div></td></tr>`;
  updateStats();
  // update note property selector
  updateNoteSelectors();
}
function openTenantModal(id=null){
  const e=id?tenantsRows.find(r=>r.id===id):null;
  ['First','Last','Email','Phone','Unit','Rent','LeaseStart','LeaseEnd','Emergency','Notes'].forEach(k=>{
    const el=document.getElementById('tenant'+k);
    if(el) el.value=e?.[k.toLowerCase()]||e?.[k.charAt(0).toLowerCase()+k.slice(1)]||'';
  });
  document.getElementById('tenantStatus').value=e?.status||'active';
  document.getElementById('tenantFirst').value=e?.first||'';
  document.getElementById('tenantLast').value=e?.last||'';
  document.getElementById('tenantEmail').value=e?.email||'';
  document.getElementById('tenantPhone').value=e?.phone||'';
  document.getElementById('tenantUnit').value=e?.unit||'';
  document.getElementById('tenantRent').value=e?.rent||'';
  document.getElementById('tenantLeaseStart').value=e?.leaseStart||'';
  document.getElementById('tenantLeaseEnd').value=e?.leaseEnd||'';
  document.getElementById('tenantEmergency').value=e?.emergency||'';
  document.getElementById('tenantNotes').value=e?.notes||'';
  document.getElementById('tenantModalTitle').textContent=id?'Edit Tenant':'Add Tenant';
  document.getElementById('tenantModal').dataset.editId=id||'';
  openModal('tenantModal');
}
function submitTenantForm(){
  const first=document.getElementById('tenantFirst').value.trim();
  if(!first)return showToast('Name required.','error');
  const eid=parseInt(document.getElementById('tenantModal').dataset.editId);
  const d={first,last:document.getElementById('tenantLast').value.trim(),email:document.getElementById('tenantEmail').value.trim(),
    phone:document.getElementById('tenantPhone').value.trim(),unit:document.getElementById('tenantUnit').value.trim(),
    rent:Number(document.getElementById('tenantRent').value)||0,leaseStart:document.getElementById('tenantLeaseStart').value,
    leaseEnd:document.getElementById('tenantLeaseEnd').value,emergency:document.getElementById('tenantEmergency').value.trim(),
    status:document.getElementById('tenantStatus').value,notes:document.getElementById('tenantNotes').value.trim()};
  if(eid){Object.assign(tenantsRows.find(x=>x.id===eid)||{},d);}
  else tenantsRows.unshift({id:nextId.tenant++,...d});
  closeModal('tenantModal'); renderTenants(); showToast(eid?'Tenant updated.':'Tenant added.');
}
function editTenantRow(id){openTenantModal(id);}
function delTenantRow(id){openConfirm('Delete Tenant','Remove this tenant record?',()=>{const i=tenantsRows.findIndex(r=>r.id===id);if(i>-1)tenantsRows.splice(i,1);renderTenants();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  ROI CALCULATOR
// ═══════════════════════════════════════════════
function calcROI(){
  const purchase=parseFloat(document.getElementById('roi_purchase').value)||0;
  const value=parseFloat(document.getElementById('roi_value').value)||0;
  const rent=parseFloat(document.getElementById('roi_rent').value)||0;
  const expenses=parseFloat(document.getElementById('roi_expenses').value)||0;
  const mortgage=parseFloat(document.getElementById('roi_mortgage').value)||0;
  const vacancy=parseFloat(document.getElementById('roi_vacancy').value)||0;
  const tax=parseFloat(document.getElementById('roi_tax').value)||0;
  const insurance=parseFloat(document.getElementById('roi_insurance').value)||0;
  const effRent=rent*(1-vacancy/100);
  const annualGross=effRent*12;
  const annualExp=expenses*12+tax+insurance;
  const noi=annualGross-annualExp;
  const annualCF=noi-(mortgage*12);
  const coc=purchase>0?(annualCF/purchase*100).toFixed(2)+'%':'—';
  const capRate=value>0?(noi/value*100).toFixed(2)+'%':'—';
  const gry=value>0?((annualGross/value)*100).toFixed(2)+'%':'—';
  const apprc=purchase>0?((value-purchase)/purchase*100).toFixed(2)+'%':'—';
  const roi=purchase>0?(((value-purchase)+annualCF)/purchase*100).toFixed(2)+'%':'—';
  const fmt=v=>v>0?'$'+Math.round(v).toLocaleString():'$0';
  document.getElementById('roi_eff_rent').textContent='$'+effRent.toFixed(0)+'/mo';
  document.getElementById('roi_gross').textContent=fmt(annualGross);
  document.getElementById('roi_annual_exp').textContent=fmt(annualExp);
  document.getElementById('roi_noi').textContent=fmt(noi);
  document.getElementById('roi_cf').innerHTML=`<span style="color:${annualCF>=0?'var(--success)':'var(--danger)'}">${fmt(annualCF)}</span>`;
  document.getElementById('roi_coc').textContent=coc;
  document.getElementById('roi_caprate').textContent=capRate;
  document.getElementById('roi_gryrld').textContent=gry;
  document.getElementById('roi_apprc').textContent=apprc;
  document.getElementById('roi_total').innerHTML=`<span style="color:var(--success)">${roi}</span>`;
}

// ═══════════════════════════════════════════════
//  NOTES LOG
// ═══════════════════════════════════════════════
function updateNoteSelectors(){
  const opts=['<option value="">Select property/unit…</option>',
    ...homesPortalRows.map(r=>`<option value="${r.address}">${r.address}</option>`),
    ...apartmentPortalRows.map(r=>`<option value="${r.unit}">${r.unit} — ${r.address}</option>`),
    ...tenantsRows.map(r=>`<option value="${r.first} ${r.last}">${r.first} ${r.last} (${r.unit||'tenant'})</option>`),
  ].join('');
  ['noteProperty','notesPropertyFilter'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      const prev=el.value;
      if(id==='notesPropertyFilter') el.innerHTML='<option value="all">All Properties</option>'+opts.replace('<option value="">Select property/unit…</option>','');
      else el.innerHTML=opts;
      el.value=prev;
    }
  });
}
function addNote(){
  const text=document.getElementById('noteText').value.trim();
  if(!text)return showToast('Enter a note first.','error');
  const prop=document.getElementById('noteProperty').value;
  notesRows.unshift({id:nextId.note++,text,property:prop,time:new Date().toISOString()});
  document.getElementById('noteText').value='';
  renderNotes();
  showToast('Note added.');
}
function renderNotes(){
  const filter=(document.getElementById('notesPropertyFilter')?.value)||'all';
  let rows=notesRows.filter(n=>filter==='all'||n.property===filter);
  document.getElementById('notesList').innerHTML=rows.length?rows.map(n=>`
    <div class="note-entry">
      <div class="note-header">
        <span class="note-author">${n.property||'General Portfolio'}</span>
        <span class="note-time">${new Date(n.time).toLocaleString()}</span>
      </div>
      <div class="note-text">${n.text}</div>
    </div>`).join(''):'<div class="empty-state">No notes yet. Write the first one above.</div>';
}

// ═══════════════════════════════════════════════
//  VACANCY PIPELINE
// ═══════════════════════════════════════════════
function renderVacancyView(){
  const VSTAGES=['vacant','marketing','showing','application','approved'];
  const today=new Date();
  document.getElementById('vac_vacant').textContent=vacancyRows.filter(v=>v.stage==='vacant').length||unitsData.filter(u=>u.status==='vacant').length||'—';
  document.getElementById('vac_listed').textContent=vacancyRows.filter(v=>v.stage==='marketing').length||'—';
  document.getElementById('vac_apps').textContent=vacancyRows.reduce((s,v)=>s+(v.apps||0),0)||'—';
  const doms=vacancyRows.map(v=>{if(!v.since)return 0;return Math.round((today-new Date(v.since))/(1000*60*60*24));});
  document.getElementById('vac_dom').textContent=doms.length?Math.round(doms.reduce((a,b)=>a+b,0)/doms.length)+'d':'—';

  const maxS=vacancyRows.length||1;
  document.getElementById('vacancyFunnel').innerHTML=VSTAGES.map((s,i)=>{
    const cnt=vacancyRows.filter(v=>v.stage===s).length;
    const colors=['var(--primary)','#2d5e38','#4a8a5b','var(--accent)','var(--success)'];
    const pct=Math.round(cnt/maxS*100);
    return`<div class="funnel-stage">
      <div class="funnel-label" style="text-transform:capitalize">${s}</div>
      <div class="funnel-bar-wrap">
        <div class="funnel-bar" style="width:${pct||8}%;background:${colors[i]};min-width:40px;"><span>${cnt}</span></div>
      </div>
      <div class="funnel-count">${pct}%</div>
    </div>`;
  }).join('');

  document.getElementById('vacancyTableBody').innerHTML=vacancyRows.length?vacancyRows.map(r=>{
    const days=r.since?Math.round((today-new Date(r.since))/(1000*60*60*24)):0;
    return`<tr>
    <td><strong>${r.unit}</strong></td>
    <td>${r.since||'—'}</td>
    <td><strong>${days}</strong> days</td>
    <td>${statusBadge(r.stage)}</td>
    <td>${r.rent?'$'+Number(r.rent).toLocaleString()+'/mo':'—'}</td>
    <td>${r.showings||0}</td>
    <td>${r.apps||0}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editVacancyRow(${r.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="delVacancyRow(${r.id})">Del</button>
    </td></tr>`;
  }).join(''):`<tr><td colspan="8"><div class="empty-state">No vacancy records yet.</div></td></tr>`;
}
function openVacancyModal(id=null){
  const e=id?vacancyRows.find(r=>r.id===id):null;
  document.getElementById('vacUnit').value=e?.unit||'';
  document.getElementById('vacSince').value=e?.since||new Date().toISOString().split('T')[0];
  document.getElementById('vacRent').value=e?.rent||'';
  document.getElementById('vacStage').value=e?.stage||'vacant';
  document.getElementById('vacShowings').value=e?.showings||0;
  document.getElementById('vacApps').value=e?.apps||0;
  document.getElementById('vacancyModal').dataset.editId=id||'';
  openModal('vacancyModal');
}
function submitVacancyForm(){
  const unit=document.getElementById('vacUnit').value.trim();
  if(!unit)return showToast('Unit required.','error');
  const eid=parseInt(document.getElementById('vacancyModal').dataset.editId);
  const d={unit,since:document.getElementById('vacSince').value,rent:Number(document.getElementById('vacRent').value)||0,
    stage:document.getElementById('vacStage').value,showings:Number(document.getElementById('vacShowings').value)||0,
    apps:Number(document.getElementById('vacApps').value)||0};
  if(eid){Object.assign(vacancyRows.find(x=>x.id===eid)||{},d);}
  else vacancyRows.push({id:nextId.vac++,...d});
  closeModal('vacancyModal'); renderVacancyView(); showToast('Vacancy record saved.');
}
function editVacancyRow(id){openVacancyModal(id);}
function delVacancyRow(id){openConfirm('Delete','Remove this vacancy record?',()=>{const i=vacancyRows.findIndex(r=>r.id===id);if(i>-1)vacancyRows.splice(i,1);renderVacancyView();showToast('Deleted.');})}

// ═══════════════════════════════════════════════
//  DETAIL VIEW
// ═══════════════════════════════════════════════
function viewDetail(type,id){
  let r,rows=[];
  if(type==='home'){r=homesPortalRows.find(x=>x.id===id);rows=[['Status',statusBadge(r?.status||'')],['Lease',r?.lease],['Rent',r?.rent?'$'+Number(r.rent).toLocaleString()+'/mo':'—'],['Lease Period',r?.leaseStart&&r?.leaseEnd?r.leaseStart+' → '+r.leaseEnd:'—'],['Tenant',r?.tenant||'—'],['Phone',r?.tenantPhone||'—'],['Maintenance',r?.maintenance||'—'],['Notice',r?.notice||'—']];}
  else if(type==='lead'){r=leadsPortalRows.find(x=>x.id===id);rows=[['Email',r?.email?`<a href="mailto:${r.email}">${r.email}</a>`:'—'],['Phone',r?.phone||'—'],['Stage',statusBadge(r?.stage||'')],['Timeline',timelineBadge(r?.timeline||'later')],['Source',r?.source||'—'],['Preferences',r?.preferences||'—'],['Follow-up',r?.followup||'—']];}
  if(!r)return;
  document.getElementById('detailTitle').textContent=r.address||r.name||'Detail';
  document.getElementById('detailBody').innerHTML=`<table style="width:100%;border-collapse:collapse;">${rows.map(([k,v])=>`<tr><td style="padding:10px 0;font-size:.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);width:38%;border-bottom:1px solid var(--border);">${k}</td><td style="padding:10px 0;font-size:.82rem;border-bottom:1px solid var(--border);">${v}</td></tr>`).join('')}</table>`;
  openModal('detailOverlay');
}

// ═══════════════════════════════════════════════
//  REGISTRATIONS
// ═══════════════════════════════════════════════
async function fetchLeads(){
  const loader=document.getElementById('loader'),tc=document.getElementById('tableContainer');
  loader.style.display='block';loader.innerHTML='<span class="spinner"></span> Fetching registrations…';tc.style.display='none';
  try{
    const r=await fetch('/api/admin/registrations');
    if(!r.ok)throw new Error();
    currentLeads=await r.json();
    renderLeads(currentLeads);
    loader.style.display='none';tc.style.display='block';
  }catch{loader.innerHTML='Unable to load registrations — check server connection.';}
  updateStats();
}
let filteredLeads=[];
function renderLeads(data){
  const head=document.getElementById('tableHead'),body=document.getElementById('tableBody');
  if(!data.length){body.innerHTML='<tr><td colspan="100%"><div class="empty-state">No registrations found.</div></td></tr>';return;}
  const keys=['timestamp','First Name','Last Name','Email Address'];
  data.forEach(l=>Object.keys(l).forEach(k=>{if(!keys.includes(k)&&k!=='timestamp')keys.push(k);}));
  head.innerHTML=keys.map(k=>`<th>${k.replace(/Address/g,'').replace(/[*?]/g,'').trim()}</th>`).join('');
  body.innerHTML=[...data].reverse().map(l=>`<tr>${keys.map(k=>{
    let v=l[k]||'—';
    if(k==='timestamp'){const d=new Date(v);v=`<span class="timestamp">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;}
    return`<td>${v}</td>`;}).join('')}</tr>`).join('');
}
function filterRegistrations(){
  const q=document.getElementById('regSearch').value.toLowerCase();
  filteredLeads=currentLeads.filter(l=>JSON.stringify(l).toLowerCase().includes(q));
  renderLeads(filteredLeads.length||q?filteredLeads:currentLeads);
}
function exportCSV(){
  const data=filteredLeads.length?filteredLeads:currentLeads;
  if(!data.length)return showToast('No data to export.','error');
  const k=Object.keys(data[0]);
  const csv=[k.join(','),...data.map(r=>k.map(k=>`"${r[k]||''}"`).join(','))].join('\n');
  const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);
  const a=document.createElement('a');a.href=u;a.download=`registrations_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(u);
  showToast('Exported.');
}

// ═══════════════════════════════════════════════
//  PROPERTIES
// ═══════════════════════════════════════════════
async function fetchProperties(){
  const loader=document.getElementById('propertiesLoader'),t=document.getElementById('propertiesTableContainer');
  loader.style.display='block';loader.innerHTML='<span class="spinner"></span> Loading properties…';t.style.display='none';
  try{
    const r=await fetch('/api/properties');
    if(!r.ok)throw new Error();
    propertiesData=await r.json();
    renderProperties(propertiesData);
    loader.style.display='none';t.style.display='block';
  }catch{loader.innerHTML='Failed to load properties.';}
  updateStats();
}
function renderProperties(props){
  document.getElementById('propertiesTableBody').innerHTML=props.length?props.map(p=>`<tr>
    <td><strong>${p.address}</strong></td>
    <td><span class="badge badge-gray">${p.property_type||'—'}</span></td>
    <td>${p.bedrooms} bd / ${p.bathrooms} ba</td>
    <td>${Number(p.sqft).toLocaleString()} sqft</td>
    <td><strong>$${Number(p.current_value).toLocaleString()}</strong></td>
    <td>${p.estimated_rent?'$'+Number(p.estimated_rent).toLocaleString()+'/mo':'—'}</td>
    <td>${p.year_built}</td>
    <td style="white-space:nowrap;">
      <button class="btn btn-sm" onclick="editProperty(${p.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteProperty(${p.id})">Del</button>
      <a href="property-detail.html?id=${p.id}" class="btn btn-sm">View</a>
    </td></tr>`).join(''):`<tr><td colspan="8"><div class="empty-state">No properties. Click "Add Property".</div></td></tr>`;
}
function filterProperties(){
  const q=(document.getElementById('propertiesSearch')?.value||'').toLowerCase();
  const tf=(document.getElementById('propTypeFilter')?.value)||'all';
  renderProperties(propertiesData.filter(p=>(tf==='all'||p.property_type===tf)&&(!q||JSON.stringify(p).toLowerCase().includes(q))));
}
function openPropertyModal(id=null){
  document.getElementById('propertyForm')?.reset();
  document.getElementById('propertyId').value='';
  document.getElementById('propertyModalTitle').textContent='Add New Property';
  if(id){
    const p=propertiesData.find(x=>x.id===id);
    if(p){
      document.getElementById('propertyModalTitle').textContent='Edit Property';
      document.getElementById('propertyId').value=p.id;
      ['address','sqft','bedrooms','yearBuilt'].forEach(k=>document.getElementById(k).value=p[k.replace(/([A-Z])/g,'_$1').toLowerCase()]||p[k]||'');
      document.getElementById('currentValue').value=p.current_value;
      document.getElementById('estimatedRent').value=p.estimated_rent||'';
      document.getElementById('bathrooms').value=p.bathrooms;
      document.getElementById('lotSize').value=p.lot_size||'';
      document.getElementById('propertyType').value=p.property_type;
      document.getElementById('yearBuilt').value=p.year_built;
      document.getElementById('projectSlug').value=p.project_slug;
      document.getElementById('purchasePrice').value=p.purchase_price||'';
      document.getElementById('lastSoldAt').value=p.last_sold_at||'';
    }
  }
  openModal('propertyModal');
}
function editProperty(id){openPropertyModal(id);}
async function deleteProperty(id){
  openConfirm('Delete Property','Permanently delete this property?',async()=>{
    try{const r=await fetch(`/api/properties/${id}`,{method:'DELETE'});if(!r.ok)throw new Error();await fetchProperties();showToast('Property deleted.');}
    catch{showToast('Failed to delete.','error');}
  });
}
async function submitPropertyForm(){
  const pid=document.getElementById('propertyId').value;
  const payload={
    address:document.getElementById('address').value,
    current_value:parseInt(document.getElementById('currentValue').value),
    estimated_rent:parseInt(document.getElementById('estimatedRent').value)||0,
    sqft:parseInt(document.getElementById('sqft').value),
    bedrooms:parseInt(document.getElementById('bedrooms').value),
    bathrooms:parseFloat(document.getElementById('bathrooms').value),
    lot_size:parseInt(document.getElementById('lotSize').value)||0,
    property_type:document.getElementById('propertyType').value,
    year_built:parseInt(document.getElementById('yearBuilt').value),
    project_slug:document.getElementById('projectSlug').value,
    purchase_price:parseInt(document.getElementById('purchasePrice').value)||null,
    last_sold_at:document.getElementById('lastSoldAt').value||null
  };
  try{
    const r=await fetch(pid?`/api/properties/${pid}`:'/api/properties',{method:pid?'PATCH':'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok)throw new Error();
    closeModal('propertyModal');await fetchProperties();showToast(pid?'Property updated.':'Property saved.');
  }catch{showToast('Failed to save property.','error');}
}

// ═══════════════════════════════════════════════
//  UNITS
// ═══════════════════════════════════════════════
async function fetchUnits(){
  const loader=document.getElementById('unitsLoader'),t=document.getElementById('unitsTableContainer');
  loader.style.display='block';loader.innerHTML='<span class="spinner"></span> Loading units…';t.style.display='none';
  try{
    const r=await fetch('/api/units');
    if(!r.ok)throw new Error();
    unitsData=await r.json();
    renderUnits(unitsData);
    loader.style.display='none';t.style.display='block';
  }catch{loader.innerHTML='Failed to load units.';}
  updateStats();
}
function renderUnits(units){
  document.getElementById('unitsTableBody').innerHTML=units.length?units.map(u=>`<tr>
    <td><strong>${u.unit}</strong></td>
    <td>${statusBadge(u.status)}</td>
    <td>$${Number(u.value).toLocaleString()}</td>
    <td>$${Number(u.rent).toLocaleString()}/mo</td>
    <td>${u.last_sold_at||'—'}</td>
    <td>
      <form class="inline-edit" data-id="${u.id}" onsubmit="saveUnit(event,this)">
        <select name="status">${['occupied','vacant','listed'].map(s=>`<option value="${s}"${u.status===s?' selected':''}>${s}</option>`).join('')}</select>
        <input name="value" type="number" min="1" value="${u.value}" required style="width:90px">
        <input name="rent" type="number" min="0" value="${u.rent}" required style="width:80px">
        <button class="btn btn-primary btn-sm" type="submit">Save</button>
      </form>
    </td></tr>`).join(''):`<tr><td colspan="6"><div class="empty-state">No units found.</div></td></tr>`;
}
async function saveUnit(event,form){
  event.preventDefault();
  const id=form.dataset.id,payload={status:form.status.value,value:Number(form.value.value),rent:Number(form.rent.value)};
  try{
    const r=await fetch(`/api/units/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok)throw new Error();await fetchUnits();showToast('Unit updated.');
  }catch{showToast('Failed to update unit.','error');}
}

// ═══════════════════════════════════════════════
//  GLOBAL REFRESH
// ═══════════════════════════════════════════════
function refreshAll(){fetchLeads();fetchProperties();fetchUnits();showToast('Refreshing all data…');}

// ═══════════════════════════════════════════════
//  KEYBOARD / OVERLAY EVENTS
// ═══════════════════════════════════════════════
document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);});});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.active,.confirm-overlay.active').forEach(el=>el.classList.remove('active'));});

// ═══════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════
renderAdminPortal();
renderHomesPortal();
renderApartmentsPortal();
renderLeadsPortal();
renderOperationsPortal();
renderTenants();
renderNotes();
calcROI();
updateStats();
fetchLeads();
fetchProperties();
fetchUnits();
</script>
</body>
</html>
