<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Taiseel Development</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3c22;
            --accent: #c5a059;
            --bg: #fcfcfc;
            --white: #ffffff;
            --text: #333;
            --muted: #999;
            --border: #eeeeee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 1300px; margin: 0 auto; padding: 60px 5%; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 60px; }

        .brand h1 { font-weight: 300; letter-spacing: 5px; text-transform: uppercase; font-size: 1.2rem; color: var(--primary); }

        .actions { display: flex; gap: 20px; }

        .btn {
            padding: 12px 24px;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover { border-color: var(--primary); color: var(--primary); }

        .btn-primary { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .btn-primary:hover { background: #15311b; color: var(--white); }

        .btn-secondary { background: var(--accent); color: var(--white); border-color: var(--accent); }
        .btn-secondary:hover { background: #b08f4a; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; margin-bottom: 60px; }

        .stat-card { background: var(--white); padding: 40px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.02); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }

        .stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; display: block; }

        .stat-value { font-size: 2.5rem; font-weight: 300; color: var(--primary); }

        .section { background: var(--white); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.02); margin-bottom: 40px; }

        .table-header { padding: 30px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        .table-header h2 { font-size: 1rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }

        .table-wrapper { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; text-align: left; }

        th { background: #f9f9f9; padding: 20px 40px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); border-bottom: 1px solid var(--border); }

        td { padding: 20px 40px; font-size: 0.9rem; border-bottom: 1px solid var(--border); color: #555; }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fafafa; }

        .timestamp { font-size: 0.75rem; color: var(--muted); }

        #loader, #propertiesLoader, #unitsLoader { padding: 60px; text-align: center; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem; }

        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; background: #e9f5ed; color: #2e7d32; }

        .units-controls, .properties-controls { display: flex; align-items: center; gap: 10px; }
        .edit-form { display: flex; gap: 8px; align-items: center; }
        .edit-form input, .edit-form select { border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font: inherit; font-size: 0.8rem; }
        .edit-form button { padding: 8px 12px; font-size: 0.7rem; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal.active { display: block; }
        .modal-content { background-color: var(--white); margin: 5% auto; padding: 40px; border-radius: 20px; width: 90%; max-width: 800px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
        .close { color: var(--muted); font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: var(--text); }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { border: 1px solid var(--border); border-radius: 8px; padding: 12px; font: inherit; font-size: 0.9rem; }
        .form-group textarea { min-height: 100px; resize: vertical; }

        .action-btn { padding: 8px 16px; font-size: 0.75rem; }

        @media (max-width: 900px) {
            .container { padding: 40px 5%; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="brand"><h1>Taiseel Management</h1></div>
            <div class="actions">
                <a href="index.html" class="btn">View Site</a>
                <button onclick="fetchLeads()" class="btn btn-primary">Refresh Data</button>
            </div>
        </header>

        <main>
            <section class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">Total Leads</span>
                    <div class="stat-value" id="totalLeads">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Properties</span>
                    <div class="stat-value" id="totalProperties">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Units</span>
                    <div class="stat-value" id="totalUnits">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Portfolio Value</span>
                    <div class="stat-value" id="portfolioValue">-</div>
                </div>
            </section>

            <!-- PROPERTIES SECTION -->
            <section class="section">
                <div class="table-header">
                    <h2>Residential Properties</h2>
                    <div class="properties-controls">
                        <button onclick="openPropertyModal()" class="btn btn-secondary action-btn">Add Property</button>
                        <button onclick="fetchProperties()" class="btn action-btn">Refresh</button>
                    </div>
                </div>
                <div id="propertiesLoader">Loading properties...</div>
                <div class="table-wrapper" id="propertiesTableContainer" style="display:none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>Beds/Baths</th>
                                <th>Sqft</th>
                                <th>Current Value</th>
                                <th>Est. Rent</th>
                                <th>Year Built</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- UNITS SECTION -->
            <section class="section">
                <div class="table-header">
                    <h2>Building Units</h2>
                    <div class="units-controls">
                        <a href="palm-central-private-residences.html#valuation" class="btn action-btn">Open Listing</a>
                        <button onclick="fetchUnits()" class="btn action-btn">Refresh</button>
                    </div>
                </div>
                <div id="unitsLoader">Loading units...</div>
                <div class="table-wrapper" id="unitsTableContainer" style="display:none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Unit</th><th>Status</th><th>Value</th><th>Rent</th><th>Last Sold</th><th>Update</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- REGISTRATIONS SECTION -->
            <section class="section">
                <div class="table-header">
                    <h2>Registrations</h2>
                    <button onclick="exportCSV()" class="btn action-btn">Export CSV</button>
                </div>
                <div id="loader">Fetching latest registrations...</div>
                <div class="table-wrapper" id="tableContainer" style="display:none;">
                    <table>
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- Property Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Property</h2>
                <span class="close" onclick="closePropertyModal()">&times;</span>
            </div>
            <form id="propertyForm">
                <input type="hidden" id="propertyId">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Address *</label>
                        <input type="text" id="address" required>
                    </div>
                    <div class="form-group">
                        <label>Current Value ($) *</label>
                        <input type="number" id="currentValue" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Estimated Rent ($/mo)</label>
                        <input type="number" id="estimatedRent" min="0">
                    </div>
                    <div class="form-group">
                        <label>Square Feet *</label>
                        <input type="number" id="sqft" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Bedrooms *</label>
                        <input type="number" id="bedrooms" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Bathrooms *</label>
                        <input type="number" id="bathrooms" min="0" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>Lot Size (sqft)</label>
                        <input type="number" id="lotSize" min="0">
                    </div>
                    <div class="form-group">
                        <label>Property Type *</label>
                        <select id="propertyType" required>
                            <option value="">Select Type</option>
                            <option value="Single Family">Single Family</option>
                            <option value="Condo">Condo</option>
                            <option value="Townhouse">Townhouse</option>
                            <option value="Multi-Family">Multi-Family</option>
                            <option value="Land">Land</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year Built *</label>
                        <input type="number" id="yearBuilt" min="1800" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label>Project Slug *</label>
                        <select id="projectSlug" required>
                            <option value="">Select Project</option>
                            <option value="palm-central-private-residences">Palm Central</option>
                            <option value="the-heights-residences">The Heights</option>
                            <option value="brilliant-tower">Brilliant Tower</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Purchase Price ($)</label>
                        <input type="number" id="purchasePrice" min="0">
                    </div>
                    <div class="form-group">
                        <label>Last Sold Date</label>
                        <input type="date" id="lastSoldAt">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closePropertyModal()" class="btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentLeads = [];
        let propertiesData = [];
        let unitsData = [];        
        let hasError = false;

        // ==================== LEADS ====================
        async function fetchLeads() {
            const loader = document.getElementById('loader');
            const tableContainer = document.getElementById('tableContainer');

            loader.style.display = 'block';
            loader.innerText = 'Fetching latest registrations...';
            tableContainer.style.display = 'none';
            hasError = false;

            try {
                const response = await fetch('/api/admin/registrations');
                if (!response.ok) throw new Error(`Request failed with status ${response.status}`);

                const data = await response.json();
                currentLeads = data;
                renderLeads(data);
                updateStats();

                loader.style.display = 'none';
                tableContainer.style.display = 'block';

            } catch (err) {
                console.error('Fetch error:', err);
                loader.innerText = 'Error loading data. Verify server connection.';
                hasError = true;
            }
        }

        function renderLeads(data) {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');

            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="100%" style="text-align:center; padding:60px;">No registrations found yet.</td></tr>';
                return;
            }

            const keys = ['timestamp', 'First Name', 'Last Name', 'Email Address'];
            data.forEach(lead => {
                Object.keys(lead).forEach(k => { if (!keys.includes(k) && k !== 'timestamp') keys.push(k); });
            });

            head.innerHTML = keys.map(k => `<th>${k.replace(/Address/g,'').replace(/[*?]/g,'')}</th>`).join('');

            body.innerHTML = [...data].reverse().map(lead => `<tr>${
                keys.map(k => {
                    let val = lead[k] || '-';
                    if (k === 'timestamp') {
                        const d = new Date(val);
                        val = `<span class="timestamp">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
                    }
                    return `<td>${val}</td>`;
                }).join('')
            }</tr>`).join('');
        }

        function exportCSV() {
            if (currentLeads.length === 0) return alert('No data to export');
            const keys = Object.keys(currentLeads[0]);
            const csv = [
                keys.join(','),
                ...currentLeads.map(row => keys.map(k => `"${row[k] || ''}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leads_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== PROPERTIES ====================
        async function fetchProperties() {
            const loader = document.getElementById('propertiesLoader');
            const table = document.getElementById('propertiesTableContainer');
            loader.style.display = 'block';
            loader.textContent = 'Loading properties...';
            table.style.display = 'none';

            try {
                const response = await fetch('/api/properties');
                if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
                propertiesData = await response.json();
                renderProperties(propertiesData);
                loader.style.display = 'none';
                table.style.display = 'block';
                updateStats();
            } catch (error) {
                console.error('Properties fetch error:', error);
                loader.textContent = 'Failed to load properties.';
            }
        }

        function renderProperties(properties) {
            const body = document.getElementById('propertiesTableBody');
            body.innerHTML = properties.map((prop) => `
                <tr>
                    <td><strong>${prop.address}</strong></td>
                    <td>${prop.bedrooms} bd / ${prop.bathrooms} ba</td>
                    <td>${Number(prop.sqft).toLocaleString()} sqft</td>
                    <td>$${Number(prop.current_value).toLocaleString()}</td>
                    <td>${prop.estimated_rent ? '$' + Number(prop.estimated_rent).toLocaleString() : '-'}</td>
                    <td>${prop.year_built}</td>
                    <td>
                        <button class="btn action-btn" onclick="editProperty(${prop.id})">Edit</button>
                        <button class="btn action-btn" onclick="deleteProperty(${prop.id})">Delete</button>
                        <a href="property-detail.html?id=${prop.id}" class="btn action-btn">View</a>
                    </td>
                </tr>
            `).join('');
        }

        function openPropertyModal(propertyId = null) {
            const modal = document.getElementById('propertyModal');
            const form = document.getElementById('propertyForm');
            const title = document.getElementById('modalTitle');
            
            form.reset();
            document.getElementById('propertyId').value = '';
            title.textContent = 'Add New Property';
            
            if (propertyId) {
                const property = propertiesData.find(p => p.id === propertyId);
                if (property) {
                    title.textContent = 'Edit Property';
                    document.getElementById('propertyId').value = property.id;
                    document.getElementById('address').value = property.address;
                    document.getElementById('currentValue').value = property.current_value;
                    document.getElementById('estimatedRent').value = property.estimated_rent || '';
                    document.getElementById('sqft').value = property.sqft;
                    document.getElementById('bedrooms').value = property.bedrooms;
                    document.getElementById('bathrooms').value = property.bathrooms;
                    document.getElementById('lotSize').value = property.lot_size || '';
                    document.getElementById('propertyType').value = property.property_type;
                    document.getElementById('yearBuilt').value = property.year_built;
                    document.getElementById('projectSlug').value = property.project_slug;
                    document.getElementById('purchasePrice').value = property.purchase_price || '';
                    document.getElementById('lastSoldAt').value = property.last_sold_at || '';
                }
            }
            
            modal.classList.add('active');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        function editProperty(id) {
            openPropertyModal(id);
        }

        async function deleteProperty(id) {
            if (!confirm('Are you sure you want to delete this property?')) return;

            try {
                const response = await fetch(`/api/properties/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error(`Delete failed (${response.status})`);
                await fetchProperties();
            } catch (error) {
                console.error('Failed to delete property:', error);
                alert('Failed to delete property.');
            }
        }

        document.getElementById('propertyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const propertyId = document.getElementById('propertyId').value;
            const payload = {
                address: document.getElementById('address').value,
                current_value: parseInt(document.getElementById('currentValue').value),
                estimated_rent: parseInt(document.getElementById('estimatedRent').value) || 0,
                sqft: parseInt(document.getElementById('sqft').value),
                bedrooms: parseInt(document.getElementById('bedrooms').value),
                bathrooms: parseFloat(document.getElementById('bathrooms').value),
                lot_size: parseInt(document.getElementById('lotSize').value) || 0,
                property_type: document.getElementById('propertyType').value,
                year_built: parseInt(document.getElementById('yearBuilt').value),
                project_slug: document.getElementById('projectSlug').value,
                purchase_price: parseInt(document.getElementById('purchasePrice').value) || null,
                last_sold_at: document.getElementById('lastSoldAt').value || null
            };

            try {
                const url = propertyId ? `/api/properties/${propertyId}` : '/api/properties';
                const method = propertyId ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Save failed (${response.status})`);

                closePropertyModal();
                await fetchProperties();
            } catch (error) {
                console.error('Failed to save property:', error);
                alert('Failed to save property.');
            }
        });

        // ==================== UNITS ====================
        async function fetchUnits() {
            const loader = document.getElementById('unitsLoader');
            const table = document.getElementById('unitsTableContainer');
            loader.style.display = 'block';
            loader.textContent = 'Loading units...';
            table.style.display = 'none';

            try {
                const response = await fetch('/api/units');
                if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
                unitsData = await response.json();
                renderUnits(unitsData);
                loader.style.display = 'none';
                table.style.display = 'block';
                updateStats();
            } catch (error) {
                console.error('Units fetch error:', error);
                loader.textContent = 'Failed to load units.';
            }
        }

        function renderUnits(units) {
            const body = document.getElementById('unitsTableBody');
            body.innerHTML = units.map((unit) => `
                <tr>
                    <td><strong>${unit.unit}</strong></td>
                    <td>${unit.status}</td>
                    <td>$${Number(unit.value).toLocaleString()}</td>
                    <td>$${Number(unit.rent).toLocaleString()}</td>
                    <td>${unit.last_sold_at || '-'}</td>
                    <td>
                        <form class="edit-form" data-id="${unit.id}">
                            <select name="status">
                                <option value="occupied" ${unit.status === 'occupied' ? 'selected' : ''}>occupied</option>
                                <option value="vacant" ${unit.status === 'vacant' ? 'selected' : ''}>vacant</option>
                                <option value="listed" ${unit.status === 'listed' ? 'selected' : ''}>listed</option>
                            </select>
                            <input name="value" type="number" min="1" value="${unit.value}" required>
                            <input name="rent" type="number" min="0" value="${unit.rent}" required>
                            <button class="btn btn-primary" type="submit">Save</button>
                        </form>
                    </td>
                </tr>
            `).join('');

            body.querySelectorAll('.edit-form').forEach((form) => {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const id = form.dataset.id;
                    const payload = {
                        status: form.status.value,
                        value: Number(form.value.value),
                        rent: Number(form.rent.value)
                    };

                    try {
                        const response = await fetch(`/api/units/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`Update failed (${response.status})`);

                        await fetchUnits();
                    } catch (error) {
                        console.error('Failed to update unit:', error);
                        alert('Failed to save unit changes.');
                    }
                });
            });
        }

        // ==================== STATS ====================
        function updateStats() {
            document.getElementById('totalLeads').innerText = currentLeads.length;
            document.getElementById('totalProperties').innerText = propertiesData.length;
            document.getElementById('totalUnits').innerText = unitsData.length;

            const propertyValue = propertiesData.reduce((sum, p) => sum + (p.current_value || 0), 0);
            const unitValue = unitsData.reduce((sum, u) => sum + (u.value || 0), 0);
            const totalValue = propertyValue + unitValue;

            document.getElementById('portfolioValue').innerText = totalValue > 0 
                ? '$' + (totalValue / 1000000).toFixed(1) + 'M'
                : '-';
        }

        // ==================== INIT ====================
        fetchLeads();
        fetchProperties();
        fetchUnits();
    </script>
</body>

</html>
